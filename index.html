<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala do Centro de Saúde</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text */
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .header {
            background-color: #4a90e2; /* Blue header */
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary {
            background-color: #4a90e2;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #357ABD;
        }
        .btn-secondary {
            background-color: #64748b; /* Gray */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .input-field {
            border: 1px solid #cbd5e1; /* Light gray border */
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 900px; /* Increased max-width to accommodate new section */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }
        .schedule-table-container {
            overflow-x: auto;
            margin-top: 2rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure table doesn't get too small on narrow screens */
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #e2e8f0; /* Light gray table borders */
            padding: 0.5rem;
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping in cells */
            font-size: 0.8rem; /* Smaller font for general view */
        }
        .schedule-table th {
            background-color: #e2e8f0; /* Light gray header */
            font-weight: 600;
        }
        .schedule-table tbody tr:hover {
            background-color: #f8fafc; /* Lighter on hover */
        }
        .weekend, .holiday {
            background-color: #cbd5e1; /* Darker gray for weekends/holidays */
            color: #475569;
        }
        .vacation {
            background-color: #93c5fd; /* Light blue for vacations */
            color: #1e40af;
            font-weight: 600;
        }
        .printable-table {
            width: 100%;
            border-collapse: collapse;
        }
        .printable-table th, .printable-table td {
            border: 1px solid #000;
            padding: 4px;
            text-align: center;
            font-size: 8px; /* Even smaller font for print */
        }
        .printable-table .weekend, .printable-table .holiday {
            background-color: #ccc;
        }
        .printable-table .vacation {
            background-color: #a7d9ff;
        }
        .printable-legend {
            font-size: 10px;
            margin-top: 20px;
            border-top: 1px solid #000;
            padding-top: 10px;
        }

        /* Team Colors */
        .team-sol { color: #f59e0b; } /* Amber */
        .team-verde { color: #10b981; } /* Emerald */
        .team-vermelha { color: #ef4444; } /* Red */
        .team-azul { color: #3b82f6; } /* Blue */
        .team-laranja { color: #fb923c; } /* Orange */
        .team-apoio { color: #6b7280; } /* Gray */


        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                overflow: hidden; /* Hide scrollbars */
            }
            .printable-header {
                text-align: center;
                margin-bottom: 10px;
                font-size: 14px;
            }
            .printable-table-container {
                width: 100%;
                overflow: visible; /* Allow table to expand */
            }
            .printable-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed; /* Fix table layout */
            }
            .printable-table th, .printable-table td {
                font-size: 8px; /* Smaller font for print */
                padding: 2px;
                white-space: normal; /* Allow wrapping for print */
            }
            /* Adjust column widths for print if needed */
            .printable-table th:nth-child(1) { width: 12%; } /* Nome */
            .printable-table th:nth-child(2) { width: 8%; } /* Função */
            .printable-table th:nth-child(3) { width: 10%; } /* Conselho */
            .printable-table th:nth-child(4) { width: 8%; } /* Horário de Trabalho */
            /* Calculate remaining width for days dynamically */
            .printable-table th:nth-child(n+5) { width: calc(62% / ${getDaysInMonth(currentYear, currentMonth)}); } /* Days */

            .printable-footer {
                position: fixed;
                bottom: 20px;
                left: 0;
                width: 100%;
                text-align: center;
                font-size: 10px;
            }
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <div class="header">
            <h1 class="text-3xl font-bold mb-2">Escala do Centro de Saúde</h1>
            <p class="text-lg">Gerencie a escala da sua equipe de forma fácil e eficiente.</p>
        </div>

        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="btn-secondary px-4 py-2 rounded-lg">&lt; Mês Anterior</button>
            <h2 id="currentMonthYear" class="text-2xl font-semibold text-gray-700"></h2>
            <button id="nextMonth" class="btn-secondary px-4 py-2 rounded-lg">Próximo Mês &gt;</button>
        </div>

        <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">Gerenciamento de Funcionários</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="employeeName" placeholder="Nome do Funcionário" class="input-field">
                <select id="employeeRole" class="input-field">
                    <option value="">Selecione a Função</option>
                    <option value="Técnico Enfermagem">Técnico Enfermagem</option>
                    <option value="Enfermeiro">Enfermeiro</option>
                    <option value="Outro">Outro</option>
                </select>
                <input type="text" id="customEmployeeRole" placeholder="Função Personalizada" class="input-field hidden">
                <input type="text" id="employeeCouncil" placeholder="Registro do Conselho" class="input-field">
                <input type="text" id="employeeWorkShift" placeholder="Horário de Trabalho (Ex: 08h-17h)" class="input-field">
            </div>
            <div class="mb-4">
                <label for="employeeTeam" class="block text-sm font-medium text-gray-700 mb-1">Equipe:</label>
                <select id="employeeTeam" class="input-field">
                    <option value="">Selecione a Equipe</option>
                    <option value="Sol">Sol</option>
                    <option value="Verde">Verde</option>
                    <option value="Vermelha">Vermelha</option>
                    <option value="Azul">Azul</option>
                    <option value="Laranja">Laranja</option>
                    <option value="Apoio">Apoio</option>
                </select>
            </div>
            <button id="addEmployeeBtn" class="btn-primary w-full md:w-auto">Adicionar Funcionário</button>

            <div id="employeeList" class="mt-6">
                <h4 class="text-lg font-medium mb-3 text-gray-700">Funcionários Cadastrados:</h4>
                <ul id="employeesUl" class="space-y-2">
                    </ul>
            </div>
        </div>

        <div class="schedule-table-container">
            <table id="scheduleTable" class="schedule-table">
                <thead>
                    <tr id="scheduleHeader">
                        <th class="w-1/6">Nome</th>
                        <th class="w-1/12">Função</th>
                        <th class="w-1/12">Conselho</th>
                        <th class="w-1/12">Horário de Trabalho</th>
                        </tr>
                </thead>
                <tbody id="scheduleBody">
                    </tbody>
            </table>
        </div>

        <div class="bg-blue-50 p-6 rounded-lg shadow-md mt-8">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">Observações Mensais</h3>
            <textarea id="monthlyObservations" class="input-field h-32 resize-y" placeholder="Adicione observações importantes para este mês..."></textarea>
        </div>

        <div class="flex justify-center mt-8 space-x-4">
            <button id="printScheduleBtn" class="btn-primary">Imprimir Escala</button>
            <button id="saveScheduleBtn" class="btn-primary">Salvar Escala</button>
            <button id="manageSiglasBtn" class="btn-secondary">Gerenciar Siglas</button>
            <button id="copyScheduleBtn" class="btn-secondary">Transcrever Escala p/ Próximo Mês</button>
        </div>
    </div>

    <div id="siglaVacationModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-button" onclick="window.closeSiglaVacationModal()">&times;</button>
            <h3 id="modalEmployeeName" class="text-2xl font-bold mb-4 text-blue-700"></h3>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> <div id="siglaSectionMonth" class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar Sigla(s) para o Mês</h4>
                    <div class="mb-4 space-y-2" id="siglaCheckboxesMonth">
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="F" class="mr-2"> F (Farmácia)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="S" class="mr-2"> S (Sala de Observação)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="P" class="mr-2"> P (Presente)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="CT" class="mr-2"> CT (Curativo)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="BR" class="mr-2"> BR (Acolhimento Baixo Risco)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="E" class="mr-2"> E (ECG)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="V" class="mr-2"> V (Vacina)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="T" class="mr-2"> T (Totem)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="C" class="mr-2"> C (Consultórios)</label>
                    </div>
                    <button id="applySiglaMonthBtn" class="btn-primary w-full">Aplicar Sigla(s) para o Mês</button>
                    <button id="clearSiglasMonthBtn" class="btn-secondary w-full mt-2">Limpar Siglas do Mês</button>
                </div>

                <div id="siglaSectionDay" class="bg-gray-50 p-4 rounded-lg shadow-sm hidden">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar Sigla(s) para o Dia <span id="modalDayNumber"></span></h4>
                    <div class="mb-4 space-y-2" id="siglaCheckboxesDay">
                        <label class="flex items-center"><input type="checkbox" name="siglaDay" value="FO" class="mr-2"> FO (Folga)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaDay" value="LM" class="mr-2"> LM (Licença Médica)</label>
                        </div>
                    <button id="applySiglaDayBtn" class="btn-primary w-full">Aplicar Sigla(s) para o Dia</button>
                    <button id="clearSiglasDayBtn" class="btn-secondary w-full mt-2">Limpar Siglas do Dia</button>
                </div>

                <div id="multiDaySiglaSection" class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar LM / FO por Período</h4>
                    <div class="mb-4 space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="multiDaySiglaType" value="LM" class="form-radio text-blue-600" checked>
                            <span class="ml-2">LM (Licença Médica)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="multiDaySiglaType" value="FO" class="form-radio text-blue-600">
                            <span class="ml-2">FO (Folga)</span>
                        </label>
                    </div>
                    <div class="mb-4">
                        <label for="multiDaySiglaStart" class="block text-sm font-medium text-gray-700 mb-1">Início:</label>
                        <input type="date" id="multiDaySiglaStart" class="input-field">
                    </div>
                    <div class="mb-4">
                        <label for="multiDaySiglaEnd" class="block text-sm font-medium text-gray-700 mb-1">Fim:</label>
                        <input type="date" id="multiDaySiglaEnd" class="input-field">
                    </div>
                    <button id="applyMultiDaySiglaBtn" class="btn-primary w-full">Aplicar Período</button>
                    <button id="clearMultiDaySiglaRangeBtn" class="btn-secondary w-full mt-2">Limpar Período</button>
                </div>


                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar Férias</h4>
                    <div class="mb-4">
                        <label for="vacationStart" class="block text-sm font-medium text-gray-700 mb-1">Início das Férias:</label>
                        <input type="date" id="vacationStart" class="input-field">
                    </div>
                    <div class="mb-4">
                        <label for="vacationEnd" class="block text-sm font-medium text-gray-700 mb-1">Fim das Férias:</label>
                        <input type="date" id="vacationEnd" class="input-field">
                    </div>
                    <button id="applyVacationBtn" class="btn-primary w-full">Aplicar Férias</button>
                    <button id="clearVacationBtn" class="btn-secondary w-full mt-2">Limpar Férias</button>
                </div>
            </div>
            <button id="clearEmployeeScheduleBtn" class="btn-danger w-full mt-6">Limpar Toda a Escala do Funcionário</button>
        </div>
    </div>

    <div id="manageSiglasModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-button" onclick="window.closeManageSiglasModal()">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-blue-700">Gerenciar Siglas Personalizadas</h3>

            <div class="mb-6">
                <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar Nova Sigla</h4>
                <div class="flex space-x-2">
                    <input type="text" id="newSiglaName" placeholder="Nome da Sigla (Ex: ECG)" class="input-field flex-grow">
                    <input type="text" id="newSiglaDescription" placeholder="Descrição (Ex: Eletrocardiograma)" class="input-field flex-grow">
                    <button id="addCustomSiglaBtn" class="btn-primary">Adicionar</button>
                </div>
            </div>

            <div>
                <h4 class="text-lg font-semibold mb-3 text-gray-800">Siglas Existentes</h4>
                <ul id="customSiglasList" class="space-y-2">
                    </ul>
            </div>
        </div>
    </div>

    <div id="messageBox" class="fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg hidden z-2000">
        <p id="messageText"></p>
        <button class="ml-4 text-white font-bold" onclick="window.hideMessageBox()">&times;</button>
    </div>

    <script type="module">
        // Global variables for Firebase configuration and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        // Firebase imports - these will be available if firebaseConfig is provided by the environment
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let employees = []; // Master list of employees (without schedule/vacations)
        let monthlySchedulesData = {}; // Stores schedule & vacations per employee per month { 'YYYY-MM': { employeeId: { siglas: {}, vacations: [] } } }
        let currentEditingEmployeeId = null;
        let currentEditingDateKey = null; // New: Stores the date key if a specific day is being edited
        let monthlyObservations = {}; // Stores observations per month/year

        // Define default siglas and a place for custom ones
        const defaultSiglas = [
            { name: 'F', description: 'Farmácia' },
            { name: 'S', description: 'Sala de Observação' },
            { name: 'P', description: 'Presente' },
            { name: 'CT', description: 'Curativo' },
            { name: 'BR', description: 'Acolhimento Baixo Risco' },
            { name: 'E', description: 'ECG' },
            { name: 'V', description: 'Vacina' },
            { name: 'T', description: 'Totem' },
            { name: 'C', description: 'Consultórios' }
        ];
        // Siglas that can only be applied per day (not generally for the month) or as ranges
        const dailyOnlySiglas = ['FO', 'LM'];
        let customSiglas = []; // Array to store user-defined siglas

        // Brazilian National Holidays (example for 2025)
        const nationalHolidays = [
            '2025-01-01', // Confraternização Universal
            '2025-03-03', // Carnaval (Monday)
            '2025-03-04', // Carnaval (Tuesday)
            '2025-04-18', // Paixão de Cristo
            '2025-04-21', // Tiradentes
            '2025-05-01', // Dia do Trabalho
            '2025-06-19', // Corpus Christi
            '2025-09-07', // Independência do Brasil
            '2025-10-12', // Nossa Senhora Aparecida
            '2025-11-02', // Finados
            '2025-11-15', // Proclamação da República
            '2025-12-25'  // Natal
        ];

        // --- Utility Functions ---

        // Make functions globally accessible for inline HTML event handlers
        window.showMessageBox = function(message, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            document.getElementById('messageText').textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                window.hideMessageBox();
            }, duration);
        }

        window.hideMessageBox = function() {
            document.getElementById('messageBox').classList.add('hidden');
        }

        function saveEmployees() {
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/health_schedule_data`, 'employees_master'); // Renamed to avoid confusion
                setDoc(docRef, { data: JSON.stringify(employees) })
                    .catch(error => console.error("Erro ao salvar funcionários no Firestore:", error));
            } else {
                localStorage.setItem('healthScheduleEmployeesMaster', JSON.stringify(employees));
            }
        }

        async function loadEmployees() {
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/health_schedule_data`, 'employees_master');
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        employees = JSON.parse(docSnap.data().data);
                    } else {
                        employees = [];
                    }
                } catch (error) {
                    console.error("Erro ao carregar funcionários do Firestore:", error);
                    employees = [];
                }
            } else {
                const storedEmployees = localStorage.getItem('healthScheduleEmployeesMaster');
                employees = storedEmployees ? JSON.parse(storedEmployees) : [];
            }
            renderEmployeeList();
            // renderSchedule will be called after monthly schedules are loaded
        }

        // NEW: Save current month's schedule data
        function saveCurrentMonthSchedule() {
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/health_schedule_data`, 'monthly_schedules');
                setDoc(docRef, { data: JSON.stringify(monthlySchedulesData) })
                    .catch(error => console.error("Erro ao salvar escalas mensais no Firestore:", error));
            } else {
                localStorage.setItem('healthScheduleMonthlySchedules', JSON.stringify(monthlySchedulesData));
            }
        }

        // NEW: Load all monthly schedule data
        async function loadMonthlySchedulesData() {
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/health_schedule_data`, 'monthly_schedules');
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        monthlySchedulesData = JSON.parse(docSnap.data().data);
                    } else {
                        monthlySchedulesData = {};
                    }
                } catch (error) {
                    console.error("Erro ao carregar escalas mensais do Firestore:", error);
                    monthlySchedulesData = {};
                }
            } else {
                const storedSchedules = localStorage.getItem('healthScheduleMonthlySchedules');
                monthlySchedulesData = storedSchedules ? JSON.parse(storedSchedules) : {};
            }
            renderSchedule(); // Render schedule after monthly data is loaded
        }

        function saveMonthlyObservations() {
            const key = `${currentYear}-${currentMonth + 1}`;
            monthlyObservations[key] = document.getElementById('monthlyObservations').value;
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/health_schedule_data`, 'observations');
                setDoc(docRef, { data: JSON.stringify(monthlyObservations) })
                    .catch(error => console.error("Erro ao salvar observações no Firestore:", error));
            } else {
                localStorage.setItem('healthScheduleObservations', JSON.stringify(monthlyObservations));
            }
        }

        async function loadMonthlyObservations() {
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/health_schedule_data`, 'observations');
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        monthlyObservations = JSON.parse(docSnap.data().data);
                    } else {
                        monthlyObservations = {};
                    }
                } catch (error) {
                    console.error("Erro ao carregar observações do Firestore:", error);
                    monthlyObservations = {};
                }
            } else {
                const storedObservations = localStorage.getItem('healthScheduleObservations');
                monthlyObservations = storedObservations ? JSON.parse(storedObservations) : {};
            }
            const key = `${currentYear}-${currentMonth + 1}`;
            document.getElementById('monthlyObservations').value = monthlyObservations[key] || '';
        }

        // New function to save custom siglas
        function saveCustomSiglas() {
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/health_schedule_data`, 'customSiglas');
                setDoc(docRef, { data: JSON.stringify(customSiglas) })
                    .catch(error => console.error("Erro ao salvar siglas personalizadas no Firestore:", error));
            } else {
                localStorage.setItem('healthScheduleCustomSiglas', JSON.stringify(customSiglas));
            }
        }

        // New function to load custom siglas
        async function loadCustomSiglas() {
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/health_schedule_data`, 'customSiglas');
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        customSiglas = JSON.parse(docSnap.data().data);
                    } else {
                        customSiglas = [];
                    }
                } catch (error) {
                    console.error("Erro ao carregar siglas personalizadas do Firestore:", error);
                    customSiglas = [];
                }
            } else {
                const storedSiglas = localStorage.getItem('healthScheduleCustomSiglas');
                customSiglas = storedSiglas ? JSON.parse(storedSiglas) : [];
            }
            renderSiglaCheckboxes(); // Render checkboxes in sigla/vacation modal
            renderCustomSiglasList(); // Render list in manage siglas modal
        }

        // New function to save both employees and observations and siglas
        function saveAllData() {
            saveEmployees(); // Save active employee list
            saveCurrentMonthSchedule(); // Save current month's schedule data
            saveMonthlyObservations();
            saveCustomSiglas(); // Save custom siglas
            window.showMessageBox('Escala e dados salvos com sucesso!');
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function isWeekend(year, month, day) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6; // Sunday (0) or Saturday (6)
        }

        function isHoliday(year, month, day) {
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            return nationalHolidays.includes(dateString);
        }

        /**
         * Checks if an employee is on vacation on a specific day for the *current* month.
         * Fetches vacation data from monthlySchedulesData.
         */
        function isVacation(employeeId, year, month, day) {
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            const employeeMonthlyData = monthlySchedulesData[monthKey] && monthlySchedulesData[monthKey][employeeId];

            if (!employeeMonthlyData || !employeeMonthlyData.vacations) return false;

            const currentDate = new Date(year, month, day);
            currentDate.setHours(0,0,0,0); // Normalize to start of day

            for (const vacation of employeeMonthlyData.vacations) {
                const startDate = new Date(vacation.start);
                startDate.setHours(0,0,0,0); // Normalize to start of day
                const endDate = new Date(vacation.end);
                endDate.setHours(0,0,0,0); // Normalize to start of day

                if (currentDate >= startDate && currentDate <= endDate) {
                    return true;
                }
            }
            return false;
        }

        /**
         * Extracts the hour from a work shift string (e.g., "08h-17h" -> 8).
         * Returns -1 if unable to parse.
         */
        function parseWorkShiftHour(workShift) {
            const match = workShift.match(/^(\d{2})h/);
            return match ? parseInt(match[1], 10) : -1;
        }

        function sortEmployeesByRole(empArray) {
            return [...empArray].sort((a, b) => {
                const roleA = a.role.toLowerCase();
                const roleB = b.role.toLowerCase();

                // Define role order priority
                const roleOrder = {
                    'técnico enfermagem': 1, // Updated role name
                    'enfermeiro': 2,
                    'outro': 3
                };

                const orderA = roleOrder[roleA] || 99; // Default to a high number for unknown roles
                const orderB = roleOrder[roleB] || 99;

                if (orderA !== orderB) {
                    return orderA - orderB;
                }

                // If roles are the same, sort by work shift hour
                const hourA = parseWorkShiftHour(a.workShift || '');
                const hourB = parseWorkShiftHour(b.workShift || '');

                if (hourA !== hourB) {
                    // Treat unparseable hours as last
                    if (hourA === -1 && hourB !== -1) return 1;
                    if (hourA !== -1 && hourB === -1) return -1;
                    return hourA - hourB;
                }

                // If roles and hours are the same, sort by name
                return a.name.localeCompare(b.name);
            });
        }

        // --- Render Functions ---

        function renderCurrentMonthYear() {
            const date = new Date(currentYear, currentMonth);
            document.getElementById('currentMonthYear').textContent = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
        }

        function renderEmployeeList() {
            const employeesUl = document.getElementById('employeesUl');
            employeesUl.innerHTML = '';
            if (employees.length === 0) {
                employeesUl.innerHTML = '<li class="text-gray-500">Nenhum funcionário cadastrado.</li>';
                return;
            }

            const sortedEmployees = sortEmployeesByRole(employees);

            sortedEmployees.forEach(emp => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm border border-gray-200';
                
                // Determine the team color class
                const teamColorClass = `team-${emp.team.toLowerCase()}`;

                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-medium ${teamColorClass} cursor-pointer" onclick="window.openSiglaVacationModal('${emp.id}')">${emp.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(${emp.role} - ${emp.council} - ${emp.workShift})</span>
                        <span class="text-sm text-gray-500 ml-2">(Equipe: ${emp.team})</span>
                        <span class="text-xs text-gray-400 block break-all">ID: ${emp.id}</span>
                    </div>
                    <div>
                        <button onclick="window.deleteEmployee('${emp.id}')" class="btn-danger ml-2">Excluir</button>
                    </div>
                `;
                employeesUl.appendChild(li);
            });
        }

        function renderSchedule() {
            renderCurrentMonthYear();
            const scheduleHeader = document.getElementById('scheduleHeader');
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleHeader.innerHTML = `
                <th class="w-1/6">Nome</th>
                <th class="w-1/12">Função</th>
                <th class="w-1/12">Conselho</th>
                <th class="w-1/12">Horário de Trabalho</th>
            `;
            scheduleBody.innerHTML = '';

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

            // Ensure current month data structure exists
            if (!monthlySchedulesData[monthKey]) {
                monthlySchedulesData[monthKey] = {};
            }

            // Add day headers
            for (let i = 1; i <= daysInMonth; i++) {
                const th = document.createElement('th');
                const date = new Date(currentYear, currentMonth, i);
                const dayOfWeek = date.getDay(); // 0 for Sunday, 6 for Saturday
                th.textContent = i;
                if (isWeekend(currentYear, currentMonth, i) || isHoliday(currentYear, currentMonth, i)) {
                    th.classList.add('weekend');
                }
                scheduleHeader.appendChild(th);
            }

            const sortedEmployees = sortEmployeesByRole(employees);

            // Add employee rows
            sortedEmployees.forEach(emp => {
                const tr = document.createElement('tr');
                
                // Determine the team color class for the name cell
                const teamColorClass = `team-${emp.team.toLowerCase()}`;

                tr.innerHTML = `
                    <td class="font-medium ${teamColorClass} cursor-pointer" onclick="window.openSiglaVacationModal('${emp.id}')">
                        ${emp.name}
                    </td>
                    <td>${emp.role}</td>
                    <td>${emp.council}</td>
                    <td>${emp.workShift || ''}</td> `;
                for (let i = 1; i <= daysInMonth; i++) {
                    const td = document.createElement('td');
                    const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    td.setAttribute('data-employee-id', emp.id); // Add data attribute for employee ID
                    td.setAttribute('data-date-key', dateKey); // Add data attribute for date key
                    td.onclick = function() { window.openSiglaVacationModal(emp.id, dateKey); }; // Click handler for day cells

                    // Get employee's schedule and vacation data for this specific month
                    const employeeMonthlySchedule = monthlySchedulesData[monthKey] && monthlySchedulesData[monthKey][emp.id];
                    const employeeVacations = employeeMonthlySchedule ? employeeMonthlySchedule.vacations : [];
                    const employeeDailySiglas = employeeMonthlySchedule && employeeMonthlySchedule.siglas && employeeMonthlySchedule.siglas[dateKey] ? employeeMonthlySchedule.siglas[dateKey] : [];


                    // Check for vacation based on monthly data
                    let isCurrentDayVacation = false;
                    const currentDate = new Date(currentYear, currentMonth, i);
                    currentDate.setHours(0,0,0,0);

                    for (const vac of employeeVacations) {
                        const vacStart = new Date(vac.start);
                        vacStart.setHours(0,0,0,0);
                        const vacEnd = new Date(vac.end);
                        vacEnd.setHours(0,0,0,0);

                        if (currentDate >= vacStart && currentDate <= vacEnd) {
                            isCurrentDayVacation = true;
                            break;
                        }
                    }


                    if (isCurrentDayVacation) {
                        // Check if this is the start of a vacation block for merging
                        const prevDayIsVacation = i > 1 && isVacation(emp.id, currentYear, currentMonth, i - 1);

                        if (!prevDayIsVacation) {
                            let span = 1;
                            let j = i + 1;
                            while (j <= daysInMonth && isVacation(emp.id, currentYear, currentMonth, j)) {
                                span++;
                                j++;
                            }
                            td.colSpan = span;
                            td.classList.add('vacation');
                            td.textContent = 'FÉRIAS';
                            tr.appendChild(td);
                            i += (span - 1); // Skip merged days
                        } else {
                            // If it's a continuation of vacation, this cell should be skipped
                            // The loop will advance 'i' correctly when the 'td' is appended
                        }
                    } else {
                        // Display multiple siglas joined by comma
                        td.textContent = Array.isArray(employeeDailySiglas) ? employeeDailySiglas.join(', ') : employeeDailySiglas; // Handle old string format if any
                        if (isWeekend(currentYear, currentMonth, i) || isHoliday(currentYear, currentMonth, i)) {
                            td.classList.add('weekend');
                        }
                        tr.appendChild(td);
                    }
                }
                scheduleBody.appendChild(tr);
            });
            loadMonthlyObservations(); // Load observations for the rendered month
        }

        // New: Function to render checkboxes in Sigla/Vacation Modal
        function renderSiglaCheckboxes() {
            const siglaCheckboxesMonthDiv = document.getElementById('siglaCheckboxesMonth');
            const siglaCheckboxesDayDiv = document.getElementById('siglaCheckboxesDay');

            // Clear existing checkboxes
            siglaCheckboxesMonthDiv.innerHTML = '';
            siglaCheckboxesDayDiv.innerHTML = '';

            // Combine default and custom siglas
            const allPossibleSiglas = [...defaultSiglas, ...customSiglas];

            // Render for Month Section (excluding daily-only siglas)
            allPossibleSiglas.forEach(sigla => {
                if (!dailyOnlySiglas.includes(sigla.name)) {
                    const label = document.createElement('label');
                    label.className = 'flex items-center';
                    label.innerHTML = `<input type="checkbox" name="siglaMonth" value="${sigla.name}" class="mr-2"> ${sigla.name} (${sigla.description})`;
                    siglaCheckboxesMonthDiv.appendChild(label);
                }
            });

            // Render for Day Section (including all siglas)
            allPossibleSiglas.forEach(sigla => {
                const label = document.createElement('label');
                label.className = 'flex items-center';
                label.innerHTML = `<input type="checkbox" name="siglaDay" value="${sigla.name}" class="mr-2"> ${sigla.name} (${sigla.description})`;
                siglaCheckboxesDayDiv.appendChild(label);
            });

            // Explicitly add FO/LM to Day Section if they are not in allPossibleSiglas (should be, but as a safeguard)
            if (!allPossibleSiglas.some(s => s.name === 'FO')) {
                const foLabel = document.createElement('label');
                foLabel.className = 'flex items-center';
                foLabel.innerHTML = `<input type="checkbox" name="siglaDay" value="FO" class="mr-2"> FO (Folga)`;
                siglaCheckboxesDayDiv.appendChild(foLabel);
            }
            if (!allPossibleSiglas.some(s => s.name === 'LM')) {
                const lmLabel = document.createElement('label');
                lmLabel.className = 'flex items-center';
                lmLabel.innerHTML = `<input type="checkbox" name="siglaDay" value="LM" class="mr-2"> LM (Licença Médica)`;
                siglaCheckboxesDayDiv.appendChild(lmLabel);
            }
        }


        // New: Function to render the list of custom siglas in the management modal
        function renderCustomSiglasList() {
            const customSiglasListUl = document.getElementById('customSiglasList');
            customSiglasListUl.innerHTML = '';

            if (customSiglas.length === 0) {
                customSiglasListUl.innerHTML = '<li class="text-gray-500">Nenhuma sigla personalizada adicionada.</li>';
                return;
            }

            customSiglas.forEach(sigla => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-2 rounded-md shadow-sm border border-gray-200';
                li.innerHTML = `
                    <span><strong>${sigla.name}</strong>: ${sigla.description}</span>
                    <button onclick="window.removeCustomSigla('${sigla.name}')" class="btn-danger ml-2">Remover</button>
                `;
                customSiglasListUl.appendChild(li);
            });
        }

        // --- Employee Actions ---

        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            let role = document.getElementById('employeeRole').value.trim();
            const customRole = document.getElementById('customEmployeeRole').value.trim();
            const council = document.getElementById('employeeCouncil').value.trim();
            const workShift = document.getElementById('employeeWorkShift').value.trim();
            const team = document.getElementById('employeeTeam').value.trim();

            if (role === 'Outro') {
                role = customRole; // Use custom role if "Outro" is selected
            }

            if (name && role && council && workShift && team) {
                const newEmployee = {
                    id: crypto.randomUUID(), // Unique ID for each employee
                    name,
                    role,
                    council,
                    workShift,
                    team // Add team to employee object
                    // schedule and vacations are no longer stored here
                };
                employees.push(newEmployee);
                saveEmployees(); // Save master employee list
                renderEmployeeList();
                renderSchedule(); // Rerender to show new employee (without schedule yet for current month)
                document.getElementById('employeeName').value = '';
                document.getElementById('employeeRole').value = '';
                document.getElementById('customEmployeeRole').value = ''; // Clear custom role field
                document.getElementById('customEmployeeRole').classList.add('hidden'); // Hide custom role field
                document.getElementById('employeeCouncil').value = '';
                document.getElementById('employeeWorkShift').value = '';
                document.getElementById('employeeTeam').value = '';
                window.showMessageBox('Funcionário adicionado com sucesso!');
            } else {
                window.showMessageBox('Por favor, preencha todos os campos do funcionário.', 4000);
            }
        }

        window.deleteEmployee = function(id) {
            if (confirm('Tem certeza que deseja excluir este funcionário? Isso o removerá da lista de funcionários ativos, mas suas escalas em meses anteriores permanecerão nos registros históricos daquele mês.')) {
                employees = employees.filter(emp => emp.id !== id);
                saveEmployees(); // Update master employee list
                renderEmployeeList();
                renderSchedule(); // Rerender to remove from current month
                // Note: Historical monthly data for this employee will remain in monthlySchedulesData
                window.showMessageBox('Funcionário excluído da lista ativa.');
            }
        }

        // --- Modal Functions ---

        window.openSiglaVacationModal = function(employeeId, dateKey = null) {
            currentEditingEmployeeId = employeeId;
            currentEditingDateKey = dateKey; // Store the dateKey
            const employee = employees.find(emp => emp.id === employeeId);
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

            // Get the specific employee's schedule for the current month
            const employeeCurrentMonthSchedule = monthlySchedulesData[monthKey] && monthlySchedulesData[monthKey][employeeId] ?
                                                monthlySchedulesData[monthKey][employeeId] :
                                                { siglas: {}, vacations: [] };
            
            // Ensure the employee entry exists for the current month in monthlySchedulesData
            if (!monthlySchedulesData[monthKey]) {
                monthlySchedulesData[monthKey] = {};
            }
            if (!monthlySchedulesData[monthKey][employeeId]) {
                monthlySchedulesData[monthKey][employeeId] = { siglas: {}, vacations: [] };
            }


            if (employee) {
                document.getElementById('modalEmployeeName').textContent = `Editar Escala de: ${employee.name}`;
                document.getElementById('siglaVacationModal').classList.remove('hidden');

                // Reset form fields
                document.getElementById('vacationStart').value = '';
                document.getElementById('vacationEnd').value = '';
                document.getElementById('multiDaySiglaStart').value = '';
                document.getElementById('multiDaySiglaEnd').value = '';
                document.querySelector('input[name="multiDaySiglaType"][value="LM"]').checked = true; // Default to LM

                const siglaSectionMonth = document.getElementById('siglaSectionMonth');
                const siglaSectionDay = document.getElementById('siglaSectionDay');
                const multiDaySiglaSection = document.getElementById('multiDaySiglaSection'); // Get new section element
                const modalDayNumber = document.getElementById('modalDayNumber');

                // Re-render checkboxes to ensure custom siglas are included
                renderSiglaCheckboxes();

                if (currentEditingDateKey) {
                    // Editing a specific day
                    siglaSectionMonth.classList.add('hidden');
                    siglaSectionDay.classList.remove('hidden');
                    multiDaySiglaSection.classList.remove('hidden'); // Always show multi-day section

                    modalDayNumber.textContent = currentEditingDateKey.split('-')[2]; // Extract day number
                    document.getElementById('multiDaySiglaStart').value = currentEditingDateKey; // Pre-fill multi-day dates
                    document.getElementById('multiDaySiglaEnd').value = currentEditingDateKey;

                    // Pre-check siglas for the specific day
                    const checkboxesDay = document.querySelectorAll('#siglaCheckboxesDay input[type="checkbox"]');
                    checkboxesDay.forEach(cb => cb.checked = false); // Uncheck all first

                    const siglasForDay = employeeCurrentMonthSchedule.siglas && employeeCurrentMonthSchedule.siglas[currentEditingDateKey] ? employeeCurrentMonthSchedule.siglas[currentEditingDateKey] : [];
                    if (Array.isArray(siglasForDay)) {
                        siglasForDay.forEach(sigla => {
                            const checkbox = document.querySelector(`#siglaCheckboxesDay input[value="${sigla}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                            // Also pre-select LM/FO radio if present
                            if (sigla === 'LM' || sigla === 'FO') {
                                document.querySelector(`input[name="multiDaySiglaType"][value="${sigla}"]`).checked = true;
                            }
                        });
                    }
                } else {
                    // Editing general monthly schedule (from employee name click)
                    siglaSectionMonth.classList.remove('hidden');
                    siglaSectionDay.classList.add('hidden');
                    multiDaySiglaSection.classList.remove('hidden'); // Always show multi-day section

                    // Clear and pre-check siglas based on current month's schedule for this employee
                    const checkboxesMonth = document.querySelectorAll('#siglaCheckboxesMonth input[type="checkbox"]');
                    checkboxesMonth.forEach(cb => cb.checked = false); // Uncheck all first

                    const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                    const currentMonthSiglas = new Set(); // Use a Set to store unique siglas for the month

                    for (let i = 1; i <= daysInMonth; i++) {
                        const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        const siglasForDay = employeeCurrentMonthSchedule.siglas && employeeCurrentMonthSchedule.siglas[dateKey] ? employeeCurrentMonthSchedule.siglas[dateKey] : [];
                        if (Array.isArray(siglasForDay)) {
                            // Exclude daily-only siglas from general month view pre-check
                            siglasForDay.filter(s => !dailyOnlySiglas.includes(s)).forEach(sigla => currentMonthSiglas.add(sigla));
                        } else if (typeof siglasForDay === 'string' && siglasForDay !== '' && !dailyOnlySiglas.includes(siglasForDay)) {
                            // Handle old string format: treat as a single sigla
                            currentMonthSiglas.add(siglasForDay);
                        }
                    }

                    currentMonthSiglas.forEach(sigla => {
                        const checkbox = document.querySelector(`#siglaCheckboxesMonth input[value="${sigla}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
            }
        }

        window.closeSiglaVacationModal = function() {
            document.getElementById('siglaVacationModal').classList.add('hidden');
            currentEditingEmployeeId = null;
            currentEditingDateKey = null; // Clear the dateKey
        }

        function applySiglaMonth() {
            const selectedSiglas = Array.from(document.querySelectorAll('#siglaCheckboxesMonth input[type="checkbox"]:checked')).map(cb => cb.value);

            if (selectedSiglas.length === 0) {
                window.showMessageBox('Por favor, selecione ao menos uma sigla.', 3000);
                return;
            }

            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const employeeMonthlyData = monthlySchedulesData[monthKey][currentEditingEmployeeId];
            
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);

            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                // Check for vacation on the specific day (important before applying month-wide siglas)
                if (isVacation(currentEditingEmployeeId, currentYear, currentMonth, i)) {
                    continue; // Skip if it's a vacation day
                }

                if (!isWeekend(currentYear, currentMonth, i) && !isHoliday(currentYear, currentMonth, i)) {
                    // Preserve daily-only siglas if they were set for a specific day
                    const existingSiglas = employeeMonthlyData.siglas[dateKey] || [];
                    const preservedSiglas = Array.isArray(existingSiglas) ? existingSiglas.filter(s => dailyOnlySiglas.includes(s)) : [];
                    employeeMonthlyData.siglas[dateKey] = [...new Set([...preservedSiglas, ...selectedSiglas])]; // Combine and remove duplicates
                }
            }
            saveCurrentMonthSchedule(); // Save changes to the monthly schedule data
            renderSchedule();
            window.showMessageBox('Sigla(s) aplicada(s) para os dias úteis do mês.');
            window.closeSiglaVacationModal();
        }

        function clearSiglasForMonth() {
            if (confirm('Tem certeza que deseja limpar TODAS as siglas deste funcionário para o mês atual?')) {
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const employeeMonthlyData = monthlySchedulesData[monthKey][currentEditingEmployeeId];

                const daysInMonth = getDaysInMonth(currentYear, currentMonth);

                for (let i = 1; i <= daysInMonth; i++) {
                    const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    // Preserve daily-only siglas when clearing month siglas
                    const existingSiglas = employeeMonthlyData.siglas[dateKey] || [];
                    const preservedSiglas = Array.isArray(existingSiglas) ? existingSiglas.filter(s => dailyOnlySiglas.includes(s)) : [];

                    if (preservedSiglas.length > 0) {
                        employeeMonthlyData.siglas[dateKey] = preservedSiglas;
                    } else {
                        delete employeeMonthlyData.siglas[dateKey];
                    }
                }
                saveCurrentMonthSchedule();
                renderSchedule();
                window.showMessageBox('Siglas do funcionário para o mês atual limpas (exceto folgas e licenças médicas).');
                window.closeSiglaVacationModal();
            }
        }

        function applySiglaDay() {
            const selectedSiglas = Array.from(document.querySelectorAll('#siglaCheckboxesDay input[type="checkbox"]:checked')).map(cb => cb.value);

            if (selectedSiglas.length === 0) {
                window.showMessageBox('Por favor, selecione ao menos uma sigla.', 3000);
                return;
            }
            if (!currentEditingDateKey) {
                window.showMessageBox('Erro: Dia não selecionado para aplicar sigla.', 3000);
                return;
            }

            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const employeeMonthlyData = monthlySchedulesData[monthKey][currentEditingEmployeeId];

            // For single day, we replace existing siglas with selected ones, but don't overwrite if it's a vacation
            const dateParts = currentEditingDateKey.split('-');
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
            const day = parseInt(dateParts[2]);

            if (isVacation(currentEditingEmployeeId, year, month, day)) {
                window.showMessageBox('Não é possível aplicar siglas em um dia de férias.', 3000);
                return;
            }

            employeeMonthlyData.siglas[currentEditingDateKey] = selectedSiglas;

            saveCurrentMonthSchedule();
            renderSchedule();
            window.showMessageBox(`Sigla(s) aplicada(s) para o dia ${currentEditingDateKey.split('-')[2]}.`);
            window.closeSiglaVacationModal();
        }

        function clearSiglasForDay() {
             if (!currentEditingDateKey) {
                window.showMessageBox('Erro: Dia não selecionado para limpar sigla.', 3000);
                return;
            }
            if (confirm(`Tem certeza que deseja limpar as siglas para o dia ${currentEditingDateKey.split('-')[2]}?`)) {
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const employeeMonthlyData = monthlySchedulesData[monthKey][currentEditingEmployeeId];

                if (employeeMonthlyData.siglas && employeeMonthlyData.siglas[currentEditingDateKey]) {
                    delete employeeMonthlyData.siglas[currentEditingDateKey];
                }
                saveCurrentMonthSchedule();
                renderSchedule();
                window.showMessageBox(`Siglas para o dia ${currentEditingDateKey.split('-')[2]} limpas.`);
                window.closeSiglaVacationModal();
            }
        }

        // NEW: Function to apply LM/FO over a period
        function applyMultiDaySigla() {
            const multiDaySiglaType = document.querySelector('input[name="multiDaySiglaType"]:checked').value;
            const startDateStr = document.getElementById('multiDaySiglaStart').value;
            const endDateStr = document.getElementById('multiDaySiglaEnd').value;

            if (!startDateStr || !endDateStr) {
                window.showMessageBox('Por favor, selecione as datas de início e fim para a LM/FO.', 4000);
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00'); // Use 'T00:00:00' to avoid timezone issues
            const endDate = new Date(endDateStr + 'T00:00:00'); // Use 'T00:00:00' to avoid timezone issues


            if (startDate > endDate) {
                window.showMessageBox('A data de início não pode ser posterior à data de fim.', 4000);
                return;
            }

            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const employeeMonthlyData = monthlySchedulesData[monthKey][currentEditingEmployeeId];
            
            let tempDate = new Date(startDate); // Use a new Date object for iteration
            let appliedCount = 0;

            while (tempDate <= endDate) {
                const year = tempDate.getFullYear();
                const month = tempDate.getMonth();
                const day = tempDate.getDate();
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // Only apply if it's within the current displayed month, or if it's a cross-month application for LM/FO
                const isWithinCurrentDisplayMonth = (year === currentYear && month === currentMonth);

                if (!isVacation(currentEditingEmployeeId, year, month, day)) {
                    if (isWithinCurrentDisplayMonth) {
                        employeeMonthlyData.siglas[dateKey] = [multiDaySiglaType];
                        appliedCount++;
                    } else if (tempDate.getMonth() === startDate.getMonth() && tempDate.getFullYear() === startDate.getFullYear()) {
                        // Apply to start month even if it's not the current displayed month
                         // This case shouldn't be hit with the current logic, but ensures if date picker changes month, it still works.
                         // For now, we only care about the currently displayed month's data.
                    }
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            saveCurrentMonthSchedule();
            renderSchedule();
            if (appliedCount > 0) {
                window.showMessageBox(`${multiDaySiglaType} aplicada para ${appliedCount} dia(s) no período.`);
            } else {
                window.showMessageBox(`Nenhum dia de ${multiDaySiglaType} aplicado no mês atual, pois todos os dias no período são férias ou fora do mês atual.`);
            }
            window.closeSiglaVacationModal();
        }

        // NEW: Function to clear LM/FO over a period
        function clearMultiDaySiglaRange() {
            const multiDaySiglaType = document.querySelector('input[name="multiDaySiglaType"]:checked').value;
            const startDateStr = document.getElementById('multiDaySiglaStart').value;
            const endDateStr = document.getElementById('multiDaySiglaEnd').value;

            if (!startDateStr || !endDateStr) {
                window.showMessageBox('Por favor, selecione as datas de início e fim para limpar a LM/FO.', 4000);
                return;
            }

            const startDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');

            if (startDate > endDate) {
                window.showMessageBox('A data de início não pode ser posterior à data de fim.', 4000);
                return;
            }

            if (!confirm(`Tem certeza que deseja limpar a sigla "${multiDaySiglaType}" para o período selecionado?`)) {
                return;
            }

            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const employeeMonthlyData = monthlySchedulesData[monthKey][currentEditingEmployeeId];
            
            let tempDate = new Date(startDate);
            let clearedCount = 0;

            while (tempDate <= endDate) {
                const year = tempDate.getFullYear();
                const month = tempDate.getMonth();
                const day = tempDate.getDate();
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // Only clear if it's within the current displayed month
                const isWithinCurrentDisplayMonth = (year === currentYear && month === currentMonth);

                if (isWithinCurrentDisplayMonth) {
                    if (employeeMonthlyData.siglas && employeeMonthlyData.siglas[dateKey]) {
                        const existingSiglas = Array.isArray(employeeMonthlyData.siglas[dateKey]) ? employeeMonthlyData.siglas[dateKey] : [employeeMonthlyData.siglas[dateKey]];
                        const newSiglas = existingSiglas.filter(s => s !== multiDaySiglaType);

                        if (newSiglas.length !== existingSiglas.length) { // Only increment if something was actually removed
                            clearedCount++;
                        }

                        if (newSiglas.length === 0) {
                            delete employeeMonthlyData.siglas[dateKey];
                        } else {
                            employeeMonthlyData.siglas[dateKey] = newSiglas;
                        }
                    }
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            saveCurrentMonthSchedule();
            renderSchedule();
            if (clearedCount > 0) {
                window.showMessageBox(`${multiDaySiglaType} limpa para ${clearedCount} dia(s) no período.`);
            } else {
                window.showMessageBox(`Nenhum dia de ${multiDaySiglaType} encontrado ou limpo no período atual.`);
            }
            window.closeSiglaVacationModal();
        }


        function applyVacation() {
            const vacationStart = document.getElementById('vacationStart').value;
            const vacationEnd = document.getElementById('vacationEnd').value;

            if (!vacationStart || !vacationEnd) {
                window.showMessageBox('Por favor, selecione as datas de início e fim das férias.', 4000);
                return;
            }

            const startDate = new Date(vacationStart + 'T00:00:00');
            const endDate = new Date(vacationEnd + 'T00:00:00');


            if (startDate > endDate) {
                window.showMessageBox('A data de início das férias não pode ser posterior à data de fim.', 4000);
                return;
            }

            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const employeeMonthlyData = monthlySchedulesData[monthKey][currentEditingEmployeeId];

            if (!employeeMonthlyData.vacations) employeeMonthlyData.vacations = [];

            // Clear any existing schedule entries within the vacation period for the current month
            let tempDate = new Date(startDate);
            while (tempDate <= endDate) {
                const year = tempDate.getFullYear();
                const month = tempDate.getMonth();
                const day = tempDate.getDate();
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // Only clear if the day is within the currently displayed month
                if (year === currentYear && month === currentMonth) {
                    delete employeeMonthlyData.siglas[dateKey]; // Vacations overwrite any other siglas
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }

            // Add the new vacation period to the current month's schedule data
            // Filter out existing overlapping vacations if desired, or just add
            employeeMonthlyData.vacations.push({ start: vacationStart, end: vacationEnd }); // Store as YYYY-MM-DD strings
            
            saveCurrentMonthSchedule(); // Save changes to the monthly schedule data
            renderSchedule();
            window.showMessageBox('Férias aplicadas com sucesso!');
            window.closeSiglaVacationModal();
        }

        function clearVacation() {
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const employeeMonthlyData = monthlySchedulesData[monthKey][currentEditingEmployeeId];
            
            if (confirm('Tem certeza que deseja limpar TODAS as férias deste funcionário para o mês atual e remover entradas de férias em outros meses que se sobreponham a este mês?')) {
                employeeMonthlyData.vacations = []; // Clear all vacations for this employee FOR THIS MONTH

                saveCurrentMonthSchedule();
                renderSchedule();
                window.showMessageBox('Férias do funcionário para o mês atual limpas.');
                window.closeSiglaVacationModal();
            }
        }

        function clearEmployeeSchedule() {
            if (confirm('Tem certeza que deseja limpar toda a escala e férias deste funcionário SOMENTE para o mês atual?')) {
                const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                const employeeMonthlyData = monthlySchedulesData[monthKey][currentEditingEmployeeId];

                employeeMonthlyData.siglas = {}; // Clear all schedule
                employeeMonthlyData.vacations = []; // Clear all vacations

                saveCurrentMonthSchedule();
                renderSchedule();
                window.showMessageBox('Escala e férias do funcionário limpas para o mês atual.');
                window.closeSiglaVacationModal();
            }
        }

        // --- New Sigla Management Modal Functions ---

        window.openManageSiglasModal = function() {
            document.getElementById('manageSiglasModal').classList.remove('hidden');
            renderCustomSiglasList(); // Render the list when opening the modal
        }

        window.closeManageSiglasModal = function() {
            document.getElementById('manageSiglasModal').classList.add('hidden');
            document.getElementById('newSiglaName').value = '';
            document.getElementById('newSiglaDescription').value = '';
            renderSiglaCheckboxes(); // Re-render sigla checkboxes in vacation modal to reflect changes
        }

        function addCustomSigla() {
            const newName = document.getElementById('newSiglaName').value.trim().toUpperCase();
            const newDescription = document.getElementById('newSiglaDescription').value.trim();

            if (!newName || !newDescription) {
                window.showMessageBox('Por favor, preencha o nome e a descrição da sigla.', 3000);
                return;
            }

            // Check if sigla already exists (default or custom)
            const allCurrentSiglas = [...defaultSiglas, ...customSiglas];
            if (allCurrentSiglas.some(s => s.name === newName)) {
                window.showMessageBox(`A sigla "${newName}" já existe.`, 3000);
                return;
            }

            customSiglas.push({ name: newName, description: newDescription });
            saveCustomSiglas();
            renderCustomSiglasList();
            document.getElementById('newSiglaName').value = '';
            document.getElementById('newSiglaDescription').value = '';
            window.showMessageBox(`Sigla "${newName}" adicionada com sucesso!`);
        }

        window.removeCustomSigla = function(siglaName) {
            if (confirm(`Tem certeza que deseja remover a sigla "${siglaName}"? Isso não removerá a sigla já aplicada nas escalas.`)) {
                customSiglas = customSiglas.filter(sigla => sigla.name !== siglaName);
                saveCustomSiglas();
                renderCustomSiglasList();
                window.showMessageBox(`Sigla "${siglaName}" removida.`);
            }
        }


        // --- Print Functionality ---

        function printSchedule() {
            const printWindow = window.open('', '_blank');
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const currentMonthSchedule = monthlySchedulesData[monthKey] || {};

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Imprimir Escala - ${document.getElementById('currentMonthYear').textContent}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; }
                        .printable-header { text-align: center; margin-bottom: 20px; font-size: 16px; }
                        .printable-table-container { overflow: hidden; } /* Ensure table fits */
                        .printable-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                        .printable-table th, .printable-table td {
                            border: 1px solid #000;
                            padding: 4px;
                            text-align: center;
                            font-size: 8px; /* Even smaller font for print */
                            white-space: normal; /* Allow wrapping for print */
                            word-break: break-word; /* Break long words */
                        }
                        .printable-table th { background-color: #e0e0e0; }
                        .printable-table .weekend, .printable-table .holiday { background-color: #ccc; }
                        .printable-table .vacation { background-color: #a7d9ff; font-weight: bold; }
                        .printable-legend {
                            font-size: 10px;
                            margin-top: 20px;
                            border-top: 1px solid #000;
                            padding-top: 10px;
                            page-break-before: avoid; /* Avoid breaking page before legend */
                        }
                        /* Team Colors for Print */
                        .team-sol { color: #f59e0b !important; } /* Amber */
                        .team-verde { color: #10b981 !important; } /* Emerald */
                        .team-vermelha { color: #ef4444 !important; } /* Red */
                        .team-azul { color: #3b82f6 !important; } /* Blue */
                        .team-laranja { color: #fb923c !important; } /* Orange */
                        .team-apoio { color: #6b7280 !important; } /* Gray */


                        /* Column widths for print */
                        .printable-table th:nth-child(1) { width: 12%; } /* Nome */
                        .printable-table th:nth-child(2) { width: 8%; } /* Função */
                        .printable-table th:nth-child(3) { width: 10%; } /* Conselho */
                        .printable-table th:nth-child(4) { width: 8%; } /* Horário de Trabalho */
                        .printable-table th:nth-child(n+5) { width: calc(62% / ${getDaysInMonth(currentYear, currentMonth)}); } /* Days */

                        @page {
                            size: landscape; /* Default to landscape */
                            margin: 1cm;
                        }
                    </style>
                </head>
                <body>
                    <div class="printable-content">
                        <div class="printable-header">
                            <h2>Escala do Centro de Saúde - ${document.getElementById('currentMonthYear').textContent}</h2>
                        </div>
                        <div class="printable-table-container">
                            <table class="printable-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Função</th>
                                        <th>Conselho</th>
                                        <th>Horário de Trabalho</th>
                                        ${Array.from({ length: getDaysInMonth(currentYear, currentMonth) }, (_, i) => {
                                            const day = i + 1;
                                            const isDayWeekend = isWeekend(currentYear, currentMonth, day);
                                            const isDayHoliday = isHoliday(currentYear, currentMonth, day);
                                            let classes = '';
                                            if (isDayWeekend || isDayHoliday) classes = 'weekend';
                                            return `<th class="${classes}">${day}</th>`;
                                        }).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortEmployeesByRole(employees).map(emp => {
                                        const teamColorClass = `team-${emp.team.toLowerCase()}`; // Get team class for print
                                        const employeeMonthlySchedule = currentMonthSchedule[emp.id] || { siglas: {}, vacations: [] };
                                        const employeeVacations = employeeMonthlySchedule.vacations;
                                        
                                        let rowHtml = `<tr>
                                            <td class="font-medium ${teamColorClass}">
                                                ${emp.name}
                                            </td>
                                            <td>${emp.role}</td>
                                            <td>${emp.council}</td>
                                            <td>${emp.workShift || ''}</td>`;
                                        for (let i = 1; i <= getDaysInMonth(currentYear, currentMonth); i++) {
                                            const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                                            const isDayWeekend = isWeekend(currentYear, currentMonth, i);
                                            const isDayHoliday = isHoliday(currentYear, currentMonth, i);
                                            let cellContent = '';
                                            let cellClasses = '';

                                            // Check for vacation based on monthly data
                                            let isCurrentDayVacation = false;
                                            const currentDate = new Date(currentYear, currentMonth, i);
                                            currentDate.setHours(0,0,0,0);

                                            for (const vac of employeeVacations) {
                                                const vacStart = new Date(vac.start);
                                                vacStart.setHours(0,0,0,0);
                                                const vacEnd = new Date(vac.end);
                                                vacEnd.setHours(0,0,0,0);

                                                if (currentDate >= vacStart && currentDate <= vacEnd) {
                                                    isCurrentDayVacation = true;
                                                    break;
                                                }
                                            }

                                            if (isCurrentDayVacation) {
                                                // Check if this is the start of a vacation block for merging
                                                const prevDayIsVacation = i > 1 && isVacation(emp.id, currentYear, currentMonth, i - 1);
                                                if (!prevDayIsVacation) {
                                                    let span = 1;
                                                    let j = i + 1;
                                                    while (j <= getDaysInMonth(currentYear, currentMonth) && isVacation(emp.id, currentYear, currentMonth, j)) {
                                                        span++;
                                                        j++;
                                                    }
                                                    cellContent = 'FÉRIAS';
                                                    cellClasses = 'vacation';
                                                    rowHtml += `<td colspan="${span}" class="${cellClasses}">${cellContent}</td>`;
                                                    i += (span - 1); // Skip merged days
                                                }
                                            } else {
                                                // Display multiple siglas joined by comma
                                                const siglas = employeeMonthlySchedule.siglas[dateKey] ? employeeMonthlySchedule.siglas[dateKey] : [];
                                                cellContent = Array.isArray(siglas) ? siglas.join(', ') : siglas;
                                                if (isDayWeekend || isDayHoliday) {
                                                    cellClasses = 'weekend';
                                                }
                                                rowHtml += `<td class="${cellClasses}">${cellContent}</td>`;
                                            }
                                        }
                                        rowHtml += `</tr>`;
                                        return rowHtml;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="printable-legend">
                            <h3>Legenda:</h3>
                            <ul>
                                <li><strong>F:</strong> Farmácia</li>
                                <li><strong>S:</strong> Sala de Observação</li>
                                <li><strong>P:</strong> Presente</li>
                                <li><strong>CT:</strong> Curativo</li>
                                <li><strong>BR:</strong> Acolhimento Baixo Risco</li>
                                <li><strong>LM:</strong> Licença Médica</li>
                                <li><strong>FO:</strong> Folga</li>
                                <li><strong>E:</strong> ECG</li>
                                <li><strong>V:</strong> Vacina</li>
                                <li><strong>T:</strong> Totem</li>
                                <li><strong>C:</strong> Consultórios</li>
                            </ul>
                            ${[...customSiglas].map(s => `<li><strong>${s.name}:</strong> ${s.description}</li>`).join('')}
                            <p><strong>Observações:</strong> ${monthlyObservations[`${currentYear}-${currentMonth + 1}`] || 'Nenhuma observação para este mês.'}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        /**
         * Adds a specified number of months to a given date, handling day overflows correctly
         * (e.g., Jan 31 + 1 month becomes Feb 28/29, not Mar 2).
         * @param {string} dateString - The date string (YYYY-MM-DD).
         * @param {number} months - The number of months to add.
         * @returns {Date} The new date object.
         */
        function addMonthsToDate(dateString, months) {
            const date = new Date(dateString + 'T00:00:00'); // Use 'T00:00:00' to avoid timezone issues
            const day = date.getDate();
            date.setMonth(date.getMonth() + months);
            // If the month rolled over due to day overflow (e.g., Jan 31 -> Feb 28 -> Mar 2),
            // set it to the last day of the target month.
            if (date.getDate() !== day) {
                date.setDate(0); // This sets it to the last day of the *previous* month.
                date.setMonth(date.getMonth() + 1); // Then advance to the correct month.
            }
            return date;
        }

        // --- New: Function to copy schedule to next month ---
        function copyScheduleToNextMonth() {
            if (!confirm('Tem certeza que deseja transcrever a escala do mês atual para o próximo mês? Isso substituirá a escala existente no próximo mês.')) {
                return;
            }

            const nextMonth = currentMonth === 11 ? 0 : currentMonth + 1;
            const nextYear = currentMonth === 11 ? currentYear + 1 : currentYear;

            const currentMonthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const nextMonthKey = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}`;

            const currentMonthScheduleSnapshot = monthlySchedulesData[currentMonthKey] || {};
            const newNextMonthSchedule = {};

            // Iterate over employees in the current month's snapshot
            for (const employeeId in currentMonthScheduleSnapshot) {
                if (currentMonthScheduleSnapshot.hasOwnProperty(employeeId)) {
                    const employeeDataForThisMonth = currentMonthScheduleSnapshot[employeeId];
                    
                    const newEmployeeScheduleEntry = {
                        siglas: {},
                        vacations: []
                    };

                    // Copy and shift existing vacations to the next month
                    if (employeeDataForThisMonth.vacations) {
                        employeeDataForThisMonth.vacations.forEach(vac => {
                            const newStartDate = addMonthsToDate(vac.start, 1);
                            const newEndDate = addMonthsToDate(vac.end, 1);
                            
                            newEmployeeScheduleEntry.vacations.push({
                                start: newStartDate.toISOString().split('T')[0],
                                end: newEndDate.toISOString().split('T')[0]
                            });
                        });
                    }

                    // Copy daily schedule (siglas)
                    if (employeeDataForThisMonth.siglas) {
                        for (const dateKey in employeeDataForThisMonth.siglas) {
                            if (employeeDataForThisMonth.siglas.hasOwnProperty(dateKey)) {
                                const siglasForCurrentDay = employeeDataForThisMonth.siglas[dateKey];
                                
                                const currentDayDate = new Date(dateKey + 'T00:00:00');
                                const nextMonthDate = addMonthsToDate(dateKey, 1);

                                // Ensure the day is valid for the next month
                                const maxDaysInNextMonth = getDaysInMonth(nextMonthDate.getFullYear(), nextMonthDate.getMonth());
                                let targetDay = nextMonthDate.getDate();
                                if (targetDay > maxDaysInNextMonth) {
                                    targetDay = maxDaysInNextMonth;
                                }

                                const nextMonthDateKey = `${nextMonthDate.getFullYear()}-${String(nextMonthDate.getMonth() + 1).padStart(2, '0')}-${String(targetDay).padStart(2, '0')}`;
                                
                                newEmployeeScheduleEntry.siglas[nextMonthDateKey] = Array.isArray(siglasForCurrentDay) ? [...siglasForCurrentDay] : [siglasForCurrentDay];
                            }
                        }
                    }
                    newNextMonthSchedule[employeeId] = newEmployeeScheduleEntry;
                }
            }

            monthlySchedulesData[nextMonthKey] = newNextMonthSchedule; // Overwrite or create next month's schedule
            monthlyObservations[nextMonthKey] = monthlyObservations[currentMonthKey] || ''; // Copy observations too

            saveAllData(); // Save all modified data
            currentMonth = nextMonth;
            currentYear = nextYear;
            renderSchedule();
            window.showMessageBox('Escala transcrita para o próximo mês!');
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Firebase
            if (firebaseConfig) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            // Sign in anonymously if no user is logged in
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                    userId = auth.currentUser.uid;
                                } else {
                                    const anonUser = await signInAnonymously(auth);
                                    userId = anonUser.user.uid;
                                }
                            } catch (error) {
                                console.error("Erro ao autenticar no Firebase:", error);
                                window.showMessageBox(`Erro de autenticação: ${error.message}`, 5000);
                                // Fallback to a random UUID if anonymous sign-in fails
                                userId = crypto.randomUUID();
                            }
                        }
                        isAuthReady = true;
                        // Load data only after auth is ready and userId is set
                        await loadEmployees(); // Load master employee list first
                        await loadMonthlySchedulesData(); // Then load monthly schedule data
                        await loadMonthlyObservations();
                        await loadCustomSiglas(); // Load custom siglas
                    });
                } catch (error) {
                    console.error("Erro ao inicializar Firebase:", error);
                    window.showMessageBox(`Erro ao inicializar o banco de dados: ${error.message}. Usando armazenamento local.`, 7000);
                    // Fallback to localStorage if Firebase initialization fails
                    userId = crypto.randomUUID(); // Generate a dummy userId for localStorage context
                    isAuthReady = true;
                    await loadEmployees();
                    await loadMonthlySchedulesData();
                    await loadMonthlyObservations();
                    await loadCustomSiglas(); // Load custom siglas
                }
            } else {
                // If no Firebase config, proceed with localStorage
                userId = crypto.randomUUID(); // Generate a dummy userId for localStorage context
                isAuthReady = true;
                await loadEmployees();
                await loadMonthlySchedulesData();
                await loadMonthlyObservations();
                await loadCustomSiglas(); // Load custom siglas
            }

            // Event listener for custom role field
            document.getElementById('employeeRole').addEventListener('change', function() {
                const customRoleField = document.getElementById('customEmployeeRole');
                if (this.value === 'Outro') {
                    customRoleField.classList.remove('hidden');
                } else {
                    customRoleField.classList.add('hidden');
                    customRoleField.value = ''; // Clear custom field if not 'Outro'
                }
            });


            document.getElementById('addEmployeeBtn').addEventListener('click', addEmployee);
            document.getElementById('prevMonth').addEventListener('click', () => {
                saveCurrentMonthSchedule(); // Save current month's changes before navigating
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderSchedule();
                loadMonthlyObservations(); // Reload observations for new month
            });
            document.getElementById('nextMonth').addEventListener('click', () => {
                saveCurrentMonthSchedule(); // Save current month's changes before navigating
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderSchedule();
                loadMonthlyObservations(); // Reload observations for new month
            });

            // Modified event listeners for sigla application based on context
            document.getElementById('applySiglaMonthBtn').addEventListener('click', applySiglaMonth);
            document.getElementById('clearSiglasMonthBtn').addEventListener('click', clearSiglasForMonth);
            document.getElementById('applySiglaDayBtn').addEventListener('click', applySiglaDay); // New button for single day sigla
            document.getElementById('clearSiglasDayBtn').addEventListener('click', clearSiglasForDay); // New button for clearing single day sigla

            // NEW: Multi-day sigla buttons
            document.getElementById('applyMultiDaySiglaBtn').addEventListener('click', applyMultiDaySigla);
            document.getElementById('clearMultiDaySiglaRangeBtn').addEventListener('click', clearMultiDaySiglaRange);


            document.getElementById('applyVacationBtn').addEventListener('click', applyVacation);
            document.getElementById('clearVacationBtn').addEventListener('click', clearVacation);
            document.getElementById('clearEmployeeScheduleBtn').addEventListener('click', clearEmployeeSchedule);
            document.getElementById('printScheduleBtn').addEventListener('click', printSchedule);
            document.getElementById('saveScheduleBtn').addEventListener('click', saveAllData); // Event listener for the new save button
            document.getElementById('monthlyObservations').addEventListener('input', saveMonthlyObservations);

            // New event listeners for Sigla Management Modal
            document.getElementById('manageSiglasBtn').addEventListener('click', window.openManageSiglasModal);
            document.getElementById('addCustomSiglaBtn').addEventListener('click', addCustomSigla);

            // New event listener for Copy Schedule Button
            document.getElementById('copyScheduleBtn').addEventListener('click', copyScheduleToNextMonth);

            // Initial render
            renderCurrentMonthYear();
            // Initial load for custom siglas moved to after Firebase auth status is known
        });
    </script>
</body>
</html>