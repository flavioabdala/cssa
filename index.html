<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala do Centro de Saúde</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text */
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .header {
            background-color: #4a90e2; /* Blue header */
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary {
            background-color: #4a90e2;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #357ABD;
        }
        .btn-secondary {
            background-color: #64748b; /* Gray */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .input-field {
            border: 1px solid #cbd5e1; /* Light gray border */
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }
        .schedule-table-container {
            overflow-x: auto;
            margin-top: 2rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure table doesn't get too small on narrow screens */
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #e2e8f0; /* Light gray table borders */
            padding: 0.5rem;
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping in cells */
        }
        .schedule-table th {
            background-color: #e2e8f0; /* Light gray header */
            font-weight: 600;
        }
        .schedule-table tbody tr:hover {
            background-color: #f8fafc; /* Lighter on hover */
        }
        .weekend, .holiday {
            background-color: #cbd5e1; /* Darker gray for weekends/holidays */
            color: #475569;
        }
        .vacation {
            background-color: #93c5fd; /* Light blue for vacations */
            color: #1e40af;
            font-weight: 600;
        }
        .printable-table {
            width: 100%;
            border-collapse: collapse;
        }
        .printable-table th, .printable-table td {
            border: 1px solid #000;
            padding: 4px;
            text-align: center;
            font-size: 10px;
        }
        .printable-table .weekend, .printable-table .holiday {
            background-color: #ccc;
        }
        .printable-table .vacation {
            background-color: #a7d9ff;
        }
        .printable-legend {
            font-size: 10px;
            margin-top: 20px;
            border-top: 1px solid #000;
            padding-top: 10px;
        }

        /* Team Colors */
        .team-sol { background-color: #FFD700; color: #333; } /* Gold */
        .team-verde { background-color: #32CD32; color: white; } /* LimeGreen */
        .team-vermelha { background-color: #FF4500; color: white; } /* OrangeRed */
        .team-azul { background-color: #1E90FF; color: white; } /* DodgerBlue */
        .team-laranja { background-color: #FFA500; color: #333; } /* Orange */
        .team-apoio { background-color: #D3D3D3; color: #333; } /* LightGray */


        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                overflow: hidden; /* Hide scrollbars */
            }
            .printable-header {
                text-align: center;
                margin-bottom: 10px;
                font-size: 14px;
            }
            .printable-table-container {
                width: 100%;
                overflow: visible; /* Allow table to expand */
            }
            .printable-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed; /* Fix table layout */
            }
            .printable-table th, .printable-table td {
                font-size: 8px; /* Smaller font for print */
                padding: 2px;
                white-space: normal; /* Allow wrapping for print */
            }
            /* Adjust column widths for print if needed */
            .printable-table th:nth-child(1) { width: 12%; } /* Nome */
            .printable-table th:nth-child(2) { width: 7%; } /* Função */
            .printable-table th:nth-child(3) { width: 9%; } /* Conselho */
            .printable-table th:nth-child(4) { width: 7%; } /* Horário de Trabalho */
            /* Calculate remaining width for days dynamically using CSS variable */
            .printable-table th:nth-child(n+5) { width: calc(65% / var(--days-in-month)); }

            .printable-footer {
                position: fixed;
                bottom: 20px;
                left: 0;
                width: 100%;
                text-align: center;
                font-size: 10px;
            }
        }
    </style>
</head>
<body class="p-4">
    <!-- Authentication Section -->
    <div id="authSection" class="container text-center py-10">
        <h2 id="authTitle" class="text-3xl font-bold mb-6 text-blue-700">Login</h2>
        <div class="mb-4">
            <input type="email" id="authEmail" placeholder="E-mail" class="input-field max-w-sm mx-auto mb-3">
            <input type="password" id="authPassword" placeholder="Senha" class="input-field max-w-sm mx-auto mb-3">
        </div>
        <button id="loginBtn" class="btn-primary px-8 py-3 mr-2">Entrar</button>
        <button id="registerBtn" class="btn-secondary px-8 py-3">Cadastrar</button>
        <p id="authMessage" class="text-red-500 mt-4"></p>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-button" onclick="window.closeRegistrationModal()">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-blue-700">Cadastro Completo</h3>
            <div class="space-y-4">
                <input type="text" id="regFullName" placeholder="Nome Completo" class="input-field">
                <input type="text" id="regCPF" placeholder="CPF" class="input-field">
                <input type="date" id="regDateOfBirth" placeholder="Data de Nascimento" class="input-field">
                <input type="email" id="regEmail" placeholder="E-mail" class="input-field">
                <input type="password" id="regPassword" placeholder="Senha" class="input-field">
                <input type="password" id="regPasswordConfirm" placeholder="Confirmar Senha" class="input-field">
            </div>
            <button id="completeRegisterBtn" class="btn-primary w-full mt-6">Finalizar Cadastro</button>
            <p id="regMessage" class="text-red-500 mt-4"></p>
        </div>
    </div>

    <!-- Main Application Content -->
    <div id="appContent" class="container hidden">
        <div class="header">
            <h1 class="text-3xl font-bold mb-2">Escala do Centro de Saúde</h1>
            <p class="text-lg">Gerencie a escala da sua equipe de forma fácil e eficiente.</p>
            <div class="mt-4 flex justify-center items-center">
                <span id="userStatus" class="text-sm font-medium mr-4"></span>
                <button id="logoutBtn" class="btn-secondary px-4 py-2">Sair</button>
            </div>
        </div>

        <!-- Month Navigation -->
        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="btn-secondary px-4 py-2 rounded-lg">&lt; Mês Anterior</button>
            <h2 id="currentMonthYear" class="text-2xl font-semibold text-gray-700"></h2>
            <button id="nextMonth" class="btn-secondary px-4 py-2 rounded-lg">Próximo Mês &gt;</button>
        </div>

        <!-- Employee Management Section (Admin Only) -->
        <div id="employeeManagementSection" class="bg-blue-50 p-6 rounded-lg shadow-md mb-8 admin-only">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">Gerenciamento de Funcionários</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="employeeName" placeholder="Nome do Funcionário" class="input-field">
                <select type="text" id="employeeRole" class="input-field">
                    <option value="">Selecione a Função</option>
                    <option value="Técnico">Técnico</option>
                    <option value="Enfermeiro">Enfermeiro</option>
                    <option value="Outro">Outro</option>
                </select>
                <input type="text" id="customEmployeeRole" placeholder="Função Personalizada" class="input-field hidden">
                <input type="text" id="employeeCouncil" placeholder="Registro do Conselho" class="input-field">
                <input type="text" id="employeeWorkShift" placeholder="Horário de Trabalho (Ex: 08h-17h)" class="input-field">
            </div>
            <div class="mb-4">
                <label for="employeeTeam" class="block text-sm font-medium text-gray-700 mb-1">Equipe:</label>
                <select type="text" id="employeeTeam" class="input-field">
                    <option value="">Selecione a Equipe</option>
                    <option value="Sol">Sol</option>
                    <option value="Verde">Verde</option>
                    <option value="Vermelha">Vermelha</option>
                    <option value="Azul">Azul</option>
                    <option value="Laranja">Laranja</option>
                    <option value="Apoio">Apoio</option>
                </select>
            </div>
            <button id="addEmployeeBtn" class="btn-primary w-full md:w-auto">Adicionar Funcionário</button>

            <div id="employeeList" class="mt-6">
                <h4 class="text-lg font-medium mb-3 text-gray-700">Funcionários Cadastrados:</h4>
                <ul id="employeesUl" class="space-y-2">
                    <!-- Employee items will be dynamically added here -->
                </ul>
            </div>
        </div>

        <!-- Schedule Table -->
        <div class="schedule-table-container">
            <table id="scheduleTable" class="schedule-table">
                <thead>
                    <tr id="scheduleHeader">
                        <th class="w-1/6">Nome</th>
                        <th class="w-1/12">Função</th>
                        <th class="w-1/12">Conselho</th>
                        <th class="w-1/12">Horário de Trabalho</th>
                        <!-- Days of the month will be added here by JS -->
                    </tr>
                </thead>
                <tbody id="scheduleBody">
                    <!-- Employee rows and schedule will be added here by JS -->
                </tbody>
            </table>
        </div>

        <!-- Observations Section (Admin Only for input, Visible for all) -->
        <div class="bg-blue-50 p-6 rounded-lg shadow-md mt-8">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">Observações Mensais</h3>
            <textarea id="monthlyObservations" class="input-field h-32 resize-y" placeholder="Adicione observações importantes para este mês..." readonly></textarea>
        </div>

        <!-- Action Buttons (Admin Only for Save/Copy) -->
        <div class="flex justify-center mt-8 space-x-4">
            <button id="printScheduleBtn" class="btn-primary">Imprimir Escala</button>
            <button id="saveScheduleBtn" class="btn-primary admin-only">Salvar Escala</button>
            <button id="copyToNextMonthBtn" class="btn-primary admin-only">Transcrever para o Mês Seguinte</button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Sigla/Vacation Modal -->
    <div id="siglaVacationModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-button" onclick="window.closeSiglaVacationModal()">&times;</button>
            <h3 id="modalEmployeeName" class="text-2xl font-bold mb-4 text-blue-700"></h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Sigla Section - General (for month) -->
                <div id="siglaSectionMonth" class="bg-gray-50 p-4 rounded-lg shadow-sm admin-only">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar Sigla(s) para o Mês</h4>
                    <div class="mb-4 space-y-2" id="siglaCheckboxesMonth">
                        <!-- Sigla checkboxes will be generated here -->
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="F" class="mr-2"> F (Farmácia)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="S" class="mr-2"> S (Sala de Observação)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="P" class="mr-2"> P (Presente)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="CT" class="mr-2"> CT (Curativo)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="BR" class="mr-2"> BR (Acolhimento Baixo Risco)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="E" class="mr-2"> E (ECG)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="V" class="mr-2"> V (Vacina)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="T" class="mr-2"> T (Totem)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaMonth" value="C" class="mr-2"> C (Consultórios)</label>
                    </div>
                    <button id="applySiglaMonthBtn" class="btn-primary w-full">Aplicar Sigla(s) para o Mês</button>
                    <button id="clearSiglasMonthBtn" class="btn-secondary w-full mt-2">Limpar Siglas do Mês</button>
                </div>

                <!-- Sigla Section - Specific Day (for FO/LM) (Admin Only) -->
                <div id="siglaSectionDay" class="bg-gray-50 p-4 rounded-lg shadow-sm hidden admin-only">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar Sigla(s) para o Dia <span id="modalDayNumber"></span></h4>
                    <div class="mb-4 space-y-2" id="siglaCheckboxesDay">
                        <label class="flex items-center"><input type="checkbox" name="siglaDay" value="FO" class="mr-2"> FO (Folga)</label>
                        <label class="flex items-center"><input type="checkbox" name="siglaDay" value="LM" class="mr-2"> LM (Licença Médica)</label>
                        <!-- Other siglas can be added here if needed for single day -->
                    </div>
                    <button id="applySiglaDayBtn" class="btn-primary w-full">Aplicar Sigla(s) para o Dia</button>
                    <button id="clearSiglasDayBtn" class="btn-secondary w-full mt-2">Limpar Siglas do Dia</button>
                </div>

                <!-- Vacation Section (Admin Only) -->
                <div id="vacationSection" class="bg-gray-50 p-4 rounded-lg shadow-sm admin-only">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar Férias</h4>
                    <div class="mb-4">
                        <label for="vacationStart" class="block text-sm font-medium text-gray-700 mb-1">Início das Férias:</label>
                        <input type="date" id="vacationStart" class="input-field">
                    </div>
                    <div class="mb-4">
                        <label for="vacationEnd" class="block text-sm font-medium text-gray-700 mb-1">Fim das Férias:</label>
                        <input type="date" id="vacationEnd" class="input-field">
                    </div>
                    <button id="applyVacationBtn" class="btn-primary w-full">Aplicar Férias</button>
                    <button id="clearVacationBtn" class="btn-secondary w-full mt-2">Limpar Férias</button>
                </div>
            </div>
            <button id="clearEmployeeScheduleBtn" class="btn-danger w-full mt-6 admin-only">Limpar Toda a Escala do Funcionário</button>
        </div>
    </div>

    <!-- Message Box (for alerts) -->
    <div id="messageBox" class="fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg hidden z-2000">
        <p id="messageText"></p>
        <button class="ml-4 text-white font-bold" onclick="window.hideMessageBox()">&times;</button>
    </div>

    <script type="module">
        // Global variables for Firebase configuration and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        let currentUserRole = 'guest'; // 'guest', 'user', 'admin'
        let isAuthReady = false;

        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let employees = [];
        let currentEditingEmployeeId = null;
        let currentEditingDateKey = null; // Stores the date key if a specific day is being edited
        let monthlyObservations = {}; // Stores observations per month/year

        // Brazilian National Holidays (example for 2025)
        const nationalHolidays = [
            '2025-01-01', // Confraternização Universal
            '2025-03-03', // Carnaval (Monday)
            '2025-03-04', // Carnaval (Tuesday)
            '2025-04-18', // Paixão de Cristo
            '2025-04-21', // Tiradentes
            '2025-05-01', // Dia do Trabalho
            '2025-06-19', // Corpus Christi
            '2025-09-07', // Independência do Brasil
            '2025-10-12', // Nossa Senhora Aparecida
            '2025-11-02', // Finados
            '2025-11-15', // Proclamação da República
            '2025-12-25'  // Natal
        ];

        // --- Utility Functions ---

        // Make functions globally accessible for inline HTML event handlers
        window.showMessageBox = function(message, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            document.getElementById('messageText').textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                window.hideMessageBox();
            }, duration);
        }

        window.hideMessageBox = function() {
            document.getElementById('messageBox').classList.add('hidden');
        }

        /**
         * Updates the visibility of admin-only elements based on the current user's role.
         */
        function updateAdminUI() {
            const adminElements = document.querySelectorAll('.admin-only');
            if (currentUserRole === 'admin') {
                adminElements.forEach(el => el.classList.remove('hidden'));
                document.getElementById('monthlyObservations').removeAttribute('readonly'); // Admin can edit observations
            } else {
                adminElements.forEach(el => el.classList.add('hidden'));
                document.getElementById('monthlyObservations').setAttribute('readonly', true); // Non-admin cannot edit observations
            }
        }

        /**
         * Handles user authentication state changes.
         * @param {firebase.User} user - The authenticated Firebase user object.
         */
        async function handleAuthStateChanged(user) {
            console.log("handleAuthStateChanged called with user:", user ? user.uid : "null");
            const authSection = document.getElementById('authSection');
            const appContent = document.getElementById('appContent');
            const userStatus = document.getElementById('userStatus');

            if (user) {
                userId = user.uid;
                userStatus.textContent = `Logado como: ${user.email} (ID: ${userId})`;
                appContent.classList.remove('hidden');
                authSection.classList.add('hidden');

                // Fetch user role from Firestore
                const userDocRef = doc(db, 'users', userId);
                try {
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        currentUserRole = userDocSnap.data().role || 'user'; // Default to 'user' if role not set
                        console.log("User role fetched from Firestore:", currentUserRole);
                    } else {
                        // If user document doesn't exist, create it with 'user' role
                        // This happens on first login after registration
                        // (This case is now less likely as registration modal handles initial user doc creation)
                        console.log("User document not found, creating with default 'user' role.");
                        await setDoc(userDocRef, { email: user.email, role: 'user', uid: userId });
                        currentUserRole = 'user';
                    }
                } catch (error) {
                    console.error("Erro ao carregar/criar documento do usuário:", error);
                    currentUserRole = 'user'; // Fallback
                    window.showMessageBox("Erro ao carregar perfil do usuário. Tente novamente.", 5000);
                }
            } else {
                console.log("User is null, setting to guest mode.");
                userId = null;
                currentUserRole = 'guest';
                userStatus.textContent = '';
                appContent.classList.add('hidden');
                authSection.classList.remove('hidden');
            }
            updateAdminUI(); // Update UI based on new role
            isAuthReady = true;
            loadEmployees(); // Load data after auth state is determined
            loadMonthlyObservations();
        }

        // --- Authentication Functions ---

        // Function to open the full registration modal
        window.openRegistrationModal = function() {
            console.log("Opening registration modal...");
            document.getElementById('registrationModal').classList.remove('hidden');
            // Clear previous messages and fields
            document.getElementById('regMessage').textContent = '';
            document.getElementById('regFullName').value = '';
            document.getElementById('regCPF').value = '';
            document.getElementById('regDateOfBirth').value = '';
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regPasswordConfirm').value = '';
        }

        // Function to close the full registration modal
        window.closeRegistrationModal = function() {
            console.log("Closing registration modal...");
            document.getElementById('registrationModal').classList.add('hidden');
        }

        async function completeRegistration() {
            console.log("Attempting complete registration...");
            const fullName = document.getElementById('regFullName').value.trim();
            const cpf = document.getElementById('regCPF').value.trim();
            const dateOfBirth = document.getElementById('regDateOfBirth').value;
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            const passwordConfirm = document.getElementById('regPasswordConfirm').value;
            const regMessage = document.getElementById('regMessage');

            if (!fullName || !cpf || !dateOfBirth || !email || !password || !passwordConfirm) {
                regMessage.textContent = 'Por favor, preencha todos os campos.';
                console.log("Registration failed: Missing fields.");
                return;
            }

            if (password !== passwordConfirm) {
                regMessage.textContent = 'As senhas não coincidem.';
                console.log("Registration failed: Passwords do not match.");
                return;
            }

            if (password.length < 6) {
                regMessage.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                console.log("Registration failed: Password too short.");
                return;
            }

            try {
                console.log(`Creating user with email: ${email}`);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log("User created in Firebase Auth:", userCredential.user.uid);

                // Create user document in Firestore with detailed info and default 'user' role
                await setDoc(doc(db, 'users', userCredential.user.uid), {
                    uid: userCredential.user.uid,
                    email: userCredential.user.email,
                    fullName: fullName,
                    cpf: cpf,
                    dateOfBirth: dateOfBirth,
                    role: 'user' // Default role
                });
                console.log("User profile saved to Firestore.");
                regMessage.textContent = 'Cadastro realizado com sucesso! Você pode fazer o login agora.';
                window.showMessageBox('Cadastro realizado com sucesso! Faça o login.', 4000);
                window.closeRegistrationModal();
            } catch (error) {
                console.error("Erro no cadastro completo:", error);
                regMessage.textContent = `Erro no cadastro: ${error.message}`;
            }
        }


        async function loginUser() {
            console.log("Attempting login...");
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const authMessage = document.getElementById('authMessage');

            if (!email || !password) {
                authMessage.textContent = 'Por favor, preencha e-mail e senha.';
                console.log("Login failed: Missing email or password.");
                return;
            }

            try {
                console.log(`Signing in with email: ${email}`);
                await signInWithEmailAndPassword(auth, email, password);
                console.log("Login successful.");
                authMessage.textContent = ''; // Clear message on success
            } catch (error) {
                console.error("Erro no login:", error);
                authMessage.textContent = `Erro no login: ${error.message}`;
            }
        }

        async function logoutUser() {
            console.log("Attempting logout...");
            try {
                await signOut(auth);
                console.log("Logout successful.");
                window.showMessageBox('Você foi desconectado.');
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                window.showMessageBox(`Erro ao fazer logout: ${error.message}`);
            }
        }


        function saveEmployees() {
            // Only allow admin to save employees
            if (currentUserRole !== 'admin') {
                console.warn("Apenas administradores podem salvar funcionários.");
                return;
            }
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/shared_schedule`, 'employees');
                setDoc(docRef, { data: JSON.stringify(employees) })
                    .catch(error => console.error("Erro ao salvar funcionários no Firestore:", error));
            } else {
                // Fallback to localStorage if Firebase is not initialized (should not happen for saving if auth is required)
                localStorage.setItem('healthScheduleEmployees', JSON.stringify(employees));
            }
        }

        async function loadEmployees() {
            console.log("Loading employees...");
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/shared_schedule`, 'employees');
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        employees = JSON.parse(docSnap.data().data);
                        console.log("Employees loaded from Firestore.");
                    } else {
                        employees = [];
                        console.log("No employees document found in Firestore.");
                    }
                } catch (error) {
                    console.error("Erro ao carregar funcionários do Firestore:", error);
                    employees = [];
                }
            } else {
                console.log("Firebase not ready or user not authenticated, loading employees from localStorage.");
                // If not authenticated or Firebase not ready, load from localStorage (for initial dev/fallback)
                const storedEmployees = localStorage.getItem('healthScheduleEmployees');
                employees = storedEmployees ? JSON.parse(storedEmployees) : [];
            }
            renderEmployeeList();
            renderSchedule();
        }

        function saveMonthlyObservations() {
            // Only allow admin to save observations
            if (currentUserRole !== 'admin') {
                console.warn("Apenas administradores podem salvar observações.");
                return;
            }
            const key = `${currentYear}-${currentMonth + 1}`;
            monthlyObservations[key] = document.getElementById('monthlyObservations').value;
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/shared_schedule`, 'observations');
                setDoc(docRef, { data: JSON.stringify(monthlyObservations) })
                    .catch(error => console.error("Erro ao salvar observações no Firestore:", error));
            } else {
                localStorage.setItem('healthScheduleObservations', JSON.stringify(monthlyObservations));
            }
        }

        async function loadMonthlyObservations() {
            console.log("Loading monthly observations...");
            if (userId && db) {
                const docRef = doc(db, `artifacts/${appId}/shared_schedule`, 'observations');
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        monthlyObservations = JSON.parse(docSnap.data().data);
                        console.log("Monthly observations loaded from Firestore.");
                    } else {
                        monthlyObservations = {};
                        console.log("No monthly observations document found in Firestore.");
                    }
                } catch (error) {
                    console.error("Erro ao carregar observações do Firestore:", error);
                    monthlyObservations = {};
                }
            } else {
                console.log("Firebase not ready or user not authenticated, loading monthly observations from localStorage.");
                const storedObservations = localStorage.getItem('healthScheduleObservations');
                monthlyObservations = storedObservations ? JSON.parse(storedObservations) : {};
            }
            const key = `${currentYear}-${currentMonth + 1}`;
            document.getElementById('monthlyObservations').value = monthlyObservations[key] || '';
        }

        // New function to save both employees and observations
        function saveAllData() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem salvar a escala.', 3000);
                return;
            }
            console.log("Saving all data (employees and observations)...");
            saveEmployees();
            saveMonthlyObservations();
            window.showMessageBox('Escala salva com sucesso!');
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function isWeekend(year, month, day) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6; // Sunday (0) or Saturday (6)
        }

        function isHoliday(year, month, day) {
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            return nationalHolidays.includes(dateString);
        }

        function isVacation(employee, year, month, day) {
            const currentDate = new Date(year, month, day);
            if (!employee.vacations) return false;

            for (const vacation of employee.vacations) {
                const startDate = new Date(vacation.start);
                const endDate = new Date(vacation.end);
                // Set hours to 0 to compare only dates
                startDate.setHours(0,0,0,0);
                endDate.setHours(0,0,0,0);
                currentDate.setHours(0,0,0,0);

                if (currentDate >= startDate && currentDate <= endDate) {
                    return true;
                }
            }
            return false;
        }

        // --- Render Functions ---

        function renderCurrentMonthYear() {
            const date = new Date(currentYear, currentMonth);
            document.getElementById('currentMonthYear').textContent = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
        }

        function getTeamColorClass(team) {
            switch (team) {
                case 'Sol': return 'team-sol';
                case 'Verde': return 'team-verde';
                case 'Vermelha': return 'team-vermelha';
                case 'Azul': return 'team-azul';
                case 'Laranja': return 'team-laranja';
                case 'Apoio': return 'team-apoio';
                default: return '';
            }
        }

        function sortEmployeesByRole(empArray) {
            // Sort by role: Técnicos first, then Enfermeiros, then others alphabetically
            return [...empArray].sort((a, b) => {
                const roleA = a.role.toLowerCase();
                const roleB = b.role.toLowerCase();

                // Prioritize "Técnico"
                if (roleA.includes('técnico') && !roleB.includes('técnico')) return -1;
                if (!roleA.includes('técnico') && roleB.includes('técnico')) return 1;

                // Then "Enfermeiro"
                if (roleA.includes('enfermeiro') && !roleB.includes('enfermeiro')) return -1;
                if (!roleA.includes('enfermeiro') && roleB.includes('enfermeiro')) return 1;

                // Finally, sort by name for other roles or same role type
                return a.name.localeCompare(b.name);
            });
        }

        function renderEmployeeList() {
            console.log("Rendering employee list...");
            const employeesUl = document.getElementById('employeesUl');
            employeesUl.innerHTML = '';
            if (employees.length === 0) {
                employeesUl.innerHTML = '<li class="text-gray-500">Nenhum funcionário cadastrado.</li>';
                return;
            }

            const sortedEmployees = sortEmployeesByRole(employees);

            sortedEmployees.forEach(emp => {
                const li = document.createElement('li');
                const teamColorClass = getTeamColorClass(emp.team);
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm border border-gray-200';
                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-medium text-blue-600 cursor-pointer" onclick="window.openSiglaVacationModal('${emp.id}')">${emp.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(${emp.role} - ${emp.council} - ${emp.workShift})</span>
                        <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${teamColorClass} ml-2">${emp.team}</span>
                        <span class="text-xs text-gray-400 block break-all">ID: ${emp.id}</span>
                    </div>
                    <div>
                        <button onclick="window.deleteEmployee('${emp.id}')" class="btn-danger ml-2 admin-only">Excluir</button>
                    </div>
                `;
                employeesUl.appendChild(li);
            });
            updateAdminUI(); // Update UI after rendering list
        }

        function renderSchedule() {
            console.log("Rendering schedule...");
            renderCurrentMonthYear();
            const scheduleHeader = document.getElementById('scheduleHeader');
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleHeader.innerHTML = `
                <th class="w-1/6">Nome</th>
                <th class="w-1/12">Função</th>
                <th class="w-1/12">Conselho</th>
                <th class="w-1/12">Horário de Trabalho</th>
            `;
            scheduleBody.innerHTML = '';

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);

            // Add day headers
            for (let i = 1; i <= daysInMonth; i++) {
                const th = document.createElement('th');
                const date = new Date(currentYear, currentMonth, i);
                const dayOfWeek = date.getDay(); // 0 for Sunday, 6 for Saturday
                th.textContent = i;
                if (isWeekend(currentYear, currentMonth, i) || isHoliday(currentYear, currentMonth, i)) {
                    th.classList.add('weekend');
                }
                scheduleHeader.appendChild(th);
            }

            const sortedEmployees = sortEmployeesByRole(employees);

            // Add employee rows
            sortedEmployees.forEach(emp => {
                const tr = document.createElement('tr');
                const teamColorClass = getTeamColorClass(emp.team);
                tr.innerHTML = `
                    <td class="font-medium text-blue-600 cursor-pointer ${teamColorClass}" onclick="window.openSiglaVacationModal('${emp.id}')">
                        ${emp.name} <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold">${emp.team}</span>
                    </td>
                    <td>${emp.role}</td>
                    <td>${emp.council}</td>
                    <td>${emp.workShift || ''}</td> <!-- Display work shift -->
                `;
                for (let i = 1; i <= daysInMonth; i++) {
                    const td = document.createElement('td');
                    const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    td.setAttribute('data-employee-id', emp.id); // Add data attribute for employee ID
                    td.setAttribute('data-date-key', dateKey); // Add data attribute for date key
                    
                    // Only allow click on day cells if user is admin
                    if (currentUserRole === 'admin') {
                        td.onclick = function() { window.openSiglaVacationModal(emp.id, dateKey); }; // Click handler for day cells
                    } else {
                        td.style.cursor = 'default'; // Change cursor for non-admin
                    }

                    if (isVacation(emp, currentYear, currentMonth, i)) {
                        td.classList.add('vacation');
                        td.textContent = 'FÉRIAS';
                        // Merge cells for vacation if it's the start of a vacation block
                        const nextDayIsVacation = isVacation(emp, currentYear, currentMonth, i + 1);
                        const prevDayIsVacation = isVacation(emp, currentYear, currentMonth, i - 1);

                        if (!prevDayIsVacation && isVacation(emp, currentYear, currentMonth, i)) {
                            let span = 1;
                            let j = i + 1;
                            while (j <= daysInMonth && isVacation(emp, currentYear, currentMonth, j)) {
                                span++;
                                j++;
                            }
                            td.colSpan = span;
                            tr.appendChild(td);
                            i += (span - 1); // Skip merged days
                        } else if (prevDayIsVacation && isVacation(emp, currentYear, currentMonth, i)) {
                            // Do nothing, this cell was already merged
                        } else {
                            tr.appendChild(td);
                        }
                    } else {
                        // Display multiple siglas joined by comma
                        const siglas = emp.schedule && emp.schedule[dateKey] ? emp.schedule[dateKey] : [];
                        td.textContent = Array.isArray(siglas) ? siglas.join(', ') : siglas; // Handle old string format if any
                        if (isWeekend(currentYear, currentMonth, i) || isHoliday(currentYear, currentMonth, i)) {
                            td.classList.add('weekend');
                        }
                        tr.appendChild(td);
                    }
                }
                scheduleBody.appendChild(tr);
            });
            loadMonthlyObservations(); // Load observations for the rendered month
            updateAdminUI(); // Update UI after rendering schedule
        }

        // --- Employee Actions ---

        function addEmployee() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem adicionar funcionários.', 3000);
                return;
            }
            console.log("Attempting to add employee...");
            const name = document.getElementById('employeeName').value.trim();
            let role = document.getElementById('employeeRole').value.trim();
            const customRole = document.getElementById('customEmployeeRole').value.trim();
            const council = document.getElementById('employeeCouncil').value.trim();
            const workShift = document.getElementById('employeeWorkShift').value.trim();
            const team = document.getElementById('employeeTeam').value.trim();

            if (role === 'Outro') {
                role = customRole; // Use custom role if "Outro" is selected
            }

            if (name && role && council && workShift && team) {
                const newEmployee = {
                    id: crypto.randomUUID(), // Unique ID for each employee
                    name,
                    role,
                    council,
                    workShift,
                    team, // Add team to employee object
                    schedule: {}, // { 'YYYY-MM-DD': ['SIGLA1', 'SIGLA2'] }
                    vacations: [] // [{ start: 'YYYY-MM-DD', end: 'YYYY-MM-DD' }]
                };
                employees.push(newEmployee);
                saveEmployees();
                renderEmployeeList();
                renderSchedule();
                document.getElementById('employeeName').value = '';
                document.getElementById('employeeRole').value = '';
                document.getElementById('customEmployeeRole').value = ''; // Clear custom role field
                document.getElementById('customEmployeeRole').classList.add('hidden'); // Hide custom role field
                document.getElementById('employeeCouncil').value = '';
                document.getElementById('employeeWorkShift').value = '';
                document.getElementById('employeeTeam').value = '';
                window.showMessageBox('Funcionário adicionado com sucesso!');
                console.log("Employee added:", newEmployee);
            } else {
                window.showMessageBox('Por favor, preencha todos os campos do funcionário.', 4000);
                console.log("Failed to add employee: Missing fields.");
            }
        }

        window.deleteEmployee = function(id) {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem excluir funcionários.', 3000);
                return;
            }
            console.log("Attempting to delete employee:", id);
            if (window.confirm('Tem certeza que deseja excluir este funcionário?')) {
                employees = employees.filter(emp => emp.id !== id);
                saveEmployees();
                renderEmployeeList();
                renderSchedule();
                window.showMessageBox('Funcionário excluído.');
                console.log("Employee deleted.");
            }
        }

        // --- Modal Functions ---

        window.openSiglaVacationModal = function(employeeId, dateKey = null) {
            console.log(`Opening Sigla/Vacation modal for employee: ${employeeId}, date: ${dateKey}`);
            currentEditingEmployeeId = employeeId;
            currentEditingDateKey = dateKey; // Store the dateKey
            const employee = employees.find(emp => emp.id === employeeId);
            if (employee) {
                document.getElementById('modalEmployeeName').textContent = `Editar Escala de: ${employee.name}`;
                document.getElementById('siglaVacationModal').classList.remove('hidden');
                // Reset form fields
                document.getElementById('vacationStart').value = '';
                document.getElementById('vacationEnd').value = '';

                const siglaSectionMonth = document.getElementById('siglaSectionMonth');
                const siglaSectionDay = document.getElementById('siglaSectionDay');
                const modalDayNumber = document.getElementById('modalDayNumber');

                // Hide/show sections based on admin role
                if (currentUserRole !== 'admin') {
                    siglaSectionMonth.classList.add('hidden');
                    siglaSectionDay.classList.add('hidden');
                    document.getElementById('vacationSection').classList.add('hidden'); // Hide vacation section for non-admin
                    document.getElementById('clearEmployeeScheduleBtn').classList.add('hidden'); // Hide clear all button for non-admin
                    window.showMessageBox('Você não tem permissão para editar a escala.', 3000);
                    console.log("Non-admin attempting to open edit modal, denied.");
                    return; // Prevent modal from opening for non-admin if they click on an editable area
                } else {
                    siglaSectionMonth.classList.remove('hidden'); // Ensure it's visible for admin
                    document.getElementById('vacationSection').classList.remove('hidden');
                    document.getElementById('clearEmployeeScheduleBtn').classList.remove('hidden');
                }


                if (currentEditingDateKey) {
                    // Editing a specific day
                    siglaSectionMonth.classList.add('hidden');
                    siglaSectionDay.classList.remove('hidden');
                    modalDayNumber.textContent = currentEditingDateKey.split('-')[2]; // Extract day number
                    console.log("Editing specific day:", currentEditingDateKey);

                    // Pre-check siglas for the specific day
                    const checkboxesDay = document.querySelectorAll('#siglaCheckboxesDay input[type="checkbox"]');
                    checkboxesDay.forEach(cb => cb.checked = false); // Uncheck all first

                    const siglasForDay = employee.schedule && employee.schedule[currentEditingDateKey] ? employee.schedule[currentEditingDateKey] : [];
                    if (Array.isArray(siglasForDay)) {
                        siglasForDay.forEach(sigla => {
                            const checkbox = document.querySelector(`#siglaCheckboxesDay input[value="${sigla}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    } else if (typeof siglasForDay === 'string' && siglasForDay !== '') {
                        // Handle old string format: treat as a single sigla
                        const checkbox = document.querySelector(`#siglaCheckboxesDay input[value="${siglasForDay}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    }

                } else {
                    // Editing general monthly schedule (from employee name click)
                    siglaSectionMonth.classList.remove('hidden');
                    siglaSectionDay.classList.add('hidden');
                    console.log("Editing general monthly schedule.");

                    // Clear and pre-check siglas based on current month's schedule for this employee
                    const checkboxesMonth = document.querySelectorAll('#siglaCheckboxesMonth input[type="checkbox"]');
                    checkboxesMonth.forEach(cb => cb.checked = false); // Uncheck all first

                    const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                    const currentMonthSiglas = new Set(); // Use a Set to store unique siglas for the month

                    for (let i = 1; i <= daysInMonth; i++) {
                        const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        const siglasForDay = employee.schedule && employee.schedule[dateKey] ? employee.schedule[dateKey] : [];
                        if (Array.isArray(siglasForDay)) {
                            // Exclude FO and LM from general month view pre-check
                            siglasForDay.filter(s => s !== 'FO' && s !== 'LM').forEach(sigla => currentMonthSiglas.add(sigla));
                        } else if (typeof siglasForDay === 'string' && siglasForDay !== '' && siglasForDay !== 'FO' && siglasForDay !== 'LM') {
                            // Handle old string format: treat as a single sigla
                            currentMonthSiglas.add(siglasForDay);
                        }
                    }

                    currentMonthSiglas.forEach(sigla => {
                        const checkbox = document.querySelector(`#siglaCheckboxesMonth input[value="${sigla}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
            }
        }

        window.closeSiglaVacationModal = function() {
            console.log("Closing Sigla/Vacation modal.");
            document.getElementById('siglaVacationModal').classList.add('hidden');
            currentEditingEmployeeId = null;
            currentEditingDateKey = null; // Clear the dateKey
        }

        function applySiglaMonth() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem aplicar siglas.', 3000);
                return;
            }
            console.log("Applying monthly siglas...");
            const selectedSiglas = Array.from(document.querySelectorAll('#siglaCheckboxesMonth input[type="checkbox"]:checked')).map(cb => cb.value);

            if (selectedSiglas.length === 0) {
                window.showMessageBox('Por favor, selecione ao menos uma sigla.', 3000);
                return;
            }

            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;

            const employee = employees[employeeIndex];
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);

            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                if (!isWeekend(currentYear, currentMonth, i) && !isHoliday(currentYear, currentMonth, i) && !isVacation(employee, currentYear, currentMonth, i)) {
                    // Preserve FO/LM if they were set for a specific day
                    const existingSiglas = employee.schedule[dateKey] || [];
                    const preservedSiglas = Array.isArray(existingSiglas) ? existingSiglas.filter(s => s === 'FO' || s === 'LM') : [];
                    employee.schedule[dateKey] = [...new Set([...preservedSiglas, ...selectedSiglas])]; // Combine and remove duplicates
                }
            }
            saveEmployees();
            renderSchedule();
            window.showMessageBox('Sigla(s) aplicada(s) para os dias úteis do mês.');
            window.closeSiglaVacationModal();
            console.log("Monthly siglas applied.");
        }

        function clearSiglasForMonth() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem limpar siglas.', 3000);
                return;
            }
            console.log("Clearing monthly siglas...");
            if (window.confirm('Tem certeza que deseja limpar TODAS as siglas deste funcionário para o mês atual?')) {
                const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
                if (employeeIndex === -1) return;

                const employee = employees[employeeIndex];
                const daysInMonth = getDaysInMonth(currentYear, currentMonth);

                for (let i = 1; i <= daysInMonth; i++) {
                    const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    if (employee.schedule && employee.schedule[dateKey]) {
                        // Only clear non-FO/LM siglas
                        const existingSiglas = employee.schedule[dateKey] || [];
                        const preservedSiglas = Array.isArray(existingSiglas) ? existingSiglas.filter(s => s === 'FO' || s === 'LM') : [];
                        if (preservedSiglas.length > 0) {
                            employee.schedule[dateKey] = preservedSiglas;
                        } else {
                            delete employee.schedule[dateKey];
                        }
                    }
                }
                saveEmployees();
                renderSchedule();
                window.showMessageBox('Siglas do funcionário para o mês atual limpas.');
                window.closeSiglaVacationModal();
                console.log("Monthly siglas cleared.");
            }
        }

        function applySiglaDay() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem aplicar siglas.', 3000);
                return;
            }
            console.log("Applying daily siglas...");
            const selectedSiglas = Array.from(document.querySelectorAll('#siglaCheckboxesDay input[type="checkbox"]:checked')).map(cb => cb.value);

            if (selectedSiglas.length === 0) {
                window.showMessageBox('Por favor, selecione ao menos uma sigla.', 3000);
                return;
            }
            if (!currentEditingDateKey) {
                window.showMessageBox('Erro: Dia não selecionado para aplicar sigla.', 3000);
                return;
            }

            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;

            const employee = employees[employeeIndex];

            // For single day, we replace existing siglas with selected ones.
            employee.schedule[currentEditingDateKey] = selectedSiglas;

            saveEmployees();
            renderSchedule();
            window.showMessageBox(`Sigla(s) aplicada(s) para o dia ${currentEditingDateKey.split('-')[2]}.`);
            window.closeSiglaVacationModal();
            console.log("Daily siglas applied.");
        }

        function clearSiglasForDay() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem limpar siglas.', 3000);
                return;
            }
            console.log("Clearing daily siglas...");
             if (!currentEditingDateKey) {
                window.showMessageBox('Erro: Dia não selecionado para limpar sigla.', 3000);
                return;
            }
            if (window.confirm(`Tem certeza que deseja limpar as siglas para o dia ${currentEditingDateKey.split('-')[2]}?`)) {
                const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
                if (employeeIndex === -1) return;

                const employee = employees[employeeIndex];
                if (employee.schedule && employee.schedule[currentEditingDateKey]) {
                    delete employee.schedule[currentEditingDateKey];
                }
                saveEmployees();
                renderSchedule();
                window.showMessageBox(`Siglas para o dia ${currentEditingDateKey.split('-')[2]} limpas.`);
                window.closeSiglaVacationModal();
                console.log("Daily siglas cleared.");
            }
        }


        function applyVacation() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem aplicar férias.', 3000);
                return;
            }
            console.log("Applying vacation...");
            const vacationStart = document.getElementById('vacationStart').value;
            const vacationEnd = document.getElementById('vacationEnd').value;

            if (!vacationStart || !vacationEnd) {
                window.showMessageBox('Por favor, selecione as datas de início e fim das férias.', 4000);
                return;
            }

            const startDate = new Date(vacationStart);
            const endDate = new Date(vacationEnd);

            if (startDate > endDate) {
                window.showMessageBox('A data de início das férias não pode ser posterior à data de fim.', 4000);
                return;
            }

            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;

            const employee = employees[employeeIndex];
            if (!employee.vacations) employee.vacations = [];

            // Clear any existing schedule entries within the vacation period
            let tempDate = new Date(startDate);
            while (tempDate <= endDate) {
                const dateKey = `${tempDate.getFullYear()}-${String(tempDate.getMonth() + 1).padStart(2, '0')}-${String(tempDate.getDate()).padStart(2, '0')}`;
                delete employee.schedule[dateKey];
                tempDate.setDate(tempDate.getDate() + 1);
            }

            // Add the new vacation period
            employee.vacations.push({ start: vacationStart, end: vacationEnd });
            saveEmployees();
            renderSchedule();
            window.showMessageBox('Férias aplicadas com sucesso!');
            window.closeSiglaVacationModal();
            console.log("Vacation applied.");
        }

        function clearVacation() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem limpar férias.', 3000);
                return;
            }
            console.log("Clearing vacation...");
            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;

            const employee = employees[employeeIndex];
            employee.vacations = []; // Clear all vacations for this employee

            saveEmployees();
            renderSchedule();
            window.showMessageBox('Férias do funcionário limpas.');
            window.closeSiglaVacationModal();
            console.log("Vacation cleared.");
        }

        function clearEmployeeSchedule() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem limpar a escala do funcionário.', 3000);
                return;
            }
            console.log("Clearing all employee schedule and vacations...");
            if (window.confirm('Tem certeza que deseja limpar toda a escala e férias deste funcionário? Isso é irreversível.')) {
                const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
                if (employeeIndex === -1) return;

                const employee = employees[employeeIndex];
                employee.schedule = {}; // Clear all schedule
                employee.vacations = []; // Clear all vacations

                saveEmployees();
                renderSchedule();
                window.showMessageBox('Escala e férias do funcionário limpas.');
                window.closeSiglaVacationModal();
                console.log("Employee schedule and vacations cleared.");
            }
        }

        // New function to copy current month's schedule to the next month
        function copyScheduleToNextMonth() {
            if (currentUserRole !== 'admin') {
                window.showMessageBox('Apenas administradores podem transcrever a escala.', 3000);
                return;
            }
            console.log("Copying schedule to next month...");
            if (!window.confirm('Deseja transcrever a escala do mês atual para o próximo mês? Isso copiará as siglas de dias úteis, mas não as folgas/licenças médicas específicas.')) {
                return;
            }

            const nextMonthDate = new Date(currentYear, currentMonth + 1);
            const nextMonth = nextMonthDate.getMonth();
            const nextYear = nextMonthDate.getFullYear();
            const daysInCurrentMonth = getDaysInMonth(currentYear, currentMonth);
            const daysInNextMonth = getDaysInMonth(nextYear, nextMonth);

            employees.forEach(emp => {
                for (let i = 1; i <= daysInCurrentMonth; i++) {
                    const currentDateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const nextDay = i; // Map day 1 to day 1, day 2 to day 2, etc.
                    const nextDateKey = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(nextDay).padStart(2, '0')}`;

                    // Skip if the day number exceeds the number of days in the next month (e.g., 31st to a 30-day month)
                    if (nextDay > daysInNextMonth) {
                        continue;
                    }

                    // Get siglas from current month, filtering out FO/LM for general copy
                    const sourceSiglas = emp.schedule[currentDateKey] || [];
                    const generalSiglasToCopy = Array.isArray(sourceSiglas) ? sourceSiglas.filter(s => s !== 'FO' && s !== 'LM') : [];

                    // Preserve existing FO/LM in the target day
                    const existingFoLm = emp.schedule[nextDateKey] || [];
                    const preservedFoLm = Array.isArray(existingFoLm) ? existingFoLm.filter(s => s === 'FO' || s === 'LM') : [];

                    // Determine the content for the next month's day
                    let targetDayContent = [];
                    if (isWeekend(nextYear, nextMonth, nextDay) || isHoliday(nextYear, nextMonth, nextDay) || isVacation(emp, nextYear, nextMonth, nextDay)) {
                        // If it's a non-working day in the target month, only keep preserved FO/LM
                        targetDayContent = preservedFoLm;
                    } else {
                        // It's a working day, combine preserved FO/LM with general siglas from current month
                        targetDayContent = [...new Set([...preservedFoLm, ...generalSiglasToCopy])];
                    }

                    // Assign the determined content
                    if (targetDayContent.length > 0) {
                        emp.schedule[nextDateKey] = targetDayContent;
                    } else {
                        delete emp.schedule[nextDateKey];
                    }
                }
            });

            saveEmployees();
            // Optionally, navigate to the next month to show the copied schedule
            currentMonth = nextMonth;
            currentYear = nextYear;
            renderSchedule();
            loadMonthlyObservations(); // Ensure observations are loaded for the new month
            window.showMessageBox('Escala transcrita para o mês seguinte com sucesso!');
            console.log("Schedule copied to next month.");
        }


        // --- Print Functionality ---

        function printSchedule() {
            console.log("Preparing to print schedule...");
            const daysInCurrentMonthForPrint = getDaysInMonth(currentYear, currentMonth); // Pre-calculate
            const printWindow = window.open('', '_blank');

            // Set CSS custom property on the document element of the new window
            // This is the key change to avoid SyntaxError in the <style> block
            printWindow.document.documentElement.style.setProperty('--days-in-month', daysInCurrentMonthForPrint);

            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Imprimir Escala - ${document.getElementById('currentMonthYear').textContent}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; }
                        .printable-header { text-align: center; margin-bottom: 20px; font-size: 16px; }
                        .printable-table-container { overflow: hidden; } /* Ensure table fits */
                        .printable-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                        .printable-table th, .printable-table td {
                            border: 1px solid #000;
                            padding: 4px;
                            text-align: center;
                            font-size: 10px;
                            white-space: normal; /* Allow wrapping for print */
                            word-break: break-word; /* Break long words */
                        }
                        .printable-table th { background-color: #e0e0e0; }
                        .printable-table .weekend, .printable-table .holiday { background-color: #ccc; }
                        .printable-table .vacation { background-color: #a7d9ff; font-weight: bold; }
                        .printable-legend {
                            font-size: 10px;
                            margin-top: 20px;
                            border-top: 1px solid #000;
                            padding-top: 10px;
                            page-break-before: avoid; /* Avoid breaking page before legend */
                        }
                        /* Team Colors for Print */
                        .team-sol-print { background-color: #FFD700; color: #333; }
                        .team-verde-print { background-color: #32CD32; color: white; }
                        .team-vermelha-print { background-color: #FF4500; color: white; }
                        .team-azul-print { background-color: #1E90FF; color: white; }
                        .team-laranja-print { background-color: #FFA500; color: #333; }
                        .team-apoio-print { background-color: #D3D3D3; color: #333; }


                        /* Column widths for print */
                        .printable-table th:nth-child(1) { width: 12%; } /* Nome */
                        .printable-table th:nth-child(2) { width: 7%; } /* Função */
                        .printable-table th:nth-child(3) { width: 9%; } /* Conselho */
                        .printable-table th:nth-child(4) { width: 7%; } /* Horário de Trabalho */
                        .printable-table th:nth-child(n+5) { width: calc(65% / var(--days-in-month)); } /* Days */

                        @page {
                            size: landscape; /* Default to landscape */
                            margin: 1cm;
                        }
                    </style>
                </head>
                <body>
                    <div class="printable-content">
                        <div class="printable-header">
                            <h2>Escala do Centro de Saúde - ${document.getElementById('currentMonthYear').textContent}</h2>
                        </div>
                        <div class="printable-table-container">
                            <table class="printable-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Função</th>
                                        <th>Conselho</th>
                                        <th>Horário de Trabalho</th>
                                        ${Array.from({ length: getDaysInMonth(currentYear, currentMonth) }, (_, i) => {
                                            const day = i + 1;
                                            const isDayWeekend = isWeekend(currentYear, currentMonth, day);
                                            const isDayHoliday = isHoliday(currentYear, currentMonth, day);
                                            let classes = '';
                                            if (isDayWeekend || isDayHoliday) classes = 'weekend';
                                            return `<th class="${classes}">${day}</th>`;
                                        }).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortEmployeesByRole(employees).map(emp => {
                                        let rowHtml = `<tr>
                                            <td class="font-medium ${getTeamColorClass(emp.team)}-print">
                                                ${emp.name} <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold">${emp.team}</span>
                                            </td>
                                            <td>${emp.role}</td>
                                            <td>${emp.council}</td>
                                            <td>${emp.workShift || ''}</td>`;
                                        for (let i = 1; i <= getDaysInMonth(currentYear, currentMonth); i++) {
                                            const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                                            const isDayWeekend = isWeekend(currentYear, currentMonth, i);
                                            const isDayHoliday = isHoliday(currentYear, currentMonth, i);
                                            let cellContent = '';
                                            let cellClasses = '';

                                            if (isVacation(emp, currentYear, currentMonth, i)) {
                                                cellContent = 'FÉRIAS';
                                                cellClasses = 'vacation';
                                                // Check if this is the start of a vacation block for merging
                                                const prevDayIsVacation = isVacation(emp, currentYear, currentMonth, i - 1);
                                                if (!prevDayIsVacation) {
                                                    let span = 1;
                                                    let j = i + 1;
                                                    while (j <= getDaysInMonth(currentYear, currentMonth) && isVacation(emp, currentYear, currentMonth, j)) {
                                                        span++;
                                                        j++;
                                                    }
                                                    rowHtml += `<td colspan="${span}" class="${cellClasses}">${cellContent}</td>`;
                                                    i += (span - 1); // Skip merged days
                                                }
                                            } else {
                                                // Display multiple siglas joined by comma
                                                const siglas = emp.schedule && emp.schedule[dateKey] ? emp.schedule[dateKey] : [];
                                                cellContent = Array.isArray(siglas) ? siglas.join(', ') : siglas;
                                                if (isDayWeekend || isDayHoliday) {
                                                    cellClasses = 'weekend';
                                                }
                                                rowHtml += `<td class="${cellClasses}">${cellContent}</td>`;
                                            }
                                        }
                                        rowHtml += `</tr>`;
                                        return rowHtml;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="printable-legend">
                            <h3>Legenda:</h3>
                            <ul>
                                <li><strong>F:</strong> Farmácia</li>
                                <li><strong>S:</strong> Sala de Observação</li>
                                <li><strong>P:</strong> Presente</li>
                                <li><strong>CT:</strong> Curativo</li>
                                <li><strong>BR:</strong> Acolhimento Baixo Risco</li>
                                <li><strong>LM:</strong> Licença Médica</li>
                                <li><strong>FO:</strong> Folga</li>
                                <li><strong>E:</strong> ECG</li>
                                <li><strong>V:</strong> Vacina</li>
                                <li><strong>T:</strong> Totem</li>
                                <li><strong>C:</strong> Consultórios</li>
                            </ul>
                            <p><strong>Observações:</strong> ${monthlyObservations[`${currentYear}-${currentMonth + 1}`] || 'Nenhuma observação para este mês.'}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            console.log("Print window opened and content written.");
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DOMContentLoaded fired.");
            console.log("Firebase Config:", firebaseConfig);
            console.log("Initial Auth Token:", initialAuthToken);

            // Initialize Firebase
            if (firebaseConfig) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase app, db, auth initialized.");

                    // Establish initial authentication state
                    if (initialAuthToken) {
                        console.log("Attempting signInWithCustomToken...");
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("signInWithCustomToken successful (or already signed in).");
                    } else {
                        console.log("No custom token, attempting signInAnonymously...");
                        await signInAnonymously(auth);
                        console.log("signInAnonymously successful (or already signed in).");
                    }

                    // Listen for authentication state changes (this will also handle the initial state established above)
                    onAuthStateChanged(auth, handleAuthStateChanged);
                    console.log("onAuthStateChanged listener attached.");

                } catch (error) {
                    console.error("Erro ao inicializar Firebase ou autenticar:", error);
                    window.showMessageBox(`Erro ao inicializar o banco de dados: ${error.message}. Usando armazenamento local.`, 7000);
                    // Fallback to localStorage if Firebase initialization or initial auth fails
                    userId = crypto.randomUUID(); // Dummy userId for localStorage context
                    currentUserRole = 'guest';
                    isAuthReady = true;
                    loadEmployees();
                    loadMonthlyObservations();
                    updateAdminUI(); // Ensure UI is updated for guest mode
                }
            } else {
                console.warn("Firebase config not found. Falling back to localStorage.");
                // If no Firebase config, proceed with localStorage
                userId = crypto.randomUUID(); // Generate a dummy userId for localStorage context
                currentUserRole = 'guest';
                isAuthReady = true;
                loadEmployees();
                loadMonthlyObservations();
                updateAdminUI(); // Ensure UI is updated for guest mode
            }

            // Authentication button listeners
            const loginBtn = document.getElementById('loginBtn');
            const registerBtn = document.getElementById('registerBtn');
            const completeRegisterBtn = document.getElementById('completeRegisterBtn');
            const logoutBtn = document.getElementById('logoutBtn');

            if (loginBtn) {
                loginBtn.addEventListener('click', loginUser);
                console.log("loginBtn listener attached.");
            } else {
                console.error("loginBtn not found!");
            }
            if (registerBtn) {
                registerBtn.addEventListener('click', window.openRegistrationModal);
                console.log("registerBtn listener attached.");
            } else {
                console.error("registerBtn not found!");
            }
            if (completeRegisterBtn) {
                completeRegisterBtn.addEventListener('click', completeRegistration);
                console.log("completeRegisterBtn listener attached.");
            } else {
                console.error("completeRegisterBtn not found!");
            }
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logoutUser);
                console.log("logoutBtn listener attached.");
            } else {
                console.error("logoutBtn not found!");
            }

            // Event listener for custom role field
            document.getElementById('employeeRole').addEventListener('change', function() {
                const customRoleField = document.getElementById('customEmployeeRole');
                if (this.value === 'Outro') {
                    customRoleField.classList.remove('hidden');
                } else {
                    customRoleField.classList.add('hidden');
                    customRoleField.value = ''; // Clear custom field if not 'Outro'
                }
            });


            document.getElementById('addEmployeeBtn').addEventListener('click', addEmployee);
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderSchedule();
                loadMonthlyObservations(); // Reload observations for new month
            });
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderSchedule();
                loadMonthlyObservations(); // Reload observations for new month
            });

            // Modified event listeners for sigla application based on context
            document.getElementById('applySiglaMonthBtn').addEventListener('click', applySiglaMonth);
            document.getElementById('clearSiglasMonthBtn').addEventListener('click', clearSiglasForMonth);
            document.getElementById('applySiglaDayBtn').addEventListener('click', applySiglaDay); // New button for single day sigla
            document.getElementById('clearSiglasDayBtn').addEventListener('click', clearSiglasForDay); // New button for clearing single day sigla

            document.getElementById('applyVacationBtn').addEventListener('click', applyVacation);
            document.getElementById('clearVacationBtn').addEventListener('click', clearVacation);
            document.getElementById('clearEmployeeScheduleBtn').addEventListener('click', clearEmployeeSchedule);
            document.getElementById('printScheduleBtn').addEventListener('click', printSchedule);
            document.getElementById('saveScheduleBtn').addEventListener('click', saveAllData); // Event listener for the new save button
            document.getElementById('copyToNextMonthBtn').addEventListener('click', copyScheduleToNextMonth); // New event listener for copy button
            document.getElementById('monthlyObservations').addEventListener('input', saveMonthlyObservations);

            // Initial render (will be triggered by onAuthStateChanged)
            renderCurrentMonthYear();
        });
    </script>
</body>
</html>
