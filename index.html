<script type="module">
    // Global variables for Firebase configuration and app ID
    const appId = "1:1040621794903:web:61518f984286e11fb29512";
    const firebaseConfig = {
        apiKey: "AIzaSyALs6IeL242UJH7uXpa-0mQq_CN_RA-xWA",
        authDomain: "escalasaudeapp.firebaseapp.com",
        projectId: "escalasaudeapp",
        storageBucket: "escalasaudeapp.firebasestorage.app",
        messagingSenderId: "1040621794903",
        appId: "1:1040621794903:web:61518f984286e11fb29512",
        measurementId: "G-YHH987DD5J"
    };
    const initialAuthToken = null;

    let db;
    let auth;
    let userId;
    let isAuthReady = false;

    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let employees = [];
    let currentEditingEmployeeId = null;
    let monthlyObservations = {};
    let customHolidays = {}; // New: Custom holidays per month
    let customSiglas = [
        { id: '1', abbr: 'F', name: 'Farmácia', color: '#fca5a5' }, // Red-300
        { id: '2', abbr: 'S', name: 'Sala de Observação', color: '#fdba74' }, // Orange-300
        { id: '3', abbr: 'P', name: 'Presente', color: '#86efac' }, // Green-300
        { id: '4', abbr: 'CT', name: 'Curativo', color: '#bfdbfe' }, // Blue-300
        { id: '5', abbr: 'BR', name: 'Acolhimento Baixo Risco', color: '#a5b4fc' }, // Indigo-300
        { id: '6', abbr: 'E', name: 'ECG', color: '#c4b5fd' }, // Violet-300
        { id: '7', abbr: 'V', name: 'Vacina', color: '#c7d2fe' }, // Indigo-200
        { id: '8', abbr: 'T', name: 'Totem', color: '#a0aec0' }, // Gray-500
        { id: '9', abbr: 'C', name: 'Consultórios', color: '#a0e4a7' }, // Custom light green
    ];
    
    const specialSiglas = ['FO', 'LM'];
    const dayOfWeekLetters = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
    let sortDirection = {}; // Store sort direction for each column
    let currentSortKey = 'name';

    // --- Utility Functions ---
    window.showMessageBox = function(message, duration = 3000) {
        const messageBox = document.getElementById('messageBox');
        document.getElementById('messageText').textContent = message;
        messageBox.classList.remove('hidden');
        setTimeout(() => {
            window.hideMessageBox();
        }, duration);
    }

    window.hideMessageBox = function() {
        document.getElementById('messageBox').classList.add('hidden');
    }
    
    // --- FUNÇÕES DE REFERÊNCIA DE DOCUMENTOS ---
    // Referência para documentos gerais (siglas, funcionários, observações)
    function getDocRef(collectionName) {
        return doc(db, 'artifacts', appId, 'users', userId, 'health_schedule_data', collectionName);
    }

    // NOVA FUNÇÃO: Referência para a escala do mês específico
    function getMonthlyScheduleDocRef(year, month) {
        const docId = `${year}-${String(month + 1).padStart(2, '0')}`;
        return doc(db, 'artifacts', appId, 'users', userId, 'health_schedule_data', 'monthly_schedules', docId);
    }

    // Função de salvamento genérica
    async function saveData(docRef, data) {
        if (userId && db) {
            await setDoc(docRef, { data: JSON.stringify(data) })
                .catch(error => console.error(`Erro ao salvar no Firestore:`, error));
        } else {
            // Se o Firebase não estiver disponível, usamos localStorage
            localStorage.setItem(docRef.path, JSON.stringify(data));
        }
    }
    
    // Função de carregamento genérica
    async function loadData(docRef) {
        if (userId && db) {
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return JSON.parse(docSnap.data().data);
                }
            } catch (error) {
                console.error(`Erro ao carregar do Firestore:`, error);
            }
        } else {
            const storedData = localStorage.getItem(docRef.path);
            if (storedData) return JSON.parse(storedData);
        }
        return null;
    }

    // --- FUNÇÕES DE SALVAMENTO E CARREGAMENTO DE CADA ITEM ---
    async function saveEmployeesMaster() {
        const employeesMaster = employees.map(emp => ({ ...emp, schedule: {}, vacations: [], leaves: [] }));
        await saveData(getDocRef('employees_master'), employeesMaster);
    }
    
    async function loadEmployeesMaster() {
        const loadedEmployees = await loadData(getDocRef('employees_master'));
        if (loadedEmployees) {
            employees = loadedEmployees.map(emp => ({ ...emp, schedule: {}, vacations: [], leaves: [] }));
        }
    }

    async function saveMonthlySchedule() {
        const monthlyScheduleRef = getMonthlyScheduleDocRef(currentYear, currentMonth);
        await saveData(monthlyScheduleRef, { employees, monthlyObservations, customHolidays });
    }

    async function loadMonthlySchedule() {
        const monthlyScheduleRef = getMonthlyScheduleDocRef(currentYear, currentMonth);
        const loadedData = await loadData(monthlyScheduleRef);
        if (loadedData) {
            employees = loadedData.employees || employees;
            monthlyObservations = loadedData.monthlyObservations || {};
            customHolidays = loadedData.customHolidays || {};
        } else {
            // Se não houver dados, garante que a escala e observações estão limpas para o mês
            employees.forEach(emp => {
                emp.schedule = {};
                emp.vacations = [];
                emp.leaves = [];
            });
            monthlyObservations = {};
            customHolidays = {};
        }
        renderEmployeeList();
        renderSchedule();
        document.getElementById('monthlyObservations').value = monthlyObservations[`${currentYear}-${currentMonth + 1}`] || '';
    }

    async function saveSiglas() { await saveData(getDocRef('customSiglas'), customSiglas); }
    async function loadSiglas() {
        const loadedSiglas = await loadData(getDocRef('customSiglas'));
        if (loadedSiglas && loadedSiglas.length > 0) {
            customSiglas = loadedSiglas;
        }
    }
    
    function saveAllData() {
        // Salva a lista de funcionários mestre (sem a escala)
        saveEmployeesMaster();
        // Salva a escala, observações e feriados do mês atual em um documento separado
        saveMonthlySchedule();
        // Salva as siglas em seu próprio documento
        saveSiglas();
        window.showMessageBox('Escala salva com sucesso!');
    }

    function getDaysInMonth(year, month) {
        return new Date(year, month + 1, 0).getDate();
    }

    function isWeekend(employee, year, month, day) {
        const date = new Date(year, month, day);
        const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday

        // Default weekend is Saturday (6) and Sunday (0)
        return dayOfWeek === 0 || dayOfWeek === 6;
    }
    
    // Brazilian National Holidays (example for 2025)
    const nationalHolidays = [
        '2025-01-01', '2025-03-03', '2025-03-04', '2025-04-18', '2025-04-21', 
        '2025-05-01', '2025-06-19', '2025-09-07', '2025-10-12', '2025-11-02', 
        '2025-11-15', '2025-12-25'
    ];

    function isHoliday(year, month, day) {
        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const isNational = nationalHolidays.includes(dateString);
        const key = `${year}-${month + 1}`;
        const isCustom = customHolidays[key] && customHolidays[key].includes(day);
        return isNational || isCustom;
    }
    
    function isWorkday(employee, year, month, day) {
        return !isWeekend(employee, year, month, day) && !isHoliday(year, month, day);
    }

    function isVacation(employee, year, month, day) {
        const currentDate = new Date(year, month, day);
        if (!employee.vacations) return false;
        for (const vacation of employee.vacations) {
            const startDateParts = vacation.start.split('-').map(Number);
            const endDateParts = vacation.end.split('-').map(Number);
            const startDate = new Date(startDateParts[0], startDateParts[1] - 1, startDateParts[2]);
            const endDate = new Date(endDateParts[0], endDateParts[1] - 1, endDateParts[2]);
            
            startDate.setHours(0,0,0,0);
            endDate.setHours(0,0,0,0);
            currentDate.setHours(0,0,0,0);
            
            if (currentDate >= startDate && currentDate <= endDate) return true;
        }
        return false;
    }

    function isLeave(employee, year, month, day, type) {
        const currentDate = new Date(year, month, day);
        const leaves = employee.leaves || [];
        for (const leave of leaves) {
            if (leave.type === type) {
                const startDateParts = leave.start.split('-').map(Number);
                const endDateParts = leave.end.split('-').map(Number);
                const startDate = new Date(startDateParts[0], startDateParts[1] - 1, startDateParts[2]);
                const endDate = new Date(endDateParts[0], endDateParts[1] - 1, endDateParts[2]);
                
                startDate.setHours(0,0,0,0);
                endDate.setHours(0,0,0,0);
                currentDate.setHours(0,0,0,0);
                
                if (currentDate >= startDate && currentDate <= endDate) return true;
            }
        }
        return false;
    }
    
    // --- Render Functions ---
    function renderCurrentMonthYear() {
        const date = new Date(currentYear, currentMonth);
        document.getElementById('currentMonthYear').textContent = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
    }

    function getTeamColorClass(team) {
        switch (team) {
            case 'Sol': return 'team-sol';
            case 'Verde': return 'team-verde';
            case 'Vermelha': return 'team-vermelha';
            case 'Azul': return 'team-azul';
            case 'Laranja': return 'team-laranja';
            case 'Apoio': return 'team-apoio';
            default: return '';
        }
    }
    
    // New: General sorting function
    function sortEmployees(empArray, key, direction) {
        return [...empArray].sort((a, b) => {
            const valueA = a[key] || '';
            const valueB = b[key] || '';

            if (direction === 'asc') {
                return valueA.localeCompare(valueB);
            } else {
                return valueB.localeCompare(valueA);
            }
        });
    }
    
    // New: Filter function
    function filterEmployees() {
        const filterName = document.getElementById('filterName').value.toLowerCase();
        const filterRole = document.getElementById('filterRole').value.toLowerCase();
        const filterWorkShift = document.getElementById('filterWorkShift').value.toLowerCase();
        const filterTeam = document.getElementById('filterTeam').value.toLowerCase();

        return employees.filter(emp => {
            const nameMatch = emp.name.toLowerCase().includes(filterName);
            const roleMatch = emp.role.toLowerCase().includes(filterRole);
            const workShiftMatch = emp.workShift.toLowerCase().includes(workShiftMatch);
            const teamMatch = emp.team.toLowerCase().includes(filterTeam);
            return nameMatch && roleMatch && workShiftMatch && teamMatch;
        });
    }

    function renderEmployeeList() {
        const employeesUl = document.getElementById('employeesUl');
        employeesUl.innerHTML = '';
        if (employees.length === 0) {
            employeesUl.innerHTML = '<li class="text-gray-500">Nenhum funcionário cadastrado.</li>';
            return;
        }

        const sortedEmployees = [...employees].sort((a,b) => a.name.localeCompare(b.name));
        sortedEmployees.forEach(emp => {
            const li = document.createElement('li');
            const teamColorClass = getTeamColorClass(emp.team);
            li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm border border-gray-200';
            li.innerHTML = `
                <div class="flex-grow">
                    <span class="font-medium text-blue-600 cursor-pointer" onclick="window.openSiglaVacationModal('${emp.id}')">${emp.name}</span>
                    <span class="text-sm text-gray-500 ml-2">(${emp.role} - ${emp.council} - ${emp.workShift})</span>
                    <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${teamColorClass} ml-2">${emp.team}</span>
                    <span class="text-xs text-gray-400 block break-all">ID: ${emp.id}</span>
                </div>
                <div>
                    <button onclick="window.deleteEmployee('${emp.id}')" class="btn-danger ml-2">Excluir</button>
                </div>
            `;
            employeesUl.appendChild(li);
        });
    }
    
    function renderSchedule() {
        renderCurrentMonthYear();
        const scheduleHeader = document.getElementById('scheduleHeader');
        const scheduleBody = document.getElementById('scheduleBody');
        scheduleHeader.innerHTML = `
            <th class="w-1/6 sortable" data-sort-key="name">Nome</th>
            <th class="w-1/12 sortable" data-sort-key="role">Função</th>
            <th class="w-1/12">Conselho</th>
            <th class="w-1/12 sortable" data-sort-key="workShift">Horário de Trabalho</th>
        `;
        scheduleBody.innerHTML = '';
        
        // Add click event listeners to sortable headers
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sortKey;
                if (currentSortKey === sortKey) {
                    sortDirection[sortKey] = sortDirection[sortKey] === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortKey = sortKey;
                    sortDirection[sortKey] = 'asc';
                }
                renderSchedule();
            });
        });

        const daysInMonth = getDaysInMonth(currentYear, currentMonth);

        // Add day headers
        for (let i = 1; i <= daysInMonth; i++) {
            const th = document.createElement('th');
            const date = new Date(currentYear, currentMonth, i);
            const dayOfWeek = date.getDay();
            const dayLetter = dayOfWeekLetters[dayOfWeek];
            th.innerHTML = `${i} <div class="font-normal text-gray-500">${dayLetter}</div>`;
            th.setAttribute('data-day', i);
            th.onclick = function() { toggleCustomHoliday(i); };
            const isDayWeekend = new Date(currentYear, currentMonth, i).getDay() === 0 || new Date(currentYear, currentMonth, i).getDay() === 6;
            if (isDayWeekend || isHoliday(currentYear, currentMonth, i)) {
                th.classList.add('weekend');
            }
            scheduleHeader.appendChild(th);
        }
        
        const filteredEmployees = filterEmployees();
        const sortedEmployees = sortEmployees(filteredEmployees, currentSortKey, sortDirection[currentSortKey] || 'asc');

        // Add employee rows
        sortedEmployees.forEach(emp => {
            const tr = document.createElement('tr');
            const teamColorClass = getTeamColorClass(emp.team);
            tr.innerHTML = `
                <td class="font-medium text-blue-600 cursor-pointer ${teamColorClass}" onclick="window.openSiglaVacationModal('${emp.id}')">
                    ${emp.name}
                </td>
                <td>${emp.role}</td>
                <td>${emp.council}</td>
                <td>${emp.workShift || ''}</td>
            `;
            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const td = document.createElement('td');
                td.setAttribute('data-employee-id', emp.id);
                td.setAttribute('data-date-key', dateKey);
                
                if (isVacation(emp, currentYear, currentMonth, i)) {
                    td.classList.add('vacation');
                    td.textContent = 'FÉRIAS';
                    const prevDayIsVacation = isVacation(emp, currentYear, currentMonth, i - 1);
                    if (!prevDayIsVacation) {
                        let span = 1;
                        let j = i + 1;
                        while (j <= daysInMonth && isVacation(emp, currentYear, currentMonth, j)) {
                            span++;
                            j++;
                        }
                        td.colSpan = span;
                        tr.appendChild(td);
                        i += (span - 1);
                    } else {
                        continue;
                    }
                } else if (isLeave(emp, currentYear, currentMonth, i, 'LM')) {
                    td.classList.add('licenca');
                    td.textContent = 'LM';
                    tr.appendChild(td);
                } else if (isLeave(emp, currentYear, currentMonth, i, 'FO')) {
                    td.classList.add('folga');
                    td.textContent = 'FO';
                    tr.appendChild(td);
                } else {
                    const siglas = emp.schedule && emp.schedule[dateKey] ? emp.schedule[dateKey] : [];
                    td.textContent = Array.isArray(siglas) ? siglas.join(', ') : siglas;
                    if (isWeekend(emp, currentYear, currentMonth, i) || isHoliday(currentYear, currentMonth, i)) {
                        td.classList.add('weekend');
                    }
                    
                    td.addEventListener('click', (event) => {
                        editDaySchedule(event.target, emp.id, dateKey);
                    });

                    tr.appendChild(td);
                }
            }
            scheduleBody.appendChild(tr);
        });
        document.getElementById('monthlyObservations').value = monthlyObservations[`${currentYear}-${currentMonth + 1}`] || '';
    }

    function editDaySchedule(cell, employeeId, dateKey) {
        const employee = employees.find(e => e.id === employeeId);
        if (!employee) return;

        const dateParts = dateKey.split('-').map(Number);
        const day = dateParts[2];
        if (!isWorkday(employee, currentYear, currentMonth, day) || isVacation(employee, currentYear, currentMonth, day) || isLeave(employee, currentYear, currentMonth, day, 'LM') || isLeave(employee, currentYear, currentMonth, day, 'FO')) {
            return;
        }
        
        const currentSiglas = cell.textContent;

        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'w-full text-center border rounded';
        input.value = currentSiglas;
        input.style.fontSize = '0.75rem';
        
        cell.textContent = '';
        cell.appendChild(input);
        input.focus();

        const saveSchedule = () => {
            const newSiglas = input.value.trim().split(',').map(s => s.trim().toUpperCase()).filter(s => s !== '');
            
            if (!employee.schedule) {
                employee.schedule = {};
            }
            
            if (newSiglas.length > 0) {
                employee.schedule[dateKey] = newSiglas;
            } else {
                delete employee.schedule[dateKey];
            }

            saveMonthlySchedule();
            renderSchedule();
        };

        input.addEventListener('blur', saveSchedule);
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveSchedule();
            }
        });
    }

    function renderSiglaCheckboxes(containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        // Add custom siglas
        customSiglas.forEach(sigla => {
            const label = document.createElement('label');
            label.className = 'flex items-center';
            label.innerHTML = `<input type="checkbox" name="sigla" value="${sigla.abbr}" class="mr-2"> ${sigla.abbr} (${sigla.name})`;
            container.appendChild(label);
        });
    }

    // --- Employee Actions ---
    function addEmployee() {
        const name = document.getElementById('employeeName').value.trim();
        let role = document.getElementById('employeeRole').value.trim();
        const customRole = document.getElementById('customEmployeeRole').value.trim();
        const council = document.getElementById('employeeCouncil').value.trim();
        const workShift = document.getElementById('employeeWorkShift').value.trim();
        const team = document.getElementById('employeeTeam').value.trim();

        if (role === 'Outro') {
            role = customRole;
        }

        if (name && role && council && workShift && team) {
            const newEmployee = {
                id: crypto.randomUUID(),
                name,
                role,
                council,
                workShift,
                team,
                schedule: {},
                vacations: [],
                leaves: []
            };
            employees.push(newEmployee);
            saveEmployeesMaster();
            saveMonthlySchedule();
            renderEmployeeList();
            renderSchedule();
            // Clear form
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeRole').value = '';
            document.getElementById('customEmployeeRole').value = '';
            document.getElementById('customEmployeeRole').classList.add('hidden');
            document.getElementById('employeeCouncil').value = '';
            document.getElementById('employeeWorkShift').value = '';
            document.getElementById('employeeTeam').value = '';
            window.showMessageBox('Funcionário adicionado com sucesso!');
        } else {
            window.showMessageBox('Por favor, preencha todos os campos do funcionário.', 4000);
        }
    }

    window.deleteEmployee = function(id) {
        if (confirm('Tem certeza que deseja excluir este funcionário?')) {
            employees = employees.filter(emp => emp.id !== id);
            saveEmployeesMaster();
            saveMonthlySchedule();
            renderEmployeeList();
            renderSchedule();
            window.showMessageBox('Funcionário excluído.');
        }
    }

    // --- Modal Functions ---
    window.openSiglaVacationModal = function(employeeId) {
        currentEditingEmployeeId = employeeId;
        const employee = employees.find(emp => emp.id === employeeId);
        if (employee) {
            document.getElementById('modalEmployeeName').textContent = `Editar Escala de: ${employee.name}`;
            document.getElementById('siglaVacationModal').classList.remove('hidden');
            document.getElementById('dateRangeStart').value = '';
            document.getElementById('dateRangeEnd').value = '';
            renderSiglaCheckboxes('siglaCheckboxesMonth');

            const checkboxesMonth = document.querySelectorAll('#siglaCheckboxesMonth input[type="checkbox"]');
            checkboxesMonth.forEach(cb => cb.checked = false);
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);
            const currentMonthSiglas = new Set();
            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const siglasForDay = employee.schedule && employee.schedule[dateKey] ? employee.schedule[dateKey] : [];
                if (Array.isArray(siglasForDay)) {
                    siglasForDay.forEach(sigla => currentMonthSiglas.add(sigla));
                }
            }
            currentMonthSiglas.forEach(sigla => {
                const checkbox = document.querySelector(`#siglaCheckboxesMonth input[value="${sigla}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
    }

    window.closeSiglaVacationModal = function() {
        document.getElementById('siglaVacationModal').classList.add('hidden');
        currentEditingEmployeeId = null;
    }

    function applySiglaMonth() {
        const selectedSiglas = Array.from(document.querySelectorAll('#siglaCheckboxesMonth input[type="checkbox"]:checked')).map(cb => cb.value);
        
        if (selectedSiglas.length === 0) {
            window.showMessageBox('Por favor, selecione ao menos uma sigla.', 3000);
            return;
        }

        const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
        if (employeeIndex === -1) return;
        const employee = employees[employeeIndex];

        if (!employee.schedule) {
            employee.schedule = {};
        }
        
        const daysInMonth = getDaysInMonth(currentYear, currentMonth);

        for (let i = 1; i <= daysInMonth; i++) {
            const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;

            if (!isWeekend(employee, currentYear, currentMonth, i) && !isHoliday(currentYear, currentMonth, i) && !isVacation(employee, currentYear, currentMonth, i) && !isLeave(employee, currentYear, currentMonth, i, 'FO') && !isLeave(employee, currentYear, currentMonth, i, 'LM')) {
                employee.schedule[dateKey] = selectedSiglas;
            } else {
                if (employee.schedule[dateKey]) {
                    delete employee.schedule[dateKey];
                }
            }
        }
        saveMonthlySchedule();
        renderSchedule();
        window.showMessageBox('Sigla(s) aplicada(s) para os dias úteis do mês.');
        window.closeSiglaVacationModal();
    }

    function clearSiglasForMonth() {
        if (confirm('Tem certeza que deseja limpar TODAS as siglas deste funcionário para o mês atual?')) {
            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;

            const employee = employees[employeeIndex];
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);

            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                if (employee.schedule && employee.schedule[dateKey]) {
                    delete employee.schedule[dateKey];
                }
            }
            saveMonthlySchedule();
            renderSchedule();
            window.showMessageBox('Siglas do funcionário para o mês atual limpas.');
            window.closeSiglaVacationModal();
        }
    }
    
    function applyLeaveOrVacation(type) {
        const startDate = document.getElementById('dateRangeStart').value;
        const endDate = document.getElementById('dateRangeEnd').value;
        
        if (!startDate || !endDate) {
            window.showMessageBox(`Por favor, selecione as datas de início e fim.`, 4000);
            return;
        }

        const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
        if (employeeIndex === -1) return;
        const employee = employees[employeeIndex];
        
        const newEntry = { start: startDate, end: endDate, type: type.toUpperCase() };
        
        if (type === 'vacation') {
            if (!employee.vacations) employee.vacations = [];
            employee.vacations.push(newEntry);
            window.showMessageBox('Férias aplicadas com sucesso!');
        } else {
            if (!employee.leaves) employee.leaves = [];
            employee.leaves.push(newEntry);
            window.showMessageBox(`${type === 'folga' ? 'Folga' : 'Licença Médica'} aplicada com sucesso!`);
        }
        
        let tempDate = new Date(startDate);
        const end = new Date(endDate);
        end.setDate(end.getDate() + 1);
        while (tempDate < end) {
            const dateKey = `${tempDate.getFullYear()}-${String(tempDate.getMonth() + 1).padStart(2, '0')}-${String(tempDate.getDate()).padStart(2, '0')}`;
            if (employee.schedule && employee.schedule[dateKey]) {
                delete employee.schedule[dateKey];
            }
            tempDate.setDate(tempDate.getDate() + 1);
        }
        
        saveMonthlySchedule();
        renderSchedule();
        window.closeSiglaVacationModal();
    }
    
    function clearVacation() {
        if (confirm('Tem certeza que deseja limpar as férias deste funcionário no mês atual?')) {
            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;

            const employee = employees[employeeIndex];
            const currentMonthStart = new Date(currentYear, currentMonth, 1);
            const currentMonthEnd = new Date(currentYear, currentMonth + 1, 0);

            employee.vacations = (employee.vacations || []).filter(vacation => {
                const vacationStart = new Date(vacation.start);
                const vacationEnd = new Date(vacation.end);
                
                return vacationEnd < currentMonthStart || vacationStart > currentMonthEnd;
            });
            
            saveMonthlySchedule();
            renderSchedule();
            window.showMessageBox('Férias do funcionário no mês atual limpas.');
            window.closeSiglaVacationModal();
        }
    }

    function clearLeave() {
        if (confirm('Tem certeza que deseja limpar as folgas e licenças deste funcionário no mês atual?')) {
            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;

            const employee = employees[employeeIndex];
            const currentMonthStart = new Date(currentYear, currentMonth, 1);
            const currentMonthEnd = new Date(currentYear, currentMonth + 1, 0);

            employee.leaves = (employee.leaves || []).filter(leave => {
                const leaveStart = new Date(leave.start);
                const leaveEnd = new Date(leave.end);
                
                return leaveEnd < currentMonthStart || leaveStart > currentMonthEnd;
            });

            saveMonthlySchedule();
            renderSchedule();
            window.showMessageBox('Licenças e folgas do funcionário no mês atual limpas.');
            window.closeSiglaVacationModal();
        }
    }

    function clearEmployeeSchedule() {
        if (confirm('Tem certeza que deseja limpar toda a escala e férias deste funcionário? Isso é irreversível.')) {
            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;

            const employee = employees[employeeIndex];
            employee.schedule = {};
            employee.vacations = [];
            employee.leaves = [];
            saveMonthlySchedule();
            renderSchedule();
            window.showMessageBox('Escala e férias do funcionário limpas.');
            window.closeSiglaVacationModal();
        }
    }
    
    // --- Sigla Management Functions ---
    window.openManageSiglasModal = function() {
        document.getElementById('manageSiglasModal').classList.remove('hidden');
        renderSiglasList();
    }

    window.closeManageSiglasModal = function() {
        document.getElementById('manageSiglasModal').classList.add('hidden');
        // Clear input fields
        document.getElementById('siglaAbbr').value = '';
        document.getElementById('siglaName').value = '';
        document.getElementById('siglaColor').value = '';
    }

    function addSigla() {
        const abbr = document.getElementById('siglaAbbr').value.trim().toUpperCase();
        const name = document.getElementById('siglaName').value.trim();
        const color = document.getElementById('siglaColor').value.trim();
        
        if (abbr && name && color) {
            customSiglas.push({ id: crypto.randomUUID(), abbr, name, color });
            saveSiglas();
            renderSiglasList();
            window.showMessageBox('Sigla adicionada com sucesso!');
            // Clear input fields
            document.getElementById('siglaAbbr').value = '';
            document.getElementById('siglaName').value = '';
            document.getElementById('siglaColor').value = '';
        } else {
            window.showMessageBox('Por favor, preencha todos os campos da sigla.', 3000);
        }
    }

    window.deleteSigla = function(id) {
        if (confirm('Tem certeza que deseja excluir esta sigla?')) {
            customSiglas = customSiglas.filter(s => s.id !== id);
            saveSiglas();
            renderSiglasList();
            window.showMessageBox('Sigla excluída.');
        }
    }
    
    function renderSiglasList() {
        const siglasUl = document.getElementById('siglasUl');
        siglasUl.innerHTML = '';
        customSiglas.forEach(s => {
            const li = document.createElement('li');
            li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm border border-gray-200';
            li.innerHTML = `
                <div class="flex-grow">
                    <span class="font-medium text-blue-600">${s.abbr}</span>
                    <span class="text-sm text-gray-500 ml-2">(${s.name})</span>
                    <span class="text-xs text-gray-400 ml-2">Cor: ${s.color}</span>
                </div>
                <div>
                    <button onclick="window.deleteSigla('${s.id}')" class="btn-danger ml-2">Excluir</button>
                </div>
            `;
            siglasUl.appendChild(li);
        });
    }

    // --- Dynamic Holiday Functionality ---
    function toggleCustomHoliday(day) {
        const key = `${currentYear}-${currentMonth + 1}`;
        const isDayCustomHoliday = customHolidays[key] && customHolidays[key].includes(day);

        if (isDayCustomHoliday) {
            if (confirm(`Deseja remover o feriado do dia ${day}?`)) {
                customHolidays[key] = customHolidays[key].filter(d => d !== day);
                if (customHolidays[key].length === 0) {
                    delete customHolidays[key];
                }
                saveMonthlySchedule();
                renderSchedule();
                window.showMessageBox(`Feriado do dia ${day} removido.`);
            }
        } else {
            if (confirm(`Deseja marcar o dia ${day} como feriado?`)) {
                if (!customHolidays[key]) {
                    customHolidays[key] = [];
                }
                customHolidays[key].push(day);
                saveMonthlySchedule();
                renderSchedule();
                window.showMessageBox(`Dia ${day} marcado como feriado.`);
            }
        }
    }
    
    function copyScheduleToNextMonth() {
        if (employees.length === 0) {
            window.showMessageBox('Não há funcionários para copiar a escala.', 3000);
            return;
        }
        if (confirm('Tem certeza que deseja copiar a escala atual para o próximo mês? Isso não apagará as informações já existentes, apenas preencherá os dias úteis. Certifique-se de que não existem informações preenchidas para o próximo mês que você deseja manter.')) {
            let nextMonth = currentMonth + 1;
            let nextYear = currentYear;
            if (nextMonth > 11) {
                nextMonth = 0;
                nextYear++;
            }

            const employeesToWarn = [];
            employees.forEach(emp => {
                const daysInNextMonth = getDaysInMonth(nextYear, nextMonth);
                
                if (!emp.schedule) {
                    emp.schedule = {};
                }

                const currentMonthWorkdays = {};
                let hasWorkdaySchedule = false;
                for (let j = 1; j <= getDaysInMonth(currentYear, currentMonth); j++) {
                    const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(j).padStart(2, '0')}`;
                    if (emp.schedule && emp.schedule[dateKey] && !isVacation(emp, currentYear, currentMonth, j) && !isLeave(emp, currentYear, currentMonth, j, 'LM') && !isLeave(emp, currentYear, currentMonth, j, 'FO')) {
                        const dayOfWeek = new Date(currentYear, currentMonth, j).getDay();
                        if (!currentMonthWorkdays[dayOfWeek]) {
                            currentMonthWorkdays[dayOfWeek] = emp.schedule[dateKey];
                        }
                        hasWorkdaySchedule = true;
                    }
                }

                if (!hasWorkdaySchedule) {
                    employeesToWarn.push(emp.name);
                    return;
                }
                
                for (let i = 1; i <= daysInNextMonth; i++) {
                    const nextMonthDateKey = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    
                    if (isWorkday(emp, nextYear, nextMonth, i) && !emp.schedule[nextMonthDateKey]) {
                        const dayOfWeek = new Date(nextYear, nextMonth, i).getDay();
                        const copiedSigla = currentMonthWorkdays[dayOfWeek];
                        if (copiedSigla) {
                            emp.schedule[nextMonthDateKey] = copiedSigla;
                        } else {
                            delete emp.schedule[nextMonthDateKey];
                        }
                    } else if (!isWorkday(emp, nextYear, nextMonth, i) && emp.schedule && emp.schedule[nextMonthDateKey]) {
                        delete emp.schedule[nextMonthDateKey];
                    }
                }
            });
            
            saveMonthlySchedule();
            let message = 'Escala copiada com sucesso para o próximo mês!';
            if (employeesToWarn.length > 0) {
                message += `\n\nAtenção: A escala de ${employeesToWarn.join(', ')} não foi copiada porque não havia dados de trabalho no mês anterior. Por favor, preencha manualmente.`;
            }
            window.showMessageBox(message, 7000);
            
            currentMonth = nextMonth;
            currentYear = nextYear;
            loadMonthlySchedule();
        }
    }
    
    // --- Print Functionality ---
    function printSchedule() {
        const filteredEmployees = filterEmployees();
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html lang="pt-BR">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Escala - ${document.getElementById('currentMonthYear').textContent}</title>
                <style>
                    body { font-family: 'Inter', sans-serif; margin: 0; padding: 0.5cm; }
                    .printable-content {
                        box-sizing: border-box;
                        overflow: hidden;
                    }
                    .printable-table-container { overflow: visible; }
                    .printable-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                    .printable-table th, .printable-table td {
                        border: 1px solid #000;
                        padding: 1px;
                        text-align: center;
                        font-size: 9px;
                        white-space: normal;
                        word-break: break-word;
                        height: 12px;
                    }
                    .printable-table th { background-color: #e0e0e0; }
                    .printable-table th .day-letter { font-size: 7px; color: #555; }
                    .printable-table .weekend, .printable-table .holiday { background-color: #ccc; }
                    .printable-table .vacation { background-color: #a7d9ff; font-weight: bold; }
                    .printable-table .licenca { background-color: #fde68a; font-weight: bold; }
                    .printable-table .folga { background-color: #9ca3af; color: #fff; font-weight: bold; }
                    .printable-legend {
                        font-size: 10px;
                        margin-top: 15px;
                        border-top: 1px solid #000;
                        padding-top: 8px;
                        page-break-before: avoid;
                    }
                    .printable-legend ul {
                        display: flex;
                        flex-wrap: wrap;
                        list-style: none;
                        padding: 0;
                        margin: 0;
                    }
                    .printable-legend ul li {
                        margin-right: 15px;
                        margin-bottom: 5px;
                        white-space: nowrap;
                    }
                    .printable-legend p {
                        margin-top: 10px;
                        word-wrap: break-word;
                    }
                    .team-sol-print { background-color: #FFD700; color: #333; }
                    .team-verde-print { background-color: #32CD32; color: white; }
                    .team-vermelha-print { background-color: #FF4500; color: white; }
                    .team-azul-print { background-color: #1E90FF; color: white; }
                    .team-laranja-print { background-color: #FFA500; color: #333; }
                    .team-apoio-print { background-color: #D3D3D3; color: #333; }
                    
                    /* AJUSTE: Largura das colunas para impressão (mais finas) */
                    .printable-table th:nth-child(1) { width: 18%; }
                    .printable-table td:nth-child(1) { width: 18%; font-weight: bold; color: #000; }
                    .printable-table th:nth-child(2) { width: 9%; }
                    .printable-table td:nth-child(2) { width: 9%; font-weight: bold; color: #000; }
                    .printable-table th:nth-child(3) { width: 6%; }
                    .printable-table td:nth-child(3) { width: 6%; font-weight: bold; color: #000; }
                    .printable-table th:nth-child(4) { width: 5%; }
                    .printable-table td:nth-child(4) { width: 5%; font-weight: bold; color: #000; }
                    .printable-table th:nth-child(n+5), .printable-table td:nth-child(n+5) {
                        width: auto;
                    }
                    
                    @page {
                        size: landscape;
                        margin: 1cm;
                    }
                </style>
            </head>
            <body>
                <div class="printable-content">
                    <div class="printable-table-container">
                        <table class="printable-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Função</th>
                                    <th>Conselho</th>
                                    <th>Horário</th>
                                    ${Array.from({ length: getDaysInMonth(currentYear, currentMonth) }, (_, i) => {
                                        const day = i + 1;
                                        const date = new Date(currentYear, currentMonth, day);
                                        const dayOfWeek = date.getDay();
                                        const dayLetter = dayOfWeekLetters[dayOfWeek];
                                        const isDayWeekend = isWeekend(null, currentYear, currentMonth, day);
                                        const isDayHoliday = isHoliday(currentYear, currentMonth, day);
                                        let classes = '';
                                        if (isDayWeekend || isDayHoliday) classes = 'weekend';
                                        return `<th class="${classes}">${day} <div class="day-letter">${dayLetter}</div></th>`;
                                    }).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${sortEmployees(filteredEmployees, currentSortKey, sortDirection[currentSortKey] || 'asc').map(emp => {
                                    let rowHtml = `<tr>
                                        <td class="font-medium">${emp.name}</td>
                                        <td>${emp.role}</td>
                                        <td>${emp.council}</td>
                                        <td>${emp.workShift || ''}</td>`;
                                    for (let i = 1; i <= getDaysInMonth(currentYear, currentMonth); i++) {
                                        const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                                        const isDayWeekend = isWeekend(emp, currentYear, currentMonth, i);
                                        const isDayHoliday = isHoliday(currentYear, currentMonth, i);
                                        let cellContent = '';
                                        let cellClasses = '';

                                        if (isVacation(emp, currentYear, currentMonth, i)) {
                                            cellContent = 'FÉRIAS';
                                            cellClasses = 'vacation';
                                            const prevDayIsVacation = isVacation(emp, currentYear, currentMonth, i - 1);
                                            if (!prevDayIsVacation) {
                                                let span = 1;
                                                let j = i + 1;
                                                while (j <= getDaysInMonth(currentYear, currentMonth) && isVacation(emp, currentYear, currentMonth, j)) {
                                                    span++;
                                                    j++;
                                                }
                                                rowHtml += `<td colspan="${span}" class="${cellClasses}">${cellContent}</td>`;
                                                i += (span - 1);
                                            }
                                        } else if (isLeave(emp, currentYear, currentMonth, i, 'LM')) {
                                            cellContent = 'LM';
                                            cellClasses = 'licenca';
                                            rowHtml += `<td class="${cellClasses}">${cellContent}</td>`;
                                        } else if (isLeave(emp, currentYear, currentMonth, i, 'FO')) {
                                            cellContent = 'FO';
                                            cellClasses = 'folga';
                                            rowHtml += `<td class="${cellClasses}">${cellContent}</td>`;
                                        } else {
                                            const siglas = emp.schedule && emp.schedule[dateKey] ? emp.schedule[dateKey] : [];
                                            cellContent = Array.isArray(siglas) ? siglas.join(', ') : siglas;
                                            if (isDayWeekend || isDayHoliday) {
                                                cellClasses = 'weekend';
                                            }
                                            rowHtml += `<td class="${cellClasses}">${cellContent}</td>`;
                                        }
                                    }
                                    rowHtml += `</tr>`;
                                    return rowHtml;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="printable-legend">
                        <h3>Legenda:</h3>
                        <ul>
                            ${customSiglas.map(s => `<li><strong>${s.abbr}:</strong> ${s.name}</li>`).join('')}
                            <li><strong>LM:</strong> Licença Médica</li>
                            <li><strong>FO:</strong> Folga</li>
                        </ul>
                        <p><strong>Observações:</strong> ${monthlyObservations[`${currentYear}-${currentMonth + 1}`] || 'Nenhuma observação para este mês.'}</p>
                    </div>
                </div>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                         // ID de usuário fixo conforme você forneceu
                        userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
                    } else {
                        try {
                            const anonUser = await signInAnonymously(auth);
                            // ID de usuário fixo conforme você forneceu
                            userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
                        } catch (error) {
                            console.error("Erro ao autenticar no Firebase:", error);
                            window.showMessageBox(`Erro de autenticação: ${error.message}`, 5000);
                            userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
                        }
                    }
                    isAuthReady = true;
                    // Carregamento de dados inicial
                    await loadSiglas();
                    await loadEmployeesMaster();
                    await loadMonthlySchedule();
                });
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                window.showMessageBox(`Erro ao inicializar o banco de dados: ${error.message}. Usando armazenamento local.`, 7000);
                userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
                isAuthReady = true;
                await loadSiglas();
                await loadEmployeesMaster();
                await loadMonthlySchedule();
            }
        } else {
            userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
            isAuthReady = true;
            await loadSiglas();
            await loadEmployeesMaster();
            await loadMonthlySchedule();
        }

        document.getElementById('employeeRole').addEventListener('change', function() {
            const customRoleField = document.getElementById('customEmployeeRole');
            if (this.value === 'Outro') {
                customRoleField.classList.remove('hidden');
            } else {
                customRoleField.classList.add('hidden');
                customRoleField.value = '';
            }
        });

        document.getElementById('addEmployeeBtn').addEventListener('click', addEmployee);
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            loadMonthlySchedule();
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            loadMonthlySchedule();
        });
        
        document.getElementById('filterName').addEventListener('input', renderSchedule);
        document.getElementById('filterRole').addEventListener('input', renderSchedule);
        document.getElementById('filterWorkShift').addEventListener('input', renderSchedule);
        document.getElementById('filterTeam').addEventListener('change', renderSchedule);

        document.getElementById('applySiglaMonthBtn').addEventListener('click', applySiglaMonth);
        document.getElementById('clearSiglasMonthBtn').addEventListener('click', clearSiglasForMonth);
        document.getElementById('applyVacationBtn').addEventListener('click', () => applyLeaveOrVacation('vacation'));
        document.getElementById('applyFolgaBtn').addEventListener('click', () => applyLeaveOrVacation('folga'));
        document.getElementById('applyLicencaBtn').addEventListener('click', () => applyLeaveOrVacation('licenca'));
        document.getElementById('clearVacationBtn').addEventListener('click', clearVacation);
        document.getElementById('clearLeaveBtn').addEventListener('click', clearLeave);
        document.getElementById('clearEmployeeScheduleBtn').addEventListener('click', clearEmployeeSchedule);
        document.getElementById('printScheduleBtn').addEventListener('click', printSchedule);
        document.getElementById('copyScheduleBtn').addEventListener('click', copyScheduleToNextMonth);
        document.getElementById('saveScheduleBtn').addEventListener('click', saveAllData);
        document.getElementById('manageSiglasBtn').addEventListener('click', openManageSiglasModal);
        document.getElementById('monthlyObservations').addEventListener('input', saveMonthlySchedule);
        
        document.getElementById('addSiglaBtn').addEventListener('click', addSigla);

        renderCurrentMonthYear();
    });
</script>
