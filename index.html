<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala do Centro de Saúde</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
            color: #334155; /* Darker text */
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .header {
            background-color: #4a90e2; /* Blue header */
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary {
            background-color: #4a90e2;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #357ABD;
        }
        .btn-secondary {
            background-color: #64748b; /* Gray */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #475569;
        }
        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .input-field {
            border: 1px solid #cbd5e1; /* Light gray border */
            padding: 0.75rem;
            border-radius: 0.5rem;
            width: 100%;
            box-sizing: border-box;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }
        .schedule-table-container {
            overflow-x: auto;
            margin-top: 2rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure table doesn't get too small on narrow screens */
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #e2e8f0; /* Light gray table borders */
            padding: 0.25rem; /* Smaller padding */
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping in cells */
            font-size: 0.75rem; /* text-xs */
        }
        .schedule-table th {
            background-color: #e2e8f0; /* Light gray header */
            font-weight: 600;
        }
        .schedule-table tbody tr:hover {
            background-color: #f8fafc; /* Lighter on hover */
        }
        .weekend, .holiday {
            background-color: #cbd5e1; /* Darker gray for weekends/holidays */
            color: #475569;
        }
        .vacation {
            background-color: #93c5fd; /* Light blue for vacations */
            color: #1e40af;
            font-weight: 600;
        }
        /* New colors for LM/FO */
        .licenca {
            background-color: #fcd34d; /* Yellow */
            color: #78350f;
            font-weight: 600;
        }
        .folga {
            background-color: #6b7280; /* Dark gray */
            color: #ffffff;
            font-weight: 600;
        }

        .printable-table {
            width: 100%;
            border-collapse: collapse;
        }
        .printable-table th, .printable-table td {
            border: 1px solid #000;
            padding: 4px;
            text-align: center;
            font-size: 10px;
        }
        .printable-table .weekend, .printable-table .holiday {
            background-color: #ccc;
        }
        .printable-table .vacation {
            background-color: #a7d9ff;
        }
        .printable-table .licenca {
            background-color: #fde68a;
        }
        .printable-table .folga {
            background-color: #9ca3af;
            color: #fff;
        }

        .printable-legend {
            font-size: 10px;
            margin-top: 20px;
            border-top: 1px solid #000;
            padding-top: 10px;
        }

        /* Team Colors */
        .team-sol { background-color: #FFD700; color: #333; } /* Gold */
        .team-verde { background-color: #32CD32; color: white; } /* LimeGreen */
        .team-vermelha { background-color: #FF4500; color: white; } /* OrangeRed */
        .team-azul { background-color: #1E90FF; color: white; } /* DodgerBlue */
        .team-laranja { background-color: #FFA500; color: #333; } /* Orange */
        .team-apoio { background-color: #D3D3D3; color: #333; } /* LightGray */


        @media print {
            body {
                font-size: 8px; /* Base font size for print */
                margin: 0;
                padding: 0;
            }
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 1cm; /* Add some padding to the print content */
                box-sizing: border-box;
                overflow: hidden; /* Hide scrollbars */
            }
            .printable-header {
                text-align: center;
                margin-bottom: 10px;
                font-size: 14px; /* Slightly larger for header */
            }
            .printable-table-container {
                width: 100%;
                overflow: visible; /* Allow table to expand */
            }
            .printable-table {
                width: 100%;
                border-collapse: collapse;
                table-layout: fixed; /* Fix table layout */
            }
            .printable-table th, .printable-table td {
                font-size: 7px; /* Smaller font for table cells */
                padding: 2px;
                text-align: center;
                white-space: normal; /* Allow wrapping for print */
                word-break: break-word; /* Break long words */
            }
            /* Adjust column widths for print if needed */
            .printable-table th:nth-child(1) { width: 12%; } /* Nome */
            .printable-table th:nth-child(2) { width: 8%; } /* Função */
            .printable-table th:nth-child(3) { width: 10%; } /* Conselho */
            .printable-table th:nth-child(4) { width: 8%; } /* Horário de Trabalho */
            /* Calculate remaining width for days dynamically */
            .printable-table th:nth-child(n+5) { width: calc(62% / ${getDaysInMonth(new Date().getFullYear(), new Date().getMonth())}); } /* Days (placeholder, actual value calculated on print) */

            .printable-legend {
                font-size: 8px; /* Smaller font for legend */
                margin-top: 15px;
                border-top: 1px solid #000;
                padding-top: 8px;
                page-break-before: avoid; /* Avoid breaking page before legend */
            }
            .printable-legend ul {
                display: flex;
                flex-wrap: wrap;
                justify-content: flex-start; /* Align items to the start */
                list-style: none; /* Remove bullet points */
                padding: 0;
                margin: 0;
            }
            .printable-legend ul li {
                margin-right: 15px; /* Spacing between horizontal legend items */
                margin-bottom: 5px; /* Small vertical spacing for wrapping */
                white-space: nowrap; /* Keep each legend item on one line */
            }
            .printable-legend p {
                margin-top: 10px;
                word-wrap: break-word; /* Allow observations to wrap */
            }


            .printable-footer {
                position: fixed;
                bottom: 20px;
                left: 0;
                width: 100%;
                text-align: center;
                font-size: 10px;
            }
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <div class="header">
            <h1 class="text-3xl font-bold mb-2">Escala do Centro de Saúde</h1>
            <p class="text-lg">Gerencie a escala da sua equipe de forma fácil e eficiente.</p>
        </div>

        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="btn-secondary px-4 py-2 rounded-lg">&lt; Mês Anterior</button>
            <h2 id="currentMonthYear" class="text-2xl font-semibold text-gray-700"></h2>
            <button id="nextMonth" class="btn-secondary px-4 py-2 rounded-lg">Próximo Mês &gt;</button>
        </div>

        <div class="bg-blue-50 p-6 rounded-lg shadow-md mb-8">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">Gerenciamento de Funcionários</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <input type="text" id="employeeName" placeholder="Nome do Funcionário" class="input-field">
                <select id="employeeRole" class="input-field">
                    <option value="">Selecione a Função</option>
                    <option value="Técnico de Enfermagem">Técnico de Enfermagem</option>
                    <option value="Enfermeiro">Enfermeiro</option>
                    <option value="Outro">Outro</option>
                </select>
                <input type="text" id="customEmployeeRole" placeholder="Função Personalizada" class="input-field hidden">
                <input type="text" id="employeeCouncil" placeholder="Registro do Conselho" class="input-field">
                <input type="text" id="employeeWorkShift" placeholder="Horário de Trabalho (Ex: 08h-17h)" class="input-field">
            </div>
            <div class="mb-4">
                <label for="employeeTeam" class="block text-sm font-medium text-gray-700 mb-1">Equipe:</label>
                <select id="employeeTeam" class="input-field">
                    <option value="">Selecione a Equipe</option>
                    <option value="Sol">Sol</option>
                    <option value="Verde">Verde</option>
                    <option value="Vermelha">Vermelha</option>
                    <option value="Azul">Azul</option>
                    <option value="Laranja">Laranja</option>
                    <option value="Apoio">Apoio</option>
                </select>
            </div>
            <button id="addEmployeeBtn" class="btn-primary w-full md:w-auto">Adicionar Funcionário</button>

            <div id="employeeList" class="mt-6">
                <h4 class="text-lg font-medium mb-3 text-gray-700">Funcionários Cadastrados:</h4>
                <ul id="employeesUl" class="space-y-2">
                    </ul>
            </div>
        </div>

        <div class="schedule-table-container">
            <table id="scheduleTable" class="schedule-table">
                <thead>
                    <tr id="scheduleHeader">
                        <th class="w-1/6">Nome</th>
                        <th class="w-1/12">Função</th>
                        <th class="w-1/12">Conselho</th>
                        <th class="w-1/12">Horário de Trabalho</th>
                        </tr>
                </thead>
                <tbody id="scheduleBody">
                    </tbody>
            </table>
        </div>

        <div class="bg-blue-50 p-6 rounded-lg shadow-md mt-8">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">Observações Mensais</h3>
            <textarea id="monthlyObservations" class="input-field h-32 resize-y" placeholder="Adicione observações importantes para este mês..."></textarea>
        </div>

        <div class="flex justify-center mt-8 space-x-4">
            <button id="printScheduleBtn" class="btn-primary">Imprimir Escala</button>
            <button id="transcribeScheduleBtn" class="btn-secondary">Transcrever para o Próximo Mês</button>
            <button id="saveScheduleBtn" class="btn-primary">Salvar Escala</button>
            <button id="manageSiglasBtn" class="btn-secondary">Gerir Siglas</button>
        </div>
    </div>

    <div id="siglaVacationModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-button" onclick="window.closeSiglaVacationModal()">&times;</button>
            <h3 id="modalEmployeeName" class="text-2xl font-bold mb-4 text-blue-700"></h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="siglaSectionMonth" class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar Sigla(s) para o Mês</h4>
                    <div class="mb-4 space-y-2" id="siglaCheckboxesMonth">
                        </div>
                    <button id="applySiglaMonthBtn" class="btn-primary w-full">Aplicar Sigla(s) para o Mês</button>
                    <button id="clearSiglasMonthBtn" class="btn-secondary w-full mt-2">Limpar Siglas do Mês</button>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h4 class="text-lg font-semibold mb-3 text-gray-800">Adicionar Férias, Folga ou Licença Médica</h4>
                    <div class="mb-4">
                        <label for="dateRangeStart" class="block text-sm font-medium text-gray-700 mb-1">Início:</label>
                        <input type="date" id="dateRangeStart" class="input-field">
                    </div>
                    <div class="mb-4">
                        <label for="dateRangeEnd" class="block text-sm font-medium text-gray-700 mb-1">Fim:</label>
                        <input type="date" id="dateRangeEnd" class="input-field">
                    </div>
                    <div class="flex flex-col space-y-2">
                        <button id="applyVacationBtn" class="btn-primary w-full">Aplicar Férias</button>
                        <button id="applyFolgaBtn" class="btn-secondary w-full">Aplicar Folga (FO)</button>
                        <button id="applyLicencaBtn" class="btn-secondary w-full">Aplicar Licença (LM)</button>
                    </div>
                    <button id="clearVacationBtn" class="btn-danger w-full mt-4">Limpar Férias</button>
                    <button id="clearLeaveBtn" class="btn-danger w-full mt-2">Limpar Licenças e Folgas</button>
                </div>
            </div>
            <button id="clearEmployeeScheduleBtn" class="btn-danger w-full mt-6">Limpar Toda a Escala do Funcionário</button>
        </div>
    </div>
    
    <div id="manageSiglasModal" class="modal hidden">
        <div class="modal-content">
            <button class="close-button" onclick="window.closeManageSiglasModal()">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-blue-700">Gerir Siglas Personalizadas</h3>
            <div class="bg-gray-50 p-4 rounded-lg shadow-sm mb-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="siglaAbbr" placeholder="Sigla (Ex: SOE)" class="input-field">
                    <input type="text" id="siglaName" placeholder="Nome Completo (Ex: Sala de Observação)" class="input-field">
                    <input type="text" id="siglaColor" placeholder="Cor CSS (Ex: #FFD700)" class="input-field">
                </div>
                <button id="addSiglaBtn" class="btn-primary w-full">Adicionar Sigla</button>
            </div>
            <div id="siglasList" class="mt-4">
                <h4 class="text-lg font-medium mb-2 text-gray-700">Siglas Atuais:</h4>
                <ul id="siglasUl" class="space-y-2">
                    </ul>
            </div>
        </div>
    </div>


    <div id="messageBox" class="fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg hidden z-2000">
        <p id="messageText"></p>
        <button class="ml-4 text-white font-bold" onclick="window.hideMessageBox()">&times;</button>
    </div>

    <script type="module">
        // Global variables for Firebase configuration and app ID
        const appId = "1:1040621794903:web:61518f984286e11fb29512"; // SEU APP ID DO FIREBASE (CORRIGIDO)
        const firebaseConfig = {
            apiKey: "AIzaSyALs6IeL242UJH7uXpa-0mQq_CN_RA-xWA",
            authDomain: "escalasaudeapp.firebaseapp.com",
            projectId: "escalasaudeapp",
            storageBucket: "escalasaudeapp.firebasestorage.app",
            messagingSenderId: "1040621794903",
            appId: "1:1040621794903:web:61518f984286e11fb29512",
            measurementId: "G-YHH987DD5J"
        };
        const initialAuthToken = null;

        let db;
        let auth;
        let userId;
        let isAuthReady = false;

        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let employees = [];
        let currentEditingEmployeeId = null;
        let monthlyObservations = {};
        let customSiglas = [
            { id: '1', abbr: 'F', name: 'Farmácia', color: '#fca5a5' }, // Red-300
            { id: '2', abbr: 'S', name: 'Sala de Observação', color: '#fdba74' }, // Orange-300
            { id: '3', abbr: 'P', name: 'Presente', color: '#86efac' }, // Green-300
            { id: '4', abbr: 'CT', name: 'Curativo', color: '#bfdbfe' }, // Blue-300
            { id: '5', abbr: 'BR', name: 'Acolhimento Baixo Risco', color: '#a5b4fc' }, // Indigo-300
            { id: '6', abbr: 'E', name: 'ECG', color: '#c4b5fd' }, // Violet-300
            { id: '7', abbr: 'V', name: 'Vacina', color: '#c7d2fe' }, // Indigo-200
            { id: '8', abbr: 'T', name: 'Totem', color: '#a0aec0' }, // Gray-500
            { id: '9', abbr: 'C', name: 'Consultórios', color: '#a0e4a7' }, // Custom light green
        ];
        
        const specialSiglas = ['FO', 'LM'];

        // --- Utility Functions ---
        window.showMessageBox = function(message, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            document.getElementById('messageText').textContent = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                window.hideMessageBox();
            }, duration);
        }

        window.hideMessageBox = function() {
            document.getElementById('messageBox').classList.add('hidden');
        }

        function getDocRef(collectionName) {
            return doc(db, 'artifacts', appId, 'users', userId, collectionName, 'data');
        }
        
        async function saveData(collectionName, data) {
            if (userId && db) {
                const docRef = getDocRef(collectionName);
                await setDoc(docRef, { data: JSON.stringify(data) })
                    .catch(error => console.error(`Erro ao salvar ${collectionName} no Firestore:`, error));
            } else {
                localStorage.setItem(`healthSchedule${collectionName}`, JSON.stringify(data));
            }
        }
        
        async function loadData(collectionName, fallbackData) {
            if (userId && db) {
                const docRef = getDocRef(collectionName);
                try {
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        return JSON.parse(docSnap.data().data);
                    }
                } catch (error) {
                    console.error(`Erro ao carregar ${collectionName} do Firestore:`, error);
                }
            } else {
                const storedData = localStorage.getItem(`healthSchedule${collectionName}`);
                if (storedData) return JSON.parse(storedData);
            }
            return fallbackData;
        }

        function saveEmployees() { saveData('employees_master', employees); }
        async function loadEmployees() {
            employees = await loadData('employees_master', []);
            renderEmployeeList();
            renderSchedule();
        }

        function saveMonthlyObservations() {
            const key = `${currentYear}-${currentMonth + 1}`;
            monthlyObservations[key] = document.getElementById('monthlyObservations').value;
            saveData('observations', monthlyObservations);
        }

        async function loadMonthlyObservations() {
            monthlyObservations = await loadData('observations', {});
            const key = `${currentYear}-${currentMonth + 1}`;
            document.getElementById('monthlyObservations').value = monthlyObservations[key] || '';
        }
        
        function saveSiglas() { saveData('custom_siglas', customSiglas); }
        async function loadSiglas() {
            const loadedSiglas = await loadData('custom_siglas', []);
            if (loadedSiglas.length > 0) {
                customSiglas = loadedSiglas;
            }
        }

        function saveAllData() {
            saveEmployees();
            saveMonthlyObservations();
            saveSiglas();
            window.showMessageBox('Escala salva com sucesso!');
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function isWeekend(year, month, day) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6; // Sunday (0) or Saturday (6)
        }
        
        // Brazilian National Holidays (example for 2025)
        const nationalHolidays = [
            '2025-01-01', '2025-03-03', '2025-03-04', '2025-04-18', '2025-04-21', 
            '2025-05-01', '2025-06-19', '2025-09-07', '2025-10-12', '2025-11-02', 
            '2025-11-15', '2025-12-25'
        ];

        function isHoliday(year, month, day) {
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            return nationalHolidays.includes(dateString);
        }

        function isVacation(employee, year, month, day) {
            const currentDate = new Date(year, month, day);
            if (!employee.vacations) return false;
            for (const vacation of employee.vacations) {
                const startDate = new Date(vacation.start);
                const endDate = new Date(vacation.end);
                startDate.setHours(0,0,0,0);
                endDate.setHours(0,0,0,0);
                currentDate.setHours(0,0,0,0);
                if (currentDate >= startDate && currentDate <= endDate) return true;
            }
            return false;
        }

        function isLeave(employee, year, month, day, type) {
            const currentDate = new Date(year, month, day);
            const leaves = employee.leaves || [];
            for (const leave of leaves) {
                if (leave.type === type) {
                    const startDate = new Date(leave.start);
                    const endDate = new Date(leave.end);
                    startDate.setHours(0,0,0,0);
                    endDate.setHours(0,0,0,0);
                    currentDate.setHours(0,0,0,0);
                    if (currentDate >= startDate && currentDate <= endDate) return true;
                }
            }
            return false;
        }
        
        // --- Render Functions ---
        function renderCurrentMonthYear() {
            const date = new Date(currentYear, currentMonth);
            document.getElementById('currentMonthYear').textContent = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
        }

        function getTeamColorClass(team) {
            switch (team) {
                case 'Sol': return 'team-sol';
                case 'Verde': return 'team-verde';
                case 'Vermelha': return 'team-vermelha';
                case 'Azul': return 'team-azul';
                case 'Laranja': return 'team-laranja';
                case 'Apoio': return 'team-apoio';
                default: return '';
            }
        }

        function sortEmployees(empArray) {
            return [...empArray].sort((a, b) => {
                const roleA = a.role.toLowerCase();
                const roleB = b.role.toLowerCase();
                const shiftA = a.workShift || '';
                const shiftB = b.workShift || '';

                // 1. Sort by role
                if (roleA.includes('técnico de enfermagem') && !roleB.includes('técnico de enfermagem')) return -1;
                if (!roleA.includes('técnico de enfermagem') && roleB.includes('técnico de enfermagem')) return 1;

                if (roleA.includes('enfermeiro') && !roleB.includes('enfermeiro')) return -1;
                if (!roleA.includes('enfermeiro') && roleB.includes('enfermeiro')) return 1;

                // 2. Sort by work shift (crescente)
                if (shiftA < shiftB) return -1;
                if (shiftA > shiftB) return 1;
                
                // 3. Sort by name
                return a.name.localeCompare(b.name);
            });
        }

        function renderEmployeeList() {
            const employeesUl = document.getElementById('employeesUl');
            employeesUl.innerHTML = '';
            if (employees.length === 0) {
                employeesUl.innerHTML = '<li class="text-gray-500">Nenhum funcionário cadastrado.</li>';
                return;
            }

            const sortedEmployees = sortEmployees(employees);
            sortedEmployees.forEach(emp => {
                const li = document.createElement('li');
                const teamColorClass = getTeamColorClass(emp.team);
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm border border-gray-200';
                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-medium text-blue-600 cursor-pointer" onclick="window.openSiglaVacationModal('${emp.id}')">${emp.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(${emp.role} - ${emp.council} - ${emp.workShift})</span>
                        <span class="inline-block px-2 py-1 rounded-full text-xs font-semibold ${teamColorClass} ml-2">${emp.team}</span>
                        <span class="text-xs text-gray-400 block break-all">ID: ${emp.id}</span>
                    </div>
                    <div>
                        <button onclick="window.deleteEmployee('${emp.id}')" class="btn-danger ml-2">Excluir</button>
                    </div>
                `;
                employeesUl.appendChild(li);
            });
        }

        function renderSchedule() {
            renderCurrentMonthYear();
            const scheduleHeader = document.getElementById('scheduleHeader');
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleHeader.innerHTML = `
                <th class="w-1/6">Nome</th>
                <th class="w-1/12">Função</th>
                <th class="w-1/12">Conselho</th>
                <th class="w-1/12">Horário de Trabalho</th>
            `;
            scheduleBody.innerHTML = '';

            const daysInMonth = getDaysInMonth(currentYear, currentMonth);

            // Add day headers
            for (let i = 1; i <= daysInMonth; i++) {
                const th = document.createElement('th');
                th.textContent = i;
                if (isWeekend(currentYear, currentMonth, i) || isHoliday(currentYear, currentMonth, i)) {
                    th.classList.add('weekend');
                }
                scheduleHeader.appendChild(th);
            }

            const sortedEmployees = sortEmployees(employees);

            // Add employee rows
            sortedEmployees.forEach(emp => {
                const tr = document.createElement('tr');
                const teamColorClass = getTeamColorClass(emp.team);
                tr.innerHTML = `
                    <td class="font-medium text-blue-600 cursor-pointer ${teamColorClass}" onclick="window.openSiglaVacationModal('${emp.id}')">
                        ${emp.name}
                    </td>
                    <td>${emp.role}</td>
                    <td>${emp.council}</td>
                    <td>${emp.workShift || ''}</td>
                `;
                for (let i = 1; i <= daysInMonth; i++) {
                    const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const td = document.createElement('td');
                    td.setAttribute('data-employee-id', emp.id);
                    td.setAttribute('data-date-key', dateKey);
                    td.onclick = function() { window.openSiglaVacationModal(emp.id, dateKey); };

                    // Handle Vacations (with cell merge)
                    if (isVacation(emp, currentYear, currentMonth, i)) {
                        td.classList.add('vacation');
                        td.textContent = 'FÉRIAS';
                        const prevDayIsVacation = isVacation(emp, currentYear, currentMonth, i - 1);
                        if (!prevDayIsVacation) {
                            let span = 1;
                            let j = i + 1;
                            while (j <= daysInMonth && isVacation(emp, currentYear, currentMonth, j)) {
                                span++;
                                j++;
                            }
                            td.colSpan = span;
                            tr.appendChild(td);
                            i += (span - 1);
                        }
                    } else if (isLeave(emp, currentYear, currentMonth, i, 'LM')) {
                        td.classList.add('licenca');
                        td.textContent = 'LM';
                        tr.appendChild(td);
                    } else if (isLeave(emp, currentYear, currentMonth, i, 'FO')) {
                        td.classList.add('folga');
                        td.textContent = 'FO';
                        tr.appendChild(td);
                    } else {
                        const siglas = emp.schedule && emp.schedule[dateKey] ? emp.schedule[dateKey] : [];
                        td.textContent = Array.isArray(siglas) ? siglas.join(', ') : siglas;
                        if (isWeekend(currentYear, currentMonth, i) || isHoliday(currentYear, currentMonth, i)) {
                            td.classList.add('weekend');
                        }
                        tr.appendChild(td);
                    }
                }
                scheduleBody.appendChild(tr);
            });
            loadMonthlyObservations();
        }

        function renderSiglaCheckboxes(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            // Add custom siglas
            customSiglas.forEach(sigla => {
                const label = document.createElement('label');
                label.className = 'flex items-center';
                label.innerHTML = `<input type="checkbox" name="sigla" value="${sigla.abbr}" class="mr-2"> ${sigla.abbr} (${sigla.name})`;
                container.appendChild(label);
            });
            // Add special siglas
            // We can add LM/FO here if needed for general month, but user wants them as date ranges
            // Let's keep them separate to match the user's request.
        }

        // --- Employee Actions ---
        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            let role = document.getElementById('employeeRole').value.trim();
            const customRole = document.getElementById('customEmployeeRole').value.trim();
            const council = document.getElementById('employeeCouncil').value.trim();
            const workShift = document.getElementById('employeeWorkShift').value.trim();
            const team = document.getElementById('employeeTeam').value.trim();

            if (role === 'Outro') {
                role = customRole;
            }

            if (name && role && council && workShift && team) {
                const newEmployee = {
                    id: crypto.randomUUID(),
                    name,
                    role,
                    council,
                    workShift,
                    team,
                    schedule: {},
                    vacations: [],
                    leaves: [] // New: stores LM/FO periods
                };
                employees.push(newEmployee);
                saveEmployees();
                renderEmployeeList();
                renderSchedule();
                // Clear form
                document.getElementById('employeeName').value = '';
                document.getElementById('employeeRole').value = '';
                document.getElementById('customEmployeeRole').value = '';
                document.getElementById('customEmployeeRole').classList.add('hidden');
                document.getElementById('employeeCouncil').value = '';
                document.getElementById('employeeWorkShift').value = '';
                document.getElementById('employeeTeam').value = '';
                window.showMessageBox('Funcionário adicionado com sucesso!');
            } else {
                window.showMessageBox('Por favor, preencha todos os campos do funcionário.', 4000);
            }
        }

        window.deleteEmployee = function(id) {
            if (confirm('Tem certeza que deseja excluir este funcionário?')) {
                employees = employees.filter(emp => emp.id !== id);
                saveEmployees();
                renderEmployeeList();
                renderSchedule();
                window.showMessageBox('Funcionário excluído.');
            }
        }

        // --- Modal Functions ---
        window.openSiglaVacationModal = function(employeeId) {
            currentEditingEmployeeId = employeeId;
            const employee = employees.find(emp => emp.id === employeeId);
            if (employee) {
                document.getElementById('modalEmployeeName').textContent = `Editar Escala de: ${employee.name}`;
                document.getElementById('siglaVacationModal').classList.remove('hidden');
                document.getElementById('dateRangeStart').value = '';
                document.getElementById('dateRangeEnd').value = '';
                renderSiglaCheckboxes('siglaCheckboxesMonth');

                // Pre-check siglas for the month based on existing data
                const checkboxesMonth = document.querySelectorAll('#siglaCheckboxesMonth input[type="checkbox"]');
                checkboxesMonth.forEach(cb => cb.checked = false);
                const daysInMonth = getDaysInMonth(currentYear, currentMonth);
                const currentMonthSiglas = new Set();
                for (let i = 1; i <= daysInMonth; i++) {
                    const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const siglasForDay = employee.schedule && employee.schedule[dateKey] ? employee.schedule[dateKey] : [];
                    if (Array.isArray(siglasForDay)) {
                        siglasForDay.forEach(sigla => currentMonthSiglas.add(sigla));
                    }
                }
                currentMonthSiglas.forEach(sigla => {
                    const checkbox = document.querySelector(`#siglaCheckboxesMonth input[value="${sigla}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
        }

        window.closeSiglaVacationModal = function() {
            document.getElementById('siglaVacationModal').classList.add('hidden');
            currentEditingEmployeeId = null;
        }

        function applySiglaMonth() {
            const selectedSiglas = Array.from(document.querySelectorAll('#siglaCheckboxesMonth input[type="checkbox"]:checked')).map(cb => cb.value);

            if (selectedSiglas.length === 0) {
                window.showMessageBox('Por favor, selecione ao menos uma sigla.', 3000);
                return;
            }

            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;

            const employee = employees[employeeIndex];
            const daysInMonth = getDaysInMonth(currentYear, currentMonth);

            for (let i = 1; i <= daysInMonth; i++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                if (!isWeekend(currentYear, currentMonth, i) && !isHoliday(currentYear, currentMonth, i) && !isVacation(employee, currentYear, currentMonth, i) && !isLeave(employee, currentYear, currentMonth, i, 'FO') && !isLeave(employee, currentYear, currentMonth, i, 'LM')) {
                    employee.schedule[dateKey] = selectedSiglas;
                }
            }
            saveEmployees();
            renderSchedule();
            window.showMessageBox('Sigla(s) aplicada(s) para os dias úteis do mês.');
            window.closeSiglaVacationModal();
        }

        function clearSiglasForMonth() {
            if (confirm('Tem certeza que deseja limpar TODAS as siglas deste funcionário para o mês atual?')) {
                const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
                if (employeeIndex === -1) return;

                const employee = employees[employeeIndex];
                const daysInMonth = getDaysInMonth(currentYear, currentMonth);

                for (let i = 1; i <= daysInMonth; i++) {
                    const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    if (employee.schedule && employee.schedule[dateKey]) {
                        delete employee.schedule[dateKey];
                    }
                }
                saveEmployees();
                renderSchedule();
                window.showMessageBox('Siglas do funcionário para o mês atual limpas.');
                window.closeSiglaVacationModal();
            }
        }
        
        function applyLeaveOrVacation(type) {
            const startDate = document.getElementById('dateRangeStart').value;
            const endDate = document.getElementById('dateRangeEnd').value;
            
            if (!startDate || !endDate) {
                window.showMessageBox(`Por favor, selecione as datas de início e fim.`, 4000);
                return;
            }
            
            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;
            const employee = employees[employeeIndex];
            
            // Clear any existing schedule entries within the period
            let tempDate = new Date(startDate);
            const end = new Date(endDate);
            while (tempDate <= end) {
                const dateKey = `${tempDate.getFullYear()}-${String(tempDate.getMonth() + 1).padStart(2, '0')}-${String(tempDate.getDate()).padStart(2, '0')}`;
                if (employee.schedule && employee.schedule[dateKey]) {
                    delete employee.schedule[dateKey];
                }
                tempDate.setDate(tempDate.getDate() + 1);
            }
            
            if (type === 'vacation') {
                if (!employee.vacations) employee.vacations = [];
                employee.vacations.push({ start: startDate, end: endDate });
                window.showMessageBox('Férias aplicadas com sucesso!');
            } else {
                if (!employee.leaves) employee.leaves = [];
                employee.leaves.push({ start: startDate, end: endDate, type: type.toUpperCase() });
                window.showMessageBox(`${type === 'folga' ? 'Folga' : 'Licença Médica'} aplicada com sucesso!`);
            }
            
            saveEmployees();
            renderSchedule();
            window.closeSiglaVacationModal();
        }

        function clearVacation() {
            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;
            employees[employeeIndex].vacations = [];
            saveEmployees();
            renderSchedule();
            window.showMessageBox('Férias do funcionário limpas.');
            window.closeSiglaVacationModal();
        }
        
        function clearLeave() {
            const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
            if (employeeIndex === -1) return;
            employees[employeeIndex].leaves = [];
            saveEmployees();
            renderSchedule();
            window.showMessageBox('Licenças e folgas do funcionário limpas.');
            window.closeSiglaVacationModal();
        }

        function clearEmployeeSchedule() {
            if (confirm('Tem certeza que deseja limpar toda a escala e férias deste funcionário? Isso é irreversível.')) {
                const employeeIndex = employees.findIndex(emp => emp.id === currentEditingEmployeeId);
                if (employeeIndex === -1) return;

                const employee = employees[employeeIndex];
                employee.schedule = {};
                employee.vacations = [];
                employee.leaves = [];
                saveEmployees();
                renderSchedule();
                window.showMessageBox('Escala e férias do funcionário limpas.');
                window.closeSiglaVacationModal();
            }
        }
        
        // --- Sigla Management Functions ---
        window.openManageSiglasModal = function() {
            document.getElementById('manageSiglasModal').classList.remove('hidden');
            renderSiglasList();
        }

        window.closeManageSiglasModal = function() {
            document.getElementById('manageSiglasModal').classList.add('hidden');
            // Clear input fields
            document.getElementById('siglaAbbr').value = '';
            document.getElementById('siglaName').value = '';
            document.getElementById('siglaColor').value = '';
        }

        function addSigla() {
            const abbr = document.getElementById('siglaAbbr').value.trim().toUpperCase();
            const name = document.getElementById('siglaName').value.trim();
            const color = document.getElementById('siglaColor').value.trim();
            
            if (abbr && name && color) {
                customSiglas.push({ id: crypto.randomUUID(), abbr, name, color });
                saveSiglas();
                renderSiglasList();
                window.showMessageBox('Sigla adicionada com sucesso!');
                // Clear input fields
                document.getElementById('siglaAbbr').value = '';
                document.getElementById('siglaName').value = '';
                document.getElementById('siglaColor').value = '';
            } else {
                window.showMessageBox('Por favor, preencha todos os campos da sigla.', 3000);
            }
        }

        window.deleteSigla = function(id) {
            if (confirm('Tem certeza que deseja excluir esta sigla?')) {
                customSiglas = customSiglas.filter(s => s.id !== id);
                saveSiglas();
                renderSiglasList();
                window.showMessageBox('Sigla excluída.');
            }
        }
        
        function renderSiglasList() {
            const siglasUl = document.getElementById('siglasUl');
            siglasUl.innerHTML = '';
            customSiglas.forEach(s => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm border border-gray-200';
                li.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-medium text-blue-600">${s.abbr}</span>
                        <span class="text-sm text-gray-500 ml-2">(${s.name})</span>
                        <span class="text-xs text-gray-400 ml-2">Cor: ${s.color}</span>
                    </div>
                    <div>
                        <button onclick="window.deleteSigla('${s.id}')" class="btn-danger ml-2">Excluir</button>
                    </div>
                `;
                siglasUl.appendChild(li);
            });
        }
        
        // --- Transcribe Functionality ---
        function copyScheduleToNextMonth() {
            if (employees.length === 0) {
                window.showMessageBox('Não há funcionários para transcrever a escala.', 3000);
                return;
            }
            if (confirm('Tem certeza que deseja transcrever a escala atual para o próximo mês? Isso substituirá a escala existente do próximo mês.')) {
                let nextMonth = currentMonth + 1;
                let nextYear = currentYear;
                if (nextMonth > 11) {
                    nextMonth = 0;
                    nextYear++;
                }
                const nextMonthKey = `${nextYear}-${nextMonth + 1}`;
                const currentMonthKey = `${currentYear}-${currentMonth + 1}`;
                
                const daysInCurrentMonth = getDaysInMonth(currentYear, currentMonth);
                const daysInNextMonth = getDaysInMonth(nextYear, nextMonth);

                employees.forEach(emp => {
                    const newSchedule = {};
                    const newLeaves = [];
                    const newVacations = [];
                    
                    for (let i = 1; i <= daysInNextMonth; i++) {
                        // Check for LM/FO/Vacations first
                        const nextMonthDateKey = `${nextYear}-${String(nextMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        
                        // Copy day-by-day siglas
                        const currentDay = i > daysInCurrentMonth ? daysInCurrentMonth : i;
                        const currentMonthDateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(currentDay).padStart(2, '0')}`;
                        if (emp.schedule[currentMonthDateKey]) {
                             newSchedule[nextMonthDateKey] = emp.schedule[currentMonthDateKey];
                        }
                    }
                    
                    // Copy LM/FO/Vacations to the next month with updated dates
                    if (emp.vacations) {
                        emp.vacations.forEach(vac => {
                            const newStart = new Date(vac.start);
                            const newEnd = new Date(vac.end);
                            newStart.setMonth(newStart.getMonth() + 1);
                            newEnd.setMonth(newEnd.getMonth() + 1);
                            newVacations.push({ start: newStart.toISOString().split('T')[0], end: newEnd.toISOString().split('T')[0] });
                        });
                    }
                    if (emp.leaves) {
                         emp.leaves.forEach(leave => {
                            const newStart = new Date(leave.start);
                            const newEnd = new Date(leave.end);
                            newStart.setMonth(newStart.getMonth() + 1);
                            newEnd.setMonth(newEnd.getMonth() + 1);
                            newLeaves.push({ start: newStart.toISOString().split('T')[0], end: newEnd.toISOString().split('T')[0], type: leave.type });
                        });
                    }

                    emp.schedule = newSchedule;
                    emp.leaves = newLeaves;
                    emp.vacations = newVacations;
                });

                // Copy observations
                const currentObs = monthlyObservations[currentMonthKey] || '';
                monthlyObservations[nextMonthKey] = currentObs;

                saveAllData();
                window.showMessageBox('Escala transcrita com sucesso para o próximo mês!');
                // Move to next month view to show the transcribed schedule
                currentMonth = nextMonth;
                currentYear = nextYear;
                renderSchedule();
                loadMonthlyObservations();
            }
        }
        
        // --- Print Functionality ---
        function printSchedule() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="pt-BR">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Imprimir Escala - ${document.getElementById('currentMonthYear').textContent}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 20px; }
                        .printable-header { text-align: center; margin-bottom: 20px; font-size: 16px; }
                        .printable-table-container { overflow: hidden; }
                        .printable-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                        .printable-table th, .printable-table td {
                            border: 1px solid #000;
                            padding: 4px;
                            text-align: center;
                            font-size: 8px; /* Small font for print */
                            white-space: normal;
                            word-break: break-word;
                        }
                        .printable-table th { background-color: #e0e0e0; }
                        .printable-table .weekend, .printable-table .holiday { background-color: #ccc; }
                        .printable-table .vacation { background-color: #a7d9ff; font-weight: bold; }
                        .printable-table .licenca { background-color: #fde68a; font-weight: bold; }
                        .printable-table .folga { background-color: #9ca3af; color: #fff; font-weight: bold; }
                        .printable-legend {
                            font-size: 10px;
                            margin-top: 20px;
                            border-top: 1px solid #000;
                            padding-top: 10px;
                            page-break-before: avoid;
                        }
                        .printable-legend ul {
                            display: flex;
                            flex-wrap: wrap;
                            list-style: none;
                            padding: 0;
                            margin: 0;
                        }
                        .printable-legend ul li {
                            margin-right: 15px;
                            margin-bottom: 5px;
                            white-space: nowrap;
                        }
                        .printable-legend p {
                            margin-top: 10px;
                            word-wrap: break-word;
                        }
                        .team-sol-print { background-color: #FFD700; color: #333; }
                        .team-verde-print { background-color: #32CD32; color: white; }
                        .team-vermelha-print { background-color: #FF4500; color: white; }
                        .team-azul-print { background-color: #1E90FF; color: white; }
                        .team-laranja-print { background-color: #FFA500; color: #333; }
                        .team-apoio-print { background-color: #D3D3D3; color: #333; }
                        @page {
                            size: landscape;
                            margin: 1cm;
                        }
                    </style>
                </head>
                <body>
                    <div class="printable-content">
                        <div class="printable-header">
                            <h2>Escala do Centro de Saúde - ${document.getElementById('currentMonthYear').textContent}</h2>
                        </div>
                        <div class="printable-table-container">
                            <table class="printable-table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Função</th>
                                        <th>Conselho</th>
                                        <th>Horário de Trabalho</th>
                                        ${Array.from({ length: getDaysInMonth(currentYear, currentMonth) }, (_, i) => {
                                            const day = i + 1;
                                            const isDayWeekend = isWeekend(currentYear, currentMonth, day);
                                            const isDayHoliday = isHoliday(currentYear, currentMonth, day);
                                            let classes = '';
                                            if (isDayWeekend || isDayHoliday) classes = 'weekend';
                                            return `<th class="${classes}">${day}</th>`;
                                        }).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortEmployees(employees).map(emp => {
                                        let rowHtml = `<tr>
                                            <td class="font-medium ${getTeamColorClass(emp.team)}-print">${emp.name}</td>
                                            <td>${emp.role}</td>
                                            <td>${emp.council}</td>
                                            <td>${emp.workShift || ''}</td>`;
                                        for (let i = 1; i <= getDaysInMonth(currentYear, currentMonth); i++) {
                                            const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                                            const isDayWeekend = isWeekend(currentYear, currentMonth, i);
                                            const isDayHoliday = isHoliday(currentYear, currentMonth, i);
                                            let cellContent = '';
                                            let cellClasses = '';

                                            if (isVacation(emp, currentYear, currentMonth, i)) {
                                                cellContent = 'FÉRIAS';
                                                cellClasses = 'vacation';
                                                const prevDayIsVacation = isVacation(emp, currentYear, currentMonth, i - 1);
                                                if (!prevDayIsVacation) {
                                                    let span = 1;
                                                    let j = i + 1;
                                                    while (j <= getDaysInMonth(currentYear, currentMonth) && isVacation(emp, currentYear, currentMonth, j)) {
                                                        span++;
                                                        j++;
                                                    }
                                                    rowHtml += `<td colspan="${span}" class="${cellClasses}">${cellContent}</td>`;
                                                    i += (span - 1);
                                                }
                                            } else if (isLeave(emp, currentYear, currentMonth, i, 'LM')) {
                                                cellContent = 'LM';
                                                cellClasses = 'licenca';
                                                rowHtml += `<td class="${cellClasses}">${cellContent}</td>`;
                                            } else if (isLeave(emp, currentYear, currentMonth, i, 'FO')) {
                                                cellContent = 'FO';
                                                cellClasses = 'folga';
                                                rowHtml += `<td class="${cellClasses}">${cellContent}</td>`;
                                            } else {
                                                const siglas = emp.schedule && emp.schedule[dateKey] ? emp.schedule[dateKey] : [];
                                                cellContent = Array.isArray(siglas) ? siglas.join(', ') : siglas;
                                                if (isDayWeekend || isDayHoliday) {
                                                    cellClasses = 'weekend';
                                                }
                                                rowHtml += `<td class="${cellClasses}">${cellContent}</td>`;
                                            }
                                        }
                                        rowHtml += `</tr>`;
                                        return rowHtml;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="printable-legend">
                            <h3>Legenda:</h3>
                            <ul>
                                ${customSiglas.map(s => `<li><strong>${s.abbr}:</strong> ${s.name}</li>`).join('')}
                                <li><strong>LM:</strong> Licença Médica</li>
                                <li><strong>FO:</strong> Folga</li>
                            </ul>
                            <p><strong>Observações:</strong> ${monthlyObservations[`${currentYear}-${currentMonth + 1}`] || 'Nenhuma observação para este mês.'}</p>
                        </div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            if (firebaseConfig) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
                        } else {
                            try {
                                const anonUser = await signInAnonymously(auth);
                                userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
                            } catch (error) {
                                console.error("Erro ao autenticar no Firebase:", error);
                                window.showMessageBox(`Erro de autenticação: ${error.message}`, 5000);
                                userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
                            }
                        }
                        isAuthReady = true;
                        await loadSiglas();
                        await loadEmployees();
                        await loadMonthlyObservations();
                    });
                } catch (error) {
                    console.error("Erro ao inicializar Firebase:", error);
                    window.showMessageBox(`Erro ao inicializar o banco de dados: ${error.message}. Usando armazenamento local.`, 7000);
                    userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
                    isAuthReady = true;
                    await loadSiglas();
                    await loadEmployees();
                    await loadMonthlyObservations();
                }
            } else {
                userId = "A8ZDJrhRgMTbYSaLG7nL0fKnJK83";
                isAuthReady = true;
                await loadSiglas();
                await loadEmployees();
                await loadMonthlyObservations();
            }

            document.getElementById('employeeRole').addEventListener('change', function() {
                const customRoleField = document.getElementById('customEmployeeRole');
                if (this.value === 'Outro') {
                    customRoleField.classList.remove('hidden');
                } else {
                    customRoleField.classList.add('hidden');
                    customRoleField.value = '';
                }
            });

            document.getElementById('addEmployeeBtn').addEventListener('click', addEmployee);
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderSchedule();
                loadMonthlyObservations();
            });
            document.getElementById('nextMonth').addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderSchedule();
                loadMonthlyObservations();
            });

            document.getElementById('applySiglaMonthBtn').addEventListener('click', applySiglaMonth);
            document.getElementById('clearSiglasMonthBtn').addEventListener('click', clearSiglasForMonth);
            document.getElementById('applyVacationBtn').addEventListener('click', () => applyLeaveOrVacation('vacation'));
            document.getElementById('applyFolgaBtn').addEventListener('click', () => applyLeaveOrVacation('folga'));
            document.getElementById('applyLicencaBtn').addEventListener('click', () => applyLeaveOrVacation('licenca'));
            document.getElementById('clearVacationBtn').addEventListener('click', clearVacation);
            document.getElementById('clearLeaveBtn').addEventListener('click', clearLeave);
            document.getElementById('clearEmployeeScheduleBtn').addEventListener('click', clearEmployeeSchedule);
            document.getElementById('printScheduleBtn').addEventListener('click', printSchedule);
            document.getElementById('transcribeScheduleBtn').addEventListener('click', copyScheduleToNextMonth);
            document.getElementById('saveScheduleBtn').addEventListener('click', saveAllData);
            document.getElementById('manageSiglasBtn').addEventListener('click', openManageSiglasModal);
            document.getElementById('monthlyObservations').addEventListener('input', saveMonthlyObservations);
            
            document.getElementById('addSiglaBtn').addEventListener('click', addSigla);

            renderCurrentMonthYear();
        });
    </script>
</body>
</html>